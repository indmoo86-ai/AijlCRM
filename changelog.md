# 艾居来 CRM 项目变更日志

本文档记录项目开发过程中的所有重要变更，包括需求变更、架构调整、API变更等。

---

## 2025-12-27

### 📋 文档管理改进

#### 新增文档
- ✅ 创建 `docs/DOCUMENT_INDEX.md` - 完整文档目录索引
- ✅ 创建 `docs/DOCUMENT_ANALYSIS.md` - 文档重复性分析报告
- ✅ 创建 `changelog.md` - 项目变更日志（本文档）

#### 文档整理
- ✅ 重命名11个历史版本文档，添加 `old-` 前缀便于识别
- ✅ 更新 `CLAUDE.md` 文档管理规范，添加文档索引链接

### 🔧 代码质量规范更新

#### 新增规范（基于测试教训）
1. **Sequelize模型时间戳字段规范**
   - 问题：SQLite和MySQL对默认值处理不同
   - 解决方案：所有模型必须显式定义 created_at/updated_at 字段
   - 影响范围：20+ 个模型文件
   - 相关文档：`CLAUDE.md` 代码质量规范第1条

2. **API响应格式标准化**
   - 问题：不同控制器返回格式不一致
   - 解决方案：create方法必须返回特定ID字段（如leadId, customerId）
   - 影响范围：所有控制器的create方法
   - 相关文档：`CLAUDE.md` 代码质量规范第2条

3. **参数命名兼容性**
   - 问题：前端驼峰命名与后端下划线命名不兼容
   - 解决方案：控制器必须同时支持两种命名方式
   - 影响范围：所有接受外部参数的控制器方法
   - 相关文档：`CLAUDE.md` 代码质量规范第3条

4. **自动数据补全**
   - 问题：创建关联记录时要求提供所有冗余字段
   - 解决方案：自动从关联表获取缺失数据
   - 影响范围：quotation, contract, shipment 等包含items的模块
   - 相关文档：`CLAUDE.md` 代码质量规范第4条

5. **文档同步规范** ⭐
   - 要求：测试和优化中如修改需求或设计，必须同步更新文档
   - 流程：测试发现问题 → 修改代码 → 更新文档 → 记录changelog
   - 相关文档：`CLAUDE.md` 第四阶段第6条、开发原则第5条、代码质量规范第8条

### ✅ 测试完成情况

#### 完整业务流程测试
- 测试范围：12步端到端测试（线索→客户→报价→合同→发货→收款→发票→售后）
- 测试结果：100% 通过
- 数据库验证：13张表全部验证通过
- 相关文档：`COMPLETE_WORKFLOW_TEST_REPORT.md`, `LESSONS_LEARNED.md`

#### 已修复的系统性问题
- ✅ ProductCategory 和 Product 模型时间戳字段
- ✅ 8个控制器的响应格式标准化
- ✅ 所有业务控制器的参数命名兼容性
- ✅ quotation/contract/shipment 控制器的自动数据补全

### ⏳ 待执行任务

#### 系统性修复（进行中）
- 🔄 修复所有未测试模型的时间戳字段（约20+个模型）
- 🔄 修复所有未测试控制器的响应格式和参数兼容性

#### 测试计划
- 📋 执行79个测试场景清单中的剩余49个场景
- 🎯 性能测试和安全测试（待核心功能测试完成后）

---

## 变更日志使用说明

### 何时记录变更

1. **需求变更**：任何功能需求的增加、修改或删除
2. **架构调整**：技术栈、系统架构、设计模式的变更
3. **API变更**：新增、修改或废弃API端点
4. **数据库变更**：表结构、字段、索引的调整
5. **代码规范变更**：新增或修改开发规范
6. **重要Bug修复**：影响范围大的问题修复
7. **性能优化**：显著的性能改进
8. **文档更新**：重要文档的新增或重大修改

### 记录格式

```markdown
## YYYY-MM-DD

### 类别标题

#### 变更名称
- 问题/需求：描述为什么要做这个变更
- 解决方案：描述具体的变更内容
- 影响范围：说明影响的模块、文件或功能
- 相关文档：列出需要同步更新的文档
- 相关人员：如有必要，标注负责人或参与者
```

### 类别标签

- 📋 文档相关
- 🔧 代码/配置修改
- ✅ 测试相关
- 🐛 Bug修复
- ⚡ 性能优化
- 🎨 UI/UX改进
- 🔒 安全相关
- 📦 依赖更新
- 🚀 新功能
- 💥 破坏性变更
- ⏳ 进行中的工作

---

**维护责任**：所有开发人员
**更新频率**：每次重要变更后立即更新
**最后更新**：2025-12-27
