# 艾居来 CRM - 软件需求规格说明书（SRS）

## 0. 文档信息

| 项目名称 | 艾居来 CRM |
|---------|-----------|
| 文档版本 | v9.1 |
| 创建日期 | 2025-12-22 |
| 最后更新 | 2025-12-23 |
| 文档状态 | 全部9个核心模块需求分析完成 - 待评审 |
| 作者 | Requirements Analysis Officer |

### 变更记录

| 版本 | 日期 | 变更内容 | 影响范围 |
|------|------|---------|---------|
| v9.1 | 2025-12-23 | **数据模型优化 - 强化"两条主线"设计**：1）在payment表（收款记录表）新增customer_id字段（§7.8.1），并添加外键约束和索引；2）在invoice表（发票记录表）新增customer_id字段（§7.9.1），并添加外键约束和索引；3）在§7数据模型开头新增"两条主线设计理念"专项说明，明确线索主线（customer表）和合同主线（contract表）的核心地位；4）更新payment表和invoice表的业务规则，说明customer_id字段在记录创建时自动从contract继承；5）设计目标：确保所有业务模块（报价单、合同、发货、收款、发票、售后工单）都同时关联线索主线（customer_id）和合同主线（contract_id），实现完整业务追溯 | §7开头, §7.8.1, §7.9.1 |
| v9.0 | 2025-12-23 | **完成售后服务模块需求分析**：1）新增售后服务模块职责说明（§4.11）；2）新增服务工单表service_ticket和服务工单操作记录表service_ticket_log数据模型（§7.10）；3）新增9个售后服务User Stories（SVC-001至SVC-009），涵盖服务工单创建、工单状态流转、操作日志记录、配件更换与费用管理、客户满意度评价、工单分配与转派、工单响应与处理超时提醒、工单查询与统计分析、售后回访记录集成等核心功能；4）确认工单采用独立工单表设计、质保期自动判断方案（从合同读取）、工单状态机流转规则（pending→in_progress→pending_acceptance→resolved→closed）、响应超时与处理超时分级提醒机制（urgent/high/medium/low）、客户满意度评价机制、售后回访复用customer_follow_up表（follow_up_type='after_sales'）方案；5）**全部9个核心模块需求分析完成（基础数据、销售线索、报价单、合同、待办任务、发货、收款、发票、售后服务）** | §4.11, §7.10, §8.11 |
| v8.0 | 2025-12-23 | **完成发票管理模块需求分析**：1）新增发票管理模块职责说明（§4.10）；2）新增发票记录表invoice数据模型（§7.9），采用单表设计方案；3）新增8个发票管理User Stories（INV-001至INV-008），涵盖发票记录创建、发票类型与信息管理、发票与收款关联、发票状态管理、发票开具确认与自动更新、发票作废与回退、发票记录查询导出、发票统计分析等核心功能；4）确认发票采用单表设计、可选关联收款记录（payment_id可为NULL）、发票自动核销更新contract.invoiced_amount方案、支持增值税专用发票和普通发票、发票抬头信息从客户表读取方案 | §4.10, §7.9, §8.10 |
| v7.0 | 2025-12-23 | **完成收款管理模块需求分析**：1）新增收款管理模块职责说明（§4.9）；2）新增收款记录表payment数据模型（§7.8），采用单表设计方案；3）新增8个收款管理User Stories（PAY-001至PAY-008），涵盖收款记录创建、收款方式管理、分期收款跟踪、部分收款支持、收款核销与自动更新、应收账款统计、收款逾期提醒、收款记录查询导出等核心功能；4）确认收款采用单表设计（payment_stage关联payment_terms）、收款自动核销更新contract.received_amount方案、收款逾期待办任务自动生成方案、支持部分收款累加机制 | §4.9, §7.8, §8.9 |
| v6.0 | 2025-12-23 | **完成发货管理模块需求分析**：1）新增发货管理模块职责说明（§4.8）；2）新增发货单主表shipment、发货单明细表shipment_item数据模型（§7.7）；3）新增8个发货管理User Stories（SHIP-001至SHIP-008），涵盖发货单创建、发货数量校验、发货确认、全部发货完成自动更新、发货取消与回退、物流信息更新、签收确认、发货逾期提醒等核心功能；4）确认发货采用独立发货单模式（支持部分发货/分批发货）、发货数量冗余统计方案（contract_item.shipped_quantity）、物流信息可修改方案、发货逾期待办任务自动生成方案 | §4.8, §7.7, §8.8 |
| v5.0 | 2025-12-23 | **完成待办任务与提醒系统需求分析**：1）新增待办任务与提醒系统模块职责说明（§4.7）；2）新增任务表task、任务模板表task_template、任务提醒记录表task_notification数据模型（§7.6）；3）新增8个待办任务管理User Stories（TASK-001至TASK-008），涵盖任务自动生成、任务分配、任务处理、任务提醒、任务统计、逾期预警等核心功能；4）确认任务采用多态关联设计（source_type + source_id）、unique_key防重机制、定时任务扫描生成、任务状态自动流转方案 | §4.7, §7.6, §8.7 |
| v4.0 | 2025-12-23 | **完成合同管理模块需求分析**：1）新增合同管理模块职责说明（§4.6）；2）新增合同主表contract、合同明细表contract_item、合同补充协议表contract_amendment数据模型（§7.5）；3）新增10个合同管理User Stories（CONTRACT-001至CONTRACT-010），涵盖合同创建、条款管理、签订流程、变更管理、执行跟踪、提醒管理、文件管理等核心功能；4）确认合同采用独立明细表（从报价单复制）、付款条款JSON化存储、补充协议方式管理变更、执行进度冗余统计方案 | §4.6, §7.5, §8.6 |
| v3.0 | 2025-12-23 | **完成报价单管理模块需求分析**：1）新增报价单管理模块职责说明（§4.5）；2）新增报价单主表quotation和明细表quotation_item数据模型（§7.4）；3）新增7个报价单管理User Stories（QUOTE-001至QUOTE-007），涵盖报价单创建、产品选配、版本管理、有效期管理、PDF生成、转合同等核心功能；4）确认报价单采用独立报价单模式（每次调整创建新报价单）、价格追溯方案（记录标准价和实际价）、默认有效期30天可修改方案 | §4.5, §7.4, §8.5 |
| v2.0 | 2025-12-23 | **完成销售线索管理模块需求分析**：1）新增销售线索管理模块职责说明（§4.4）；2）新增客户跟进记录表customer_follow_up（§7.2.4），支持销售跟进和售后回访两种类型；3）新增8个线索管理User Stories（LEAD-001至LEAD-008），涵盖线索录入、分配、跟进、阶段推进、线索池管理、放弃回收、批量导入、导出统计；4）确认线索数据模型采用customer表共用方案（通过customer_stage字段区分），不创建独立lead表 | §4.4, §7.2.4, §8.4 |
| v1.1 | 2025-12-22 | **需求调整**：1）产品表新增brand字段，product_image改为product_images（JSON数组），审计字段调整（created_by/updated_by）；2）客户类型新增homestay/apartment；3）移除客户跟进记录表，相关功能移至"客户回访模块"；4）客户管理User Stories从8个调整为7个（CRM-004删除，后续重新编号） | §4.2, §7.1, §7.2, §8.1, §8.2 |
| v1.0 | 2025-12-22 | **完成基础数据模块需求分析**：用户角色权限管理模块职责、数据模型（6张表）、功能需求（8个User Stories）。基础数据模块三个子模块全部完成。 | §4.3, §7.3, §8.3 |
| v0.5 | 2025-12-22 | 完成客户管理模块需求分析：模块职责、数据模型（4张表）、功能需求（8个User Stories） | §4.2, §7.2, §8.2 |
| v0.4 | 2025-12-22 | 完成产品管理模块需求分析：模块职责、数据模型、功能需求（6个User Stories） | §4.1, §7.1, §8.1 |
| v0.3 | 2025-12-22 | 明确用户角色定义与RACI矩阵，确立权限设计原则 | §2.2-2.3 |
| v0.2 | 2025-12-22 | 明确业务目标、业务成果与KPI指标 | §1.2-1.5 |
| v0.1 | 2025-12-22 | 创建文档框架，启动基础数据模块需求调研 | 全文档 |

### 文档范围
本文档包含以下模块的需求规格说明：

**基础数据模块**（v1.0完成）：
- 产品管理
- 客户管理
- 用户角色权限管理

**销售线索管理模块**（v2.0完成）：
- 线索录入与分配
- 线索跟进管理
- 线索池管理
- 线索转化与归档

**报价单管理模块**（v3.0完成）：
- 报价单创建与编辑
- 产品选配与价格管理
- 报价单版本管理
- 有效期与延期管理
- 报价单PDF生成
- 报价单转合同

**合同管理模块**（v4.0完成）：
- 合同创建与编辑
- 合同条款管理（付款、交付、质保、违约）
- 合同签订流程
- 合同变更与补充协议
- 合同执行跟踪（发货、收款、开票进度）
- 合同提醒与预警
- 合同文件管理

**待办任务与提醒系统**（v5.0完成）：
- 任务自动生成（基于业务规则）
- 任务分配与接收
- 任务处理与完成
- 任务提醒与通知
- 任务统计与分析
- 逾期预警与管理
- 任务模板管理

**发货管理模块**（v6.0完成）：
- 发货单创建与编辑
- 发货产品明细管理
- 物流信息管理
- 发货状态跟踪
- 分批发货支持
- 发货进度同步
- 发货逾期提醒

**收款管理模块**（v7.0完成）：
- 收款记录创建与编辑
- 收款方式与银行信息管理
- 分期收款跟踪与管理
- 部分收款支持（累加机制）
- 收款核销与自动更新合同进度
- 应收账款统计与分析
- 收款逾期提醒与预警
- 收款记录查询与导出

**发票管理模块**（v8.0完成）：
- 发票记录创建与编辑
- 发票类型与信息管理（增值税专用发票/普通发票）
- 发票与收款关联管理
- 发票状态管理（待开票/已开具/已作废）
- 发票开具确认与自动更新合同进度
- 发票作废与进度回退
- 发票记录查询与导出
- 发票统计与分析

**售后服务模块**（v9.0完成）：
- 服务工单创建与编辑
- 工单类型与优先级管理（故障维修/产品更换/技术支持/定期巡检，紧急/高/中/低优先级）
- 工单状态管理（待处理→处理中→待验收→已解决→已关闭）
- 质保期自动判断（从合同读取质保期信息）
- 服务记录与操作日志（服务时间、服务人员、处理结果、配件更换、费用记录）
- 工单分配与转派
- 客户满意度评价
- 工单提醒与逾期预警（响应超时提醒、处理超时提醒，集成待办任务系统）
- 工单查询与统计分析
- 售后回访记录集成（复用客户跟进记录表）

---

## 1. 项目目的与成功标准

### 1.1 项目概述
- **项目名称**：艾居来 CRM
- **行业领域**：酒店智能硬件营销
- **部署方式**：阿里云部署
- **用户规模**：10人以内

### 1.2 业务目标

艾居来 CRM 系统的核心业务目标是**实现酒店智能硬件销售全流程的标准化管理与自动化跟踪**，具体包括：

1. **标准化流程，避免疏漏**
   - 建立标准化的业务流程节点和检查点
   - 确保每个销售机会、合同、服务项都按规范流程执行
   - 消除因人为遗忘或交接不清导致的业务遗漏

2. **系统待办事项随时提醒**
   - 自动生成基于流程节点的待办任务
   - 实时提醒团队成员需要处理的事项
   - 支持任务优先级管理和逾期预警

3. **全流程数据串通**
   - 打通销售线索 → 跟踪 → 合同 → 服务 → 财务 → 发票的完整业务链
   - 实现单一客户全生命周期数据可追溯
   - 各业务环节数据自动传递，减少重复录入

### 1.3 关键绩效指标（KPIs）

| 指标类别 | 具体指标 | 目标值 | 测量方式 | 数据来源 |
|---------|---------|--------|---------|---------|
| **流程完整性** | 销售线索跟进完成率 | ≥95% | 系统记录的跟进任务完成数 / 总任务数 × 100% | 任务管理模块 |
| **流程完整性** | 合同关键节点及时率 | ≥90% | 在截止日前完成的节点数 / 总节点数 × 100% | 合同管理模块 |
| **任务提醒有效性** | 待办事项平均响应时间 | ≤4小时 | 从待办生成到标记处理的平均时长 | 待办系统日志 |
| **任务提醒有效性** | 逾期任务占比 | ≤5% | 逾期未处理任务数 / 总任务数 × 100% | 待办系统统计 |
| **流程串通** | 从线索到回款的平均周期 | 缩短20%（对比当前手工流程） | 系统自动计算业务起止时间跨度 | 全流程数据分析 |
| **流程串通** | 数据断链率 | ≤2% | 缺少关键环节数据的业务记录数 / 总业务记录数 × 100% | 数据质量检查 |
| **运营效率** | 重复数据录入减少率 | ≥60% | 对比手工流程的数据录入次数 | 用户操作日志对比 |
| **数据质量** | 客户信息完整度 | ≥90% | 必填字段填写完整的客户记录数 / 总客户数 × 100% | 客户管理模块 |

### 1.4 范围边界

**本期范围（In-Scope）**：
- **基础数据模块**（本文档重点）
  - 产品管理模块
  - 客户管理模块
  - 用户角色权限管理模块
- **全流程业务支撑**（关联模块，在后续文档详述）
  - 销售线索管理
  - 销售跟进与商机管理
  - 合同管理
  - 服务交付管理
  - 财务管理
  - 发票管理
- **任务与提醒系统**
  - 待办事项自动生成
  - 任务分配与提醒
  - 逾期预警

**非目标（Out-of-Scope）**：
- 营销自动化（如邮件营销、短信群发）
- 第三方电商平台集成
- 复杂的BI/大数据分析（仅提供基础报表）
- 移动端独立APP（本期仅考虑响应式Web）
- 呼叫中心集成

**范围说明**：
本文档聚焦于**基础数据模块**的详细需求，其他业务模块（销售、合同、财务等）将在后续独立文档中详细描述，但本文档会涉及相关数据模型的关联关系。

### 1.5 成功标准

**系统验收成功标准**：

1. **功能完整性**（上线时）
   - 基础数据模块三个子模块100%功能实现
   - 产品、客户、用户权限的CRUD操作无缺陷
   - 全流程数据关联正确（线索→发票可追溯）

2. **流程标准化**（上线后1个月）
   - 销售线索跟进完成率达到90%以上
   - 合同关键节点及时率达到85%以上
   - 待办任务逾期率低于10%

3. **用户体验**（上线后1个月）
   - 团队成员每日登录率≥90%
   - 任何一笔业务可在5次点击内查看完整流程
   - 用户满意度评分≥4.0/5.0

4. **业务效率提升**（上线后3个月）
   - 从线索到签约的平均周期较之前缩短15%
   - 重复数据录入工作量减少50%以上
   - 客户信息完整度达到90%

5. **系统稳定性**（持续）
   - 系统可用性≥99.5%
   - 响应时间：列表查询≤2秒，详情查询≤1秒
   - 数据备份每日自动执行，可恢复性100%

---

## 2. 术语表与角色定义

### 2.1 术语表

| 术语 | 定义 | 备注 |
|------|------|------|
| CRM | Customer Relationship Management（客户关系管理系统） | |
| 智能硬件 | 酒店场景下的智能设备 | 待明确具体产品类型 |
| 基础数据 | 系统运行所需的核心主数据 | 包括产品、客户、用户权限 |
| 销售线索 | 潜在的销售机会，尚未确认为有效客户 | 也称为Leads |
| 商机 | 已确认有采购意向的销售机会 | 也称为Opportunity |
| 全流程串通 | 从销售线索到发票的完整业务链数据关联与自动传递 | 核心业务目标之一 |
| 待办事项 | 系统根据业务流程节点自动生成或人工创建的任务 | 支持提醒和逾期预警 |
| 数据断链 | 业务流程中缺少关键环节数据导致无法完整追溯 | 影响流程串通目标 |

### 2.2 用户角色定义

基于团队实际岗位分工，系统定义以下5个角色：

| 角色名称 | 对应岗位 | 职责描述 | 典型操作 | 数据权限范围 |
|---------|---------|---------|---------|-------------|
| **系统管理员** | （由管理层兼任） | 系统配置、用户管理、基础数据维护、权限分配 | 用户CRUD、角色分配、产品管理、系统参数配置 | 全部数据读写 |
| **营销人员** | 新媒体营销 | 销售线索收集、录入、初步筛选 | 线索录入/编辑/删除、线索分配给销售、客户信息查看 | 全部数据可见（现阶段）<br>预留字段支持未来数据隔离 |
| **销售人员** | 销售 | 线索跟进、客户管理、商机推进、合同签订 | 线索跟进记录、客户CRUD、商机管理、合同录入/编辑、报价单生成 | 全部数据可见（现阶段）<br>预留owner_id支持"只看自己客户"模式 |
| **财务人员** | 财务 | 发票开具、收款记录、财务报表 | 发票CRUD、收款记录、合同财务信息查看/编辑、财务报表导出 | 全部数据可见（现阶段）<br>无删除合同权限 |
| **运营人员** | 产品运营 | 产品发货、安装交付、售后服务 | 发货单管理、安装记录、售后工单CRUD、产品库存查看 | 全部数据可见（现阶段）<br>无删除合同权限 |

**权限设计原则**：
1. **现阶段（v1.0）**：所有角色可查看全部数据，仅操作权限有区分，降低使用门槛
2. **预留扩展性**：关键业务实体预留权限控制字段（creator_id、owner_id、department_id、data_permission_level）
3. **未来演进**：当团队扩大或需要数据隔离时，无需改动数据库结构，仅调整权限配置即可启用

**角色与业务流程对应关系**：
```
销售线索录入（营销人员）
    ↓
线索跟进/转化为客户（销售人员）
    ↓
签订合同（销售人员）
    ↓
合同执行 ← 发货/售后（运营人员）+ 开票/收款（财务人员）
```

### 2.3 RACI 矩阵

针对基础数据模块的关键活动，责任分配如下：

| 活动 | 系统管理员 | 营销人员 | 销售人员 | 财务人员 | 运营人员 |
|------|----------|---------|---------|---------|---------|
| 产品信息维护 | R/A | I | I | I | C |
| 产品库存管理 | A | - | I | I | R |
| 客户信息录入 | A | C | R | I | I |
| 客户信息更新 | A | C | R | C | C |
| 用户账号管理 | R/A | - | - | - | - |
| 角色权限配置 | R/A | - | - | - | - |
| 数据导入导出 | R/A | C | C | C | C |

**RACI 说明**：
- **R (Responsible)**: 负责执行
- **A (Accountable)**: 最终问责
- **C (Consulted)**: 需要咨询
- **I (Informed)**: 需要知情

---

## 3. 业务上下文与主流程

### 3.1 系统上下文
> 待绘制系统边界图（C4 Context Level）

### 3.2 核心业务流程
> 待确认主流程泳道图

---

## 4. 模块清单与职责

### 4.1 产品管理模块

**模块职责**：
管理酒店智能硬件产品的基础信息（SKU级），为报价、合同、发货、售后等业务环节提供产品数据支撑。

**核心功能**：
1. 产品分类管理（5-6个大类：自助入住机、酒店插座、开关、窗帘机、音响等）
2. 产品SKU管理（200-300个SKU）
3. 产品信息维护（名称、图片、供应商、成本价、报价、备注等）
4. 产品状态管理（在售/停售/草稿）
5. 产品搜索与筛选
6. 产品数据导入/导出

**输入**：
- 系统管理员/运营人员：产品基础信息录入
- 销售人员：产品查询请求
- 其他模块：报价单、合同需要关联产品信息

**输出**：
- 产品列表数据（供报价单选择产品）
- 产品详细信息（供合同、发货单引用）
- 产品数据（供财务、运营查询成本和价格）

**边界**：
- **包含**：产品基础信息管理、产品分类管理
- **不包含**：库存管理（用户明确不需要）、批次管理、序列号管理、多价格体系
- **关联模块**：报价单模块（读取产品）、合同模块（读取产品）、发货模块（读取产品信息）

**失败策略**：
- 产品被合同/报价单引用时，不允许删除，仅可标记为停售
- 产品信息修改时，不影响历史合同和报价单（历史数据快照保存）
- 产品分类删除前，需检查是否有产品关联，有则不允许删除

---

### 4.2 客户管理模块

**模块职责**：
管理酒店智能硬件营销的目标客户基础信息（从销售线索到成交客户），支持客户分类分级、联系人管理，为销售流程提供核心数据支撑。

**核心功能**：
1. 客户信息管理（客户基本信息、行业特性、分类分级）
2. 客户生命周期阶段管理（线索 → 初步接触 → 意向 → 洽谈 → 成交 → 流失）
3. 联系人管理（一个客户多个联系人，主要联系人标识）
4. 客户来源渠道管理
5. 客户搜索与筛选（按阶段、类型、等级、地区、负责人筛选）
6. 客户数据导入/导出

**说明**：客户跟进记录功能将在"客户回访模块"中实现，该模块在后续迭代开发。

**输入**：
- 营销人员：销售线索录入（客户处于"线索"阶段）
- 销售人员：客户信息完善、阶段推进
- 财务/运营：客户信息查询

**输出**：
- 客户列表数据（供销售选择客户创建报价单、合同）
- 客户详细信息（供全流程各环节查看客户背景）
- 客户统计报表（按阶段、来源、负责人分析）

**边界**：
- **包含**：客户基本信息管理、联系人管理、客户阶段管理、来源渠道管理
- **不包含**：客户跟进记录管理（在"客户回访模块"实现）、商机管理（商机作为独立模块，关联客户）、合同管理（合同模块关联客户）
- **关联模块**：报价单模块、合同模块、客户回访模块、销售分析模块

**失败策略**：
- 客户被合同/报价单引用时，不允许删除，仅可标记为"流失"或软删除
- 客户阶段只能向前推进（线索→成交），不能回退（除非手动强制修改）
- 联系人删除前需确认是否为主要联系人，若是则需先指定新的主要联系人

---

### 4.3 用户角色权限管理模块

**模块职责**：
管理系统用户账户、角色权限配置、登录认证、操作审计日志，确保系统安全性和可追溯性。

**核心功能**：
1. 用户管理（用户CRUD、启用/禁用、密码重置）
2. 角色管理（固定5个角色：系统管理员、营销人员、销售人员、财务人员、运营人员）
3. 用户角色关联（一个用户可拥有多个角色）
4. 模块级权限配置（为每个角色配置可访问的功能模块）
5. 登录认证（手机号+密码登录）
6. 操作审计日志（记录所有用户的关键操作）

**输入**：
- 系统管理员：用户信息录入、角色权限配置
- 所有用户：登录请求、修改个人密码
- 系统自动：操作审计日志自动记录

**输出**：
- 用户列表与详情
- 角色权限配置数据（供前端菜单显示和权限校验）
- 登录令牌（Token）
- 操作审计日志（供查询和审计）

**边界**：
- **包含**：用户账户管理、角色权限管理、登录认证、操作日志
- **不包含**：部门管理（暂不需要）、数据权限隔离（预留字段但暂不实现）、单点登录SSO、第三方登录（微信/企业微信）
- **关联模块**：所有业务模块（权限校验）、待办任务（通知用户）

**失败策略**：
- 系统管理员角色至少保留1个账户为启用状态（防止所有管理员被禁用导致无法管理系统）
- 用户被禁用后，其创建的业务数据（客户、产品等）不受影响，仅该用户无法登录
- 密码输入错误5次后，账户自动锁定30分钟（防止暴力破解）
- 操作日志不允许删除，仅可查询（确保审计完整性）

---

### 4.4 销售线索管理模块

**模块职责**：
管理销售线索从获取到转化的全生命周期，包括线索录入、分配、跟进、转化、线索池管理，为销售流程提供起点支撑，确保潜在商机不流失。

**核心功能**：
1. 线索录入（营销人员/销售人员手工录入或批量导入）
2. 线索分配（营销人员手动指派、销售主动领取、管理员强制分配）
3. 线索跟进管理（记录跟进活动、下次跟进计划、自动生成待办提醒）
4. 线索阶段推进（lead → initial_contact → prospect → negotiation → client）
5. 线索池管理（公共线索池、我的线索、待分配线索、回收线索）
6. 线索转化与归档（转为正式客户、标记无效、流失归档）
7. 线索搜索与筛选（按阶段、来源、负责人、地区、创建时间等）
8. 线索分配智能推荐（推荐销售人员，后期扩展按区域/负荷推荐）

**输入**：
- 营销人员：线索录入、线索分配给销售
- 销售人员：领取线索、跟进记录、阶段推进、放弃线索
- 管理员：强制分配、回收线索
- 系统自动：根据下次跟进时间生成待办任务

**输出**：
- 线索列表数据（供销售人员查询和领取）
- 线索详情（包括基本信息、联系人、跟进历史）
- 线索跟进记录（时间线展示）
- 待办任务（跟进提醒）
- 线索统计报表（按来源、阶段、转化率分析）

**边界**：
- **包含**：线索录入、分配、跟进、阶段管理、线索池管理
- **不包含**：
  - 商机管理（商机作为独立模块，与线索关联但独立管理）
  - 报价单生成（在报价单模块实现）
  - 合同签订（在合同模块实现）
  - 售后回访（在客户回访模块实现，但复用customer_follow_up表）
- **关联模块**：
  - 客户管理模块（线索本质是customer_stage=lead的客户记录）
  - 待办任务模块（跟进提醒）
  - 报价单模块（线索推进到negotiation阶段后可生成报价单）
  - 用户权限模块（分配时读取销售人员列表）

**失败策略**：
- 线索被报价单引用后，不允许删除，仅可标记为流失或软删除
- 线索阶段原则上只能向前推进，不能回退（管理员可强制修改）
- 线索负责人转移时，需记录转移日志（在跟进记录中体现）
- 公共线索池中的线索（owner_id=NULL）不能直接创建跟进记录，必须先领取或分配
- 标记为无效/流失的线索不再出现在公共线索池，仅管理员可查看

---

### 4.5 报价单管理模块

**模块职责**：
管理销售报价单的全生命周期，从报价单创建、产品选配、价格调整、PDF生成到转化为合同，为销售谈判提供标准化报价文档支持，记录完整的价格协商历史。

**核心功能**：
1. 报价单创建与编辑（基于客户/线索创建，支持草稿保存）
2. 产品选配（从产品库选择产品、设置数量、调整价格）
3. 价格管理（标准价自动带入、实际价可调整、折扣自动计算）
4. 报价单版本管理（独立报价单模式，每次调整创建新报价单，状态管理）
5. 有效期管理（默认30天，可修改，支持延期，过期自动标记和提醒）
6. 报价单PDF生成（基于模板生成标准化PDF文档，预留模板可配置扩展点）
7. 报价单状态管理（草稿→已发送→已接受/已拒绝/已过期/已被替代）
8. 报价单转合同（一键转换，数据预填充）
9. 报价单搜索与筛选（按客户、状态、创建时间、负责人筛选）

**输入**：
- 销售人员：创建报价单、选择产品、设置数量和价格、发送报价单、延期、标记接受/拒绝
- 客户管理模块：客户/线索基本信息、联系人信息
- 产品管理模块：产品列表、标准价格
- 系统自动：有效期计算、过期检查、待办提醒

**输出**：
- 报价单列表数据（供销售人员查询和管理）
- 报价单详情（包括客户信息、产品明细、价格汇总、状态）
- 报价单PDF文件（供下载和发送给客户）
- 报价单统计报表（按客户、产品、时间段统计金额和折扣）
- 待办任务（过期前3天提醒）
- 合同创建数据（转合同时预填充）

**边界**：
- **包含**：报价单创建、编辑、产品选配、价格调整、有效期管理、PDF生成、状态管理、转合同
- **不包含**：
  - 报价单审批流程（v1.0阶段不实现，预留扩展点）
  - 报价单模板在线编辑（v1.0使用固定模板，预留配置扩展点）
  - 电子签名（v1.0阶段不实现）
  - 邮件/微信自动发送（v1.0手动下载PDF后发送）
- **关联模块**：
  - 客户管理模块（读取客户信息）
  - 产品管理模块（读取产品信息）
  - 合同管理模块（转合同时创建合同记录）
  - 待办任务模块（过期提醒）
  - 用户权限模块（权限控制）

**失败策略**：
- 报价单被合同引用后（已转合同），不允许删除，仅可查看
- 报价单状态为"已发送"时，不允许修改产品和价格，如需调整需创建新版本
- 报价单草稿超过90天未发送，系统自动标记为"已过期"并归档
- 报价单产品明细不能为空（至少包含1个产品）
- 创建报价单时，推荐客户阶段为prospect或negotiation，其他阶段给出提示但不阻止
- PDF生成失败时，报价单仍可保存，PDF可稍后重新生成

---

### 4.6 合同管理模块

**模块职责**：
管理从报价单到项目交付的合同全生命周期，包括合同创建、条款管理、签订流程、变更管理、执行跟踪，为后续发货、收款、发票业务提供核心依据，确保业务流程标准化和数据可追溯。

**核心功能**：
1. 合同创建与编辑（从报价单转化或手动创建，支持草稿保存）
2. 合同产品明细管理（从报价单复制或手动添加，支持签订前调整）
3. 合同条款管理（付款条款、交付条款、质保条款、违约条款、补充条款）
4. 合同状态管理（草稿→待审核→已批准→已签订→执行中→已完成→已终止）
5. 合同签订流程（电子合同文件上传、签订日期记录、v1.0无审批流程）
6. 合同变更管理（补充协议方式管理合同变更，关联原合同）
7. 合同执行跟踪（发货进度、收款进度、开票进度统计，自动更新执行状态）
8. 合同提醒与预警（交付期临近提醒、逾期预警、收款提醒、质保期到期提醒）
9. 合同文件管理（电子合同文件上传、版本管理、下载）
10. 合同搜索与统计（按客户、状态、时间、负责人筛选，统计合同金额和执行进度）

**输入**：
- 销售人员/合同管理员：创建合同、编辑条款、上传合同文件、签订确认、创建补充协议
- 报价单管理模块：报价单数据（转合同时自动填充）
- 客户管理模块：客户基本信息、联系人信息
- 产品管理模块：产品信息（手动创建合同时）
- 发货管理模块：发货记录和金额（更新已发货金额）
- 收款管理模块：收款记录和金额（更新已收款金额）
- 发票管理模块：发票记录和金额（更新已开票金额）
- 系统自动：执行进度计算、提醒任务生成、状态自动流转

**输出**：
- 合同列表数据（供查询和管理）
- 合同详情（客户信息、产品明细、条款、执行进度）
- 合同执行报表（已发货/已收款/已开票金额统计，执行进度百分比）
- 待办任务（交付期临近、逾期预警、收款提醒、质保期到期）
- 关联业务依据（为发货单、收款单、发票提供合同依据）
- 补充协议记录（变更历史可追溯）

**边界**：
- **包含**：合同创建、编辑、条款管理、签订流程、变更管理、执行跟踪、提醒预警、文件管理
- **不包含**：
  - 合同审批流程（v1.0阶段不实现，状态保留under_review/approved但跳过，v2.0启用）
  - 电子签章/CA认证（v1.0手动线下签订，仅上传扫描件）
  - 合同条款智能审查（v1.0纯文本录入，不做智能分析）
  - 合同模板在线编辑（v1.0固定模板，预留配置扩展点）
  - 自动催款（v1.0仅提醒，不自动发送催款通知）
- **关联模块**：
  - 报价单管理模块（读取报价单数据）
  - 客户管理模块（读取客户信息）
  - 产品管理模块（读取产品信息）
  - 发货管理模块（读取发货记录，更新已发货金额）
  - 收款管理模块（读取收款记录，更新已收款金额）
  - 发票管理模块（读取发票记录，更新已开票金额）
  - 待办任务模块（生成提醒任务）
  - 用户权限模块（权限控制）

**失败策略**：
- 合同被发货单/收款单/发票引用后，不允许删除，仅可标记为终止
- 合同状态为"已签订"后，产品明细不允许直接修改，如需变更需创建补充协议
- 合同金额不允许手动修改，由产品明细自动汇总计算
- 合同执行进度字段（已发货/已收款/已开票金额）由关联模块触发更新，不允许手动修改
- 合同签订日期必须≥合同创建日期，交付期限必须≥签订日期
- 质保期开始日期默认为实际交付日期（最后一次发货日期），可手动调整
- 合同产品明细不能为空（至少包含1个产品）
- 创建合同时，推荐客户阶段为negotiation或contract，其他阶段给出提示但不阻止
- 补充协议必须关联有效的原合同（状态为signed/executing/completed）

---

### 4.7 待办任务与提醒系统

**模块职责**：
自动化生成和管理待办任务，基于业务规则在关键节点自动提醒相关人员处理事项，确保销售线索跟进不遗漏、报价单及时响应、合同履约及时执行，支撑项目目标"系统待办事项随时提醒"。

**核心功能**：
1. 任务自动生成（基于业务规则自动创建待办任务，支持防重机制）
2. 任务手动创建（用户手动创建自定义任务）
3. 任务分配与接收（任务自动分配给负责人，支持转移）
4. 任务处理与完成（任务状态流转：待处理→处理中→已完成/已取消）
5. 任务提醒与通知（系统内提醒，预留邮件/微信提醒扩展）
6. 任务统计与分析（任务完成率、逾期率、平均响应时间）
7. 逾期预警与管理（自动标记逾期任务，逾期任务突出显示）
8. 任务模板管理（预设任务模板，简化手动创建流程，预留v2.0功能）

**输入**：
- 销售线索管理模块：跟进记录中的next_follow_up_time（自动生成跟进任务）
- 报价单管理模块：报价单valid_until字段（自动生成过期提醒任务）
- 合同管理模块：delivery_deadline、payment_terms、warranty_end_date（自动生成合同执行提醒任务）
- 用户手动：手动创建自定义任务
- 定时任务调度器：每日定时扫描业务表，生成待办任务

**输出**：
- 用户待办任务列表（按优先级、截止时间、状态分组）
- 待办任务计数（待处理任务数、逾期任务数）
- 任务完成报表（任务完成率、平均响应时间、逾期率）
- 任务提醒通知（系统内弹窗、桌面通知，预留邮件/微信通知）

**边界**：
- **包含**：
  - 任务自动生成规则管理（硬编码在代码中，v1.0不支持前端配置）
  - 任务状态自动流转（逾期自动标记、业务对象状态变更自动取消关联任务）
  - 系统内提醒通知（页面提醒、计数徽章）
- **不包含**：
  - 复杂工作流引擎（v1.0仅支持预设的业务规则，不支持自定义流程）
  - 任务审批流程（v1.0任务直接分配，无需审批）
  - 邮件/微信提醒（v1.0预留接口，v2.0实现）
  - 任务模板前端配置（v1.0预留数据表，v2.0实现前端管理界面）
  - 任务委托/代办（v1.0仅支持任务转移，不支持临时委托）
- **关联模块**：
  - 销售线索管理模块（读取跟进记录，生成跟进任务）
  - 报价单管理模块（读取报价单，生成过期提醒任务）
  - 合同管理模块（读取合同，生成交付/收款/质保提醒任务）
  - 用户权限模块（任务分配时读取负责人信息）

**失败策略**：
- 任务自动生成时，如果源业务对象（线索/报价单/合同）已删除或不存在，跳过生成
- 任务的source_id关联记录被软删除后，任务自动标记为cancelled
- 任务负责人（assignee_id）被禁用或删除时，任务转移给该用户的上级或管理员
- 任务防重机制：同一业务对象+任务类型+关键日期的组合，生成唯一unique_key，重复时跳过生成
- 定时任务执行失败时，记录日志并发送管理员通知，下次调度时重试
- 任务已完成（completed）或已取消（cancelled）后，不允许再次修改状态
- 任务截止时间不能早于当前时间（手动创建时校验）

---

### 4.8 发货管理模块

**模块职责**：
管理合同产品的发货执行全流程，包括发货单创建、物流信息管理、发货状态跟踪、分批发货控制，为合同履约提供交付管理支持，实时同步更新合同执行进度，确保发货过程可追溯、数据可核对。

**核心功能**：
1. 发货单创建与编辑（基于已签订合同创建，支持部分发货和分批发货）
2. 发货产品明细管理（选择合同产品、设置发货数量、数量超量校验）
3. 物流信息管理（物流公司、运单号、发货地址、发货日期、预计到货日期）
4. 发货状态跟踪（草稿→待发货→已发货→运输中→已签收→已取消）
5. 发货进度同步（自动更新合同的已发货数量、已发货金额、实际交付日期）
6. 发货逾期提醒（计划发货日期逾期时自动生成待办任务）
7. 发货单取消与回退（取消错误发货单，回退合同发货统计）
8. 发货单搜索与统计（按合同、状态、时间、物流公司筛选，统计发货金额和进度）

**输入**：
- 运营人员/合同管理员：创建发货单、选择发货产品和数量、填写物流信息、确认发货、签收确认、取消发货单
- 合同管理模块：合同基本信息、产品明细、已发货数量统计
- 产品管理模块：产品基本信息（冗余存储）
- 系统自动：发货逾期检查、合同执行进度更新、任务生成

**输出**：
- 发货单列表数据（供运营人员查询和管理）
- 发货单详情（合同信息、产品明细、物流信息、发货状态）
- 发货进度报表（已发货数量/金额统计，剩余待发货统计）
- 合同执行数据更新（contract.shipped_amount、contract_item.shipped_quantity、contract.actual_delivery_date）
- 待办任务（发货逾期提醒）

**边界**：
- **包含**：发货单创建、编辑、产品明细管理、物流信息管理、状态跟踪、分批发货、进度同步、逾期提醒
- **不包含**：
  - 库存管理（项目明确不需要库存功能）
  - 物流轨迹实时查询（v1.0不对接第三方物流API，v2.0可扩展）
  - 自动发货通知（v1.0手动通知客户，预留邮件/短信通知扩展点）
  - 退货管理（v1.0不实现，预留v2.0功能）
  - 发货审批流程（v1.0直接发货，无需审批）
- **关联模块**：
  - 合同管理模块（读取合同数据，更新合同执行进度）
  - 产品管理模块（读取产品信息）
  - 客户管理模块（读取客户信息和收货地址）
  - 待办任务模块（生成发货逾期提醒任务）
  - 用户权限模块（权限控制）

**失败策略**：
- 发货数量不能超过合同剩余待发货数量（this_shipment_quantity <= contract_quantity - already_shipped_quantity）
- 发货单状态为"已发货"后，物流信息允许修改（应对物流公司更换场景），但发货数量不允许修改
- 发货单被取消后，自动回退合同的发货统计（shipped_amount、shipped_quantity），状态变为终态不可再修改
- 发货单产品明细不能为空（至少包含1个产品）
- 发货单确认发货时，物流公司和运单号必填
- 仅状态为signed/executing的合同可创建发货单
- 同一合同可创建多个发货单，直到所有产品全部发货完成
- 当合同的所有产品全部发货完成时，自动更新contract.actual_delivery_date为最后一次发货的实际发货日期
- 发货单草稿超过30天未确认发货，系统自动标记为"已取消"并归档
- 发货单的计划发货日期不能早于合同签订日期

---

### 4.9 收款管理模块

**模块职责**：
管理合同收款的全流程，包括收款记录创建、收款方式管理、分期收款跟踪、收款核销与自动更新合同进度，为财务管理提供应收账款统计与分析支持，确保收款过程可追溯、数据可核对、逾期可预警。

**核心功能**：
1. 收款记录创建与编辑（基于已签订合同创建，支持分期收款和部分收款）
2. 收款方式与银行信息管理（银行转账、支票、现金、第三方支付等）
3. 分期收款跟踪（关联合同付款条款payment_terms，记录每期收款进度）
4. 部分收款支持（一期可能分多次收款，累加更新已收款金额）
5. 收款核销与自动更新（自动累加contract.received_amount，标记收款完成状态）
6. 应收账款统计与分析（未收款金额、逾期应收款、收款进度报表）
7. 收款逾期提醒（应收款到期前3天提醒，逾期后高优先级预警）
8. 收款记录查询与导出（按合同、客户、时间、收款方式筛选，导出对账单）

**输入**：
- 财务人员/销售人员：创建收款记录、选择收款阶段、填写收款金额和方式、银行流水号、确认收款
- 合同管理模块：合同基本信息、付款条款（payment_terms）、已收款金额统计
- 客户管理模块：客户基本信息
- 系统自动：收款逾期检查、合同执行进度更新、任务生成

**输出**：
- 收款记录列表数据（供财务人员查询和管理）
- 收款记录详情（合同信息、收款阶段、收款金额、收款方式、银行信息）
- 应收账款报表（未收款金额统计、逾期应收款统计、收款进度分析）
- 合同执行数据更新（contract.received_amount）
- 待办任务（收款到期提醒、收款逾期预警）

**边界**：
- **包含**：收款记录创建、编辑、收款方式管理、分期收款跟踪、部分收款累加、收款核销、应收账款统计、逾期提醒
- **不包含**：
  - 发票管理（v1.0单独模块，与收款管理集成，先收款后开票）
  - 财务凭证生成（v1.0不对接财务系统，手动记账）
  - 自动催款通知（v1.0手动催款，预留邮件/短信通知扩展点）
  - 退款管理（v1.0不实现，预留v2.0功能）
  - 收款审批流程（v1.0直接确认收款，无需审批）
- **关联模块**：
  - 合同管理模块（读取合同数据、付款条款，更新合同执行进度）
  - 客户管理模块（读取客户信息）
  - 待办任务模块（生成收款到期提醒、逾期预警任务）
  - 发票管理模块（提供收款依据，v2.0集成）
  - 用户权限模块（权限控制）

**失败策略**：
- 收款金额不能为负数或零
- 收款记录必须关联有效合同（状态为signed/executing/completed）
- 收款日期不能早于合同签订日期
- 收款阶段（payment_stage）必须与合同付款条款（payment_terms）中的stage一致
- 同一合同的同一付款阶段可创建多条收款记录（支持部分收款），累加计算已收款金额
- 收款总额不能超过合同总金额（contract_amount），系统提示超额预警但允许保存（应对补偿款场景）
- 收款记录创建后，自动累加更新contract.received_amount
- 收款记录被删除或取消时，自动回退contract.received_amount
- 当contract.received_amount = contract_amount时，系统提示该合同收款已完成
- 收款逾期判定规则：payment_terms中的due_date < 当前日期 且该期已收款金额 < 该期应收金额
- 收款到期前3天自动生成待办任务提醒
- 收款逾期后自动生成高优先级待办任务预警
- 收款记录必须包含收款方式（payment_method），银行转账方式必须填写银行账户和流水号
- 仅状态为confirmed（已确认）的收款记录才更新合同的received_amount

---

### 4.10 发票管理模块

**模块职责**：
管理合同开票的全流程，包括发票记录创建、发票类型与信息管理、发票与收款关联、发票开具确认与自动更新合同进度，为财务管理提供开票统计与分析支持，确保开票过程可追溯、数据可核对、信息准确合规。

**核心功能**：
1. 发票记录创建与编辑（基于已签订合同创建，支持关联收款记录或独立开票）
2. 发票类型与信息管理（增值税专用发票、增值税普通发票，发票抬头、税号、开票金额）
3. 发票与收款关联（可选关联收款记录，支持先收款后开票或预开票场景）
4. 发票状态管理（待开票、已开具、已作废，清晰的状态流转）
5. 发票开具确认与自动更新（自动累加contract.invoiced_amount，标记开票完成状态）
6. 发票作废与进度回退（发票作废时自动回退contract.invoiced_amount）
7. 发票记录查询与导出（按合同、客户、时间、发票类型筛选，导出开票清单）
8. 发票统计与分析（已开票金额、未开票金额、开票进度报表）

**输入**：
- 财务人员：创建发票记录、选择发票类型、填写发票抬头和税号、录入发票号码和开票金额、确认开具
- 合同管理模块：合同基本信息、合同金额、已开票金额统计
- 收款管理模块：收款记录数据（可选关联）
- 客户管理模块：客户开票信息（发票抬头、税号、开户行、账号、地址、电话）
- 系统自动：合同执行进度更新

**输出**：
- 发票记录列表数据（供财务人员查询和管理）
- 发票记录详情（合同信息、发票类型、发票号码、开票金额、发票抬头、税号）
- 开票统计报表（已开票金额统计、未开票金额统计、开票进度分析）
- 合同执行数据更新（contract.invoiced_amount）
- 发票打印数据（预留，v2.0集成发票打印功能）

**边界**：
- **包含**：发票记录创建、编辑、发票类型管理、发票与收款关联、发票状态管理、发票开具确认、发票作废、开票统计
- **不包含**：
  - 电子发票自动开具（v1.0手动录入发票信息，预留v2.0集成税控系统）
  - 发票打印（v1.0不实现，预留v2.0功能）
  - 发票认证管理（v1.0不实现，客户自行认证）
  - 红字发票管理（v1.0发票作废即可，预留v2.0红票功能）
  - 发票审批流程（v1.0直接确认开具，无需审批）
- **关联模块**：
  - 合同管理模块（读取合同数据，更新合同执行进度）
  - 收款管理模块（可选关联收款记录，提供开票依据）
  - 客户管理模块（读取客户开票信息）
  - 用户权限模块（权限控制）

**失败策略**：
- 发票金额不能为负数或零
- 发票记录必须关联有效合同（状态为signed/executing/completed）
- 发票日期不能早于合同签订日期
- 发票类型为增值税专用发票时，客户税号必填
- 发票总额不能超过合同总金额（contract_amount），系统提示超额预警但允许保存（应对补偿开票场景）
- 发票记录创建后，待开具状态（draft）不更新合同的invoiced_amount
- 发票状态变为已开具（confirmed）时，自动累加更新contract.invoiced_amount
- 发票记录被作废（voided）时，自动回退contract.invoiced_amount
- 当contract.invoiced_amount = contract_amount时，系统提示该合同开票已完成
- 发票号码必须唯一（全局唯一约束，防止重复录入）
- 仅状态为confirmed（已开具）的发票记录才更新合同的invoiced_amount
- 已开具（confirmed）的发票不允许直接删除，必须先作废（voided）
- 发票抬头必填，税号根据发票类型决定是否必填
- 如果关联收款记录（payment_id有值），发票金额不能超过该笔收款金额（柔性校验，提示但允许保存）

---

### 4.11 售后服务模块

**模块职责**：
管理产品交付后的客户服务全流程，包括服务工单创建、工单类型与优先级管理、工单状态跟踪、服务记录与配件更换管理、质保期判断与管理、客户满意度评价，为售后团队提供工单分配与提醒支持，确保服务过程可追溯、响应及时、质量可控。

**核心功能**：
1. 服务工单创建与编辑（客户报修、主动巡检、技术支持、产品更换等类型）
2. 工单类型与优先级管理（故障维修/产品更换/技术支持/定期巡检，紧急/高/中/低优先级）
3. 工单状态管理（待处理→处理中→待验收→已解决→已关闭，清晰的状态流转）
4. 质保期自动判断（从合同读取质保期信息，自动标识是否在保修期内）
5. 服务记录与操作日志（服务时间、服务人员、处理结果、配件更换、费用记录）
6. 工单分配与转派（自动分配给售后负责人，支持手动转派）
7. 客户满意度评价（服务完成后客户评分和反馈）
8. 工单提醒与逾期预警（新工单提醒、响应超时提醒、处理逾期提醒，集成待办任务系统）

**输入**：
- 客服人员：创建服务工单、选择工单类型和优先级、分配处理人、记录服务过程
- 售后工程师：更新工单状态、记录服务内容、填写配件更换信息、上传现场照片
- 客户（可选）：提交工单请求（v2.0预留客户端入口）、评价服务质量
- 合同管理模块：合同质保条款（warranty_start_date、warranty_end_date、warranty_terms）
- 客户管理模块：客户基本信息、客户联系人信息
- 产品管理模块：产品基本信息（故障产品型号）
- 待办任务系统：工单自动提醒规则

**输出**：
- 服务工单列表数据（供售后团队查询和管理）
- 工单详情（工单类型、优先级、状态、服务记录、配件更换、费用信息）
- 服务统计报表（工单量统计、响应时效统计、客户满意度统计、故障类型分析）
- 客户跟进记录（售后回访记录，写入customer_follow_up表，follow_up_type='after_sales'）
- 待办任务（新工单待处理、工单逾期提醒）
- 质保期预警（质保期到期前30天提醒，已在合同模块实现）

**边界**：
- **包含**：服务工单创建、编辑、工单类型与优先级管理、工单状态跟踪、质保期判断、服务记录管理、工单分配与转派、客户满意度评价、工单查询与导出、工单统计分析
- **不包含**：
  - 配件库存管理（v1.0仅记录配件更换信息，不管理库存，预留v2.0集成库存系统）
  - 服务费用自动计算（v1.0手动填写服务费用，预留v2.0自动计费功能）
  - 服务合同与延保管理（v1.0不实现，预留v2.0延保服务功能）
  - 现场服务调度与路线规划（v1.0不实现，预留v2.0外勤管理功能）
  - 客户自助服务门户（v1.0不实现，预留v2.0客户端功能）
  - 远程诊断与维修（v1.0不实现，预留v2.0集成物联网设备诊断）
- **关联模块**：
  - 合同管理模块（读取合同质保条款，判断是否在质保期内）
  - 客户管理模块（读取客户信息、联系人信息，写入售后回访记录customer_follow_up）
  - 产品管理模块（读取产品信息，记录故障产品型号）
  - 待办任务模块（自动生成工单处理提醒、逾期预警）
  - 用户权限模块（权限控制）

**失败策略**：
- 工单必须关联有效的客户（customer_id不能为空）
- 工单创建时，如果关联合同（contract_id有值），必须是有效合同（状态为signed/executing/completed）
- 工单优先级必须为预定义值（urgent/high/medium/low）
- 工单状态流转必须符合状态机规则（pending→in_progress→pending_acceptance→resolved→closed）
- 服务记录（service_ticket_log）必须关联有效的工单（ticket_id不能为空）
- 工单状态变更时，必须同步记录操作日志（service_ticket_log表）
- 工单状态为pending时，未分配处理人（assigned_to为空），不允许流转至in_progress状态
- 工单状态为in_progress时，处理人必填（assigned_to不能为空）
- 工单状态为resolved（已解决）后，如果客户评分或反馈（已填写），不允许直接删除工单
- 工单响应超时提醒规则：
  - 紧急工单（urgent）：2小时内未响应（状态仍为pending）生成待办任务
  - 高优先级工单（high）：4小时内未响应生成待办任务
  - 中优先级工单（medium）：1个工作日内未响应生成待办任务
  - 低优先级工单（low）：2个工作日内未响应生成待办任务
- 工单处理超时提醒规则：
  - 紧急工单（urgent）：8小时内未解决（状态未变为resolved/closed）生成逾期提醒任务
  - 高优先级工单（high）：24小时内未解决生成逾期提醒任务
  - 中优先级工单（medium）：3个工作日内未解决生成逾期提醒任务
  - 低优先级工单（low）：7个工作日内未解决生成逾期提醒任务
- 工单质保期判断规则：
  - 如果关联合同（contract_id有值），从合同读取warranty_start_date和warranty_end_date
  - 如果工单创建时间在[warranty_start_date, warranty_end_date]区间内，is_under_warranty=1（在保）
  - 否则is_under_warranty=0（不在保），服务可能需要收费
- 工单状态为closed后，不允许再次修改（终态），如需重新处理，应创建新工单
- 客户满意度评分范围：1-5分（1=非常不满意，5=非常满意）
- 仅状态为resolved或closed的工单才允许客户评价
- 服务费用（service_fee）为0时，表示免费服务（质保期内或厂商承担）

---

## 5. 模块内部流程

### 5.1 产品管理流程
> 待确认关键场景

### 5.2 客户管理流程
> 待确认关键场景

### 5.3 用户角色权限管理流程
> 待确认关键场景

---

## 6. 模块间接口

> 待确认模块间交互协议

---

## 7. 数据模型

### 数据模型设计核心理念：两条主线架构

艾居来 CRM 系统的数据模型设计遵循**"两条主线"架构**，确保所有业务数据可完整追溯，核心原则如下：

#### 两条主线定义

1. **线索主线（Customer Line）**：以`customer`表为核心
   - 记录客户/线索的完整生命周期：从销售线索（lead）→ 初步接触 → 意向客户 → 商务洽谈 → 成交客户
   - 所有业务活动必须关联到客户来源，确保每一笔业务都能追溯到最初的销售线索
   - customer_id字段是线索主线的核心标识

2. **合同主线（Contract Line）**：以`contract`表为核心
   - 记录合同签订后的执行过程：签订 → 发货 → 收款 → 开票 → 售后
   - 所有合同执行相关的业务单据必须关联到合同，确保合同履约全过程可追溯
   - contract_id字段是合同主线的核心标识

#### 两条主线关联规则

所有业务模块的核心表**必须同时关联两条主线**，具体要求：

| 业务模块 | 核心表 | 关联线索主线（customer_id） | 关联合同主线（contract_id） | 说明 |
|---------|--------|---------------------------|---------------------------|------|
| 报价单管理 | quotation | 必填 | 可选（转化后填充） | 报价单创建时必须先选择客户/线索，确保报价单都有明确来源 |
| 合同管理 | contract | 必填 | - | 合同创建时必须关联客户，如果从报价单转化则自动继承customer_id |
| 发货管理 | shipment | 必填（冗余） | 必填 | 创建发货单时从contract自动继承customer_id |
| 收款管理 | payment | 必填（冗余） | 必填 | 创建收款记录时从contract自动继承customer_id |
| 发票管理 | invoice | 必填（冗余） | 必填 | 创建发票记录时从contract自动继承customer_id |
| 售后服务 | service_ticket | 必填 | 可选 | 创建工单时必须关联客户，可选关联合同（用于判断质保期） |

#### 设计优势

1. **完整追溯性**：
   - 通过customer_id可追溯：该客户所有的报价单、合同、发货、收款、发票、售后记录
   - 通过contract_id可追溯：该合同所有的执行记录（发货、收款、开票、售后）
   - 双主线交叉验证，确保数据一致性

2. **高效查询**：
   - 按客户统计时，无需JOIN多张表即可直接聚合（customer_id已冗余在各业务表）
   - 按合同统计时，同样可直接聚合（contract_id已存在）
   - 减少JOIN操作，提升查询性能

3. **业务灵活性**：
   - 支持无合同场景（如：售后咨询工单可以不关联contract，仅关联customer）
   - 支持报价单未转化场景（quotation有customer_id但contract_id为空）
   - 支持多合同场景（一个客户可以有多个合同）

4. **数据一致性维护**：
   - customer_id在业务单据创建时一次性填充，不允许修改（保证历史数据不变）
   - contract_id在合同签订后填充，不允许修改（保证合同执行记录不变）
   - 通过数据库约束（FOREIGN KEY）确保引用完整性

#### 实现要点

1. **创建时自动继承**：
   - 报价单创建：用户手动选择customer_id
   - 合同创建：从报价单转化时自动继承customer_id；手动创建时用户选择customer_id
   - 发货单创建：自动从contract.customer_id继承
   - 收款记录创建：自动从contract.customer_id继承
   - 发票记录创建：自动从contract.customer_id继承
   - 售后工单创建：用户手动选择customer_id，可选关联contract_id

2. **数据校验规则**：
   - 如果业务单据同时有customer_id和contract_id，必须满足：payment.customer_id = contract.customer_id（业务逻辑校验）
   - 防止数据不一致情况（如：收款记录的customer_id与合同的customer_id不匹配）

3. **索引优化**：
   - 所有包含customer_id的表都创建索引：INDEX (customer_id)
   - 所有包含contract_id的表都创建索引：INDEX (contract_id)
   - 支持按客户、按合同的高效查询和统计

---

### 7.1 产品实体

#### 7.1.1 产品分类表（product_category）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| category_id | BIGINT | PK, AUTO_INCREMENT | 分类ID |
| category_name | VARCHAR(100) | NOT NULL, UNIQUE | 分类名称（如：自助入住机、酒店插座、开关、窗帘机、音响） |
| category_code | VARCHAR(50) | NOT NULL, UNIQUE | 分类编码（如：CHECKIN、SOCKET、SWITCH、CURTAIN、AUDIO） |
| sort_order | INT | DEFAULT 0 | 排序号 |
| description | TEXT | NULL | 分类描述 |
| is_active | TINYINT | DEFAULT 1 | 是否启用（1=启用，0=停用） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| creator_id | BIGINT | NOT NULL | 创建人ID（关联用户表） |

**索引**：
- PRIMARY KEY (category_id)
- UNIQUE KEY (category_code)
- INDEX (is_active)

---

#### 7.1.2 产品SKU表（product）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| product_id | BIGINT | PK, AUTO_INCREMENT | 产品ID |
| product_code | VARCHAR(100) | NOT NULL, UNIQUE | 产品编码（如：CHECKIN-A100） |
| product_name | VARCHAR(200) | NOT NULL | 产品名称 |
| brand | VARCHAR(100) | NULL | 品牌 |
| category_id | BIGINT | NOT NULL, FK | 所属分类ID（外键关联product_category） |
| supplier | VARCHAR(200) | NULL | 供应商名称 |
| cost_price | DECIMAL(12,2) | DEFAULT 0.00 | 成本价（元） |
| sale_price | DECIMAL(12,2) | DEFAULT 0.00 | 报价/销售价（元） |
| unit | VARCHAR(20) | DEFAULT '台' | 单位（台、个、套等） |
| product_images | TEXT | NULL | 产品图片URL列表（JSON数组格式，如：["url1", "url2", "url3"]） |
| description | TEXT | NULL | 产品描述/备注 |
| status | VARCHAR(20) | DEFAULT 'active' | 产品状态（active=在售，inactive=停售，draft=草稿） |
| **预留扩展字段** | | | |
| custom_field_1 | VARCHAR(500) | NULL | 自定义字段1（预留） |
| custom_field_2 | VARCHAR(500) | NULL | 自定义字段2（预留） |
| custom_field_3 | VARCHAR(500) | NULL | 自定义字段3（预留） |
| custom_field_4 | TEXT | NULL | 自定义字段4（预留，可存储JSON） |
| custom_field_5 | TEXT | NULL | 自定义字段5（预留，可存储JSON） |
| custom_field_6 | TEXT | NULL | 自定义字段6（预留，可存储JSON） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NULL | 负责人ID（关联用户表，预留） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (product_id)
- UNIQUE KEY (product_code)
- INDEX (category_id)
- INDEX (brand)
- INDEX (status)
- INDEX (supplier)
- INDEX (created_by)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (category_id) REFERENCES product_category(category_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- CHECK (cost_price >= 0)
- CHECK (sale_price >= 0)

**生命周期**：
1. **草稿（draft）**：产品信息录入中，暂不可用于报价
2. **在售（active）**：正常销售状态，可用于报价和合同
3. **停售（inactive）**：已停售，历史合同仍可查看，新报价不可选择
4. **软删除（deleted_at有值）**：逻辑删除，仅管理员可见

**业务规则**：
1. 产品编码（product_code）必须唯一，建议格式：分类编码-流水号（如：CHECKIN-A100）
2. 成本价和报价不能为负数
3. 产品被合同/报价单引用后，不允许物理删除，仅可标记为停售或软删除
4. 产品图片支持多张，存储格式为JSON数组：`["url1", "url2", "url3"]`
5. 品牌字段用于标识产品品牌，支持按品牌筛选和统计
6. 自定义字段用于存储未来可能新增的产品属性（如：保修期、功率、尺寸等）
7. 审计字段：
   - created_by 记录产品创建人，不可修改
   - updated_by 记录最后修改人，每次更新时自动更新
   - 创建人和修改人可用于操作追溯和权限审计

### 7.2 客户实体

#### 7.2.1 客户表（customer）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| customer_id | BIGINT | PK, AUTO_INCREMENT | 客户ID |
| customer_code | VARCHAR(100) | NOT NULL, UNIQUE | 客户编码（自动生成，如：CUST-20251222-001） |
| customer_name | VARCHAR(200) | NOT NULL | 客户名称（公司名称） |
| customer_type | VARCHAR(50) | NOT NULL | 客户类型（chain_hotel=连锁酒店集团，single_hotel=单体酒店，distributor=经销商，homestay=民宿，apartment=公寓） |
| customer_level | VARCHAR(20) | NULL | 客户等级（A=大客户，B=中型客户，C=小客户，仅成交后设置） |
| customer_stage | VARCHAR(50) | NOT NULL | 客户阶段（lead=销售线索，initial_contact=初步接触，prospect=意向客户，negotiation=商务洽谈，client=成交客户，inactive=流失客户） |
| industry | VARCHAR(100) | NULL | 行业（酒店业、旅游业等） |
| province | VARCHAR(50) | NULL | 省份 |
| city | VARCHAR(50) | NULL | 城市 |
| address | VARCHAR(500) | NULL | 详细地址 |
| contact_phone | VARCHAR(50) | NULL | 客户联系电话（总机） |
| hotel_rooms | INT | NULL | 酒店房间数量 |
| hotel_star | VARCHAR(20) | NULL | 酒店星级（一星、二星、三星、四星、五星、经济型） |
| source | VARCHAR(50) | NULL | 客户来源（social_media=新媒体营销，exhibition=线下展会，referral=老客户转介绍，website=官网咨询，phone=电话来访，other=其他） |
| description | TEXT | NULL | 备注 |
| **预留扩展字段** | | | |
| custom_field_1 | VARCHAR(500) | NULL | 自定义字段1（预留） |
| custom_field_2 | VARCHAR(500) | NULL | 自定义字段2（预留） |
| custom_field_3 | VARCHAR(500) | NULL | 自定义字段3（预留） |
| custom_field_4 | TEXT | NULL | 自定义字段4（预留，可存储JSON） |
| custom_field_5 | TEXT | NULL | 自定义字段5（预留，可存储JSON） |
| **权限控制字段（预留）** | | | |
| creator_id | BIGINT | NOT NULL | 创建人ID（关联用户表） |
| owner_id | BIGINT | NOT NULL | 负责人ID（关联用户表，通常为销售人员） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| stage_updated_at | DATETIME | NULL | 阶段最后更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (customer_id)
- UNIQUE KEY (customer_code)
- INDEX (customer_stage)
- INDEX (customer_type)
- INDEX (customer_level)
- INDEX (owner_id)
- INDEX (source)
- INDEX (province, city)
- INDEX (created_at)
- INDEX (stage_updated_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (creator_id) REFERENCES user(user_id)
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- CHECK (hotel_rooms >= 0)

**生命周期（customer_stage）**：
1. **销售线索（lead）**：新媒体营销收集的初始线索，未确认有效性
2. **初步接触（initial_contact）**：销售开始跟进，初步建立联系
3. **意向客户（prospect）**：客户有明确采购意向，进入深度沟通
4. **商务洽谈（negotiation）**：进入报价和谈判阶段，可能已发送报价单
5. **成交客户（client）**：已签订合同，完成交易
6. **流失客户（inactive）**：长期未跟进或明确拒绝合作

**业务规则**：
1. 客户编码自动生成，建议格式：CUST-YYYYMMDD-流水号
2. 客户阶段原则上只能向前推进（lead → client），不允许回退（防止数据混乱）
3. 客户等级（customer_level）仅在客户成交后（stage=client）设置，用于区分客户价值
4. owner_id（负责人）管理规则：
   - owner_id=NULL表示线索在公共线索池，未分配负责人
   - owner_id可以转移，转移时需在customer_follow_up表中记录转移日志
   - 仅分配了负责人（owner_id≠NULL）的线索才能添加跟进记录
5. 客户被报价单或合同引用后，不允许物理删除，仅可软删除（deleted_at）
6. stage_updated_at字段用于计算客户在各阶段的停留时间，便于销售漏斗分析
7. 线索管理特殊规则（customer_stage='lead'时）：
   - 线索录入时可选择立即分配负责人或进入公共线索池（owner_id=NULL）
   - 销售人员可从公共线索池主动领取线索（设置owner_id）
   - 销售人员可放弃线索（owner_id改回NULL，退回公共池）
   - 管理员可强制回收或重新分配线索
   - 标记为inactive的线索不再出现在公共线索池，仅管理员可查看

---

#### 7.2.2 客户联系人表（customer_contact）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| contact_id | BIGINT | PK, AUTO_INCREMENT | 联系人ID |
| customer_id | BIGINT | NOT NULL, FK | 所属客户ID（外键关联customer） |
| contact_name | VARCHAR(100) | NOT NULL | 联系人姓名 |
| position | VARCHAR(100) | NULL | 职位（如：总经理、采购经理、财务负责人） |
| mobile | VARCHAR(50) | NULL | 手机号 |
| wechat | VARCHAR(100) | NULL | 微信号 |
| email | VARCHAR(200) | NULL | 邮箱 |
| is_primary | TINYINT | DEFAULT 0 | 是否主要联系人（1=是，0=否） |
| description | TEXT | NULL | 备注 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| creator_id | BIGINT | NOT NULL | 创建人ID（关联用户表） |

**索引**：
- PRIMARY KEY (contact_id)
- INDEX (customer_id)
- INDEX (is_primary)
- INDEX (mobile)

**约束**：
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (creator_id) REFERENCES user(user_id)
- 每个客户至少有一个主要联系人（业务逻辑校验）

**业务规则**：
1. 每个客户必须至少有一个主要联系人（is_primary=1）
2. 一个客户可以有多个联系人，但只能有一个主要联系人
3. 删除主要联系人前，需先将另一个联系人设为主要联系人
4. 联系人的手机号、微信、邮箱至少填写一项（业务逻辑校验）

---

#### 7.2.3 客户来源渠道表（customer_source）（可选，字典表）

如果需要灵活配置客户来源，可创建独立字典表：

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| source_id | INT | PK, AUTO_INCREMENT | 来源ID |
| source_code | VARCHAR(50) | NOT NULL, UNIQUE | 来源编码（social_media, exhibition等） |
| source_name | VARCHAR(100) | NOT NULL | 来源名称（新媒体营销、线下展会等） |
| is_active | TINYINT | DEFAULT 1 | 是否启用 |
| sort_order | INT | DEFAULT 0 | 排序号 |
| description | TEXT | NULL | 描述 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**说明**：
- 可以在系统管理中动态配置客户来源
- customer表的source字段关联source_code
- 也可以不创建此表，直接在customer表的source字段使用枚举值或字符串

---

#### 7.2.4 客户跟进记录表（customer_follow_up）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| follow_up_id | BIGINT | PK, AUTO_INCREMENT | 跟进记录ID |
| customer_id | BIGINT | NOT NULL, FK | 所属客户ID（外键关联customer） |
| follow_up_type | VARCHAR(20) | NOT NULL | 跟进类型（sales=销售跟进，after_sales=售后回访） |
| follow_up_method | VARCHAR(20) | NOT NULL | 跟进方式（phone=电话，wechat=微信，visit=拜访，email=邮件，other=其他） |
| follow_up_time | DATETIME | NOT NULL | 跟进时间 |
| contact_person | VARCHAR(100) | NULL | 联系的对方人员姓名 |
| follow_up_content | TEXT | NOT NULL | 跟进内容（记录沟通详情） |
| customer_feedback | TEXT | NULL | 客户反馈 |
| next_follow_up_time | DATETIME | NULL | 下次跟进计划时间 |
| next_follow_up_content | VARCHAR(500) | NULL | 下次跟进计划内容 |
| stage_before | VARCHAR(50) | NULL | 跟进前客户阶段（用于记录阶段变更） |
| stage_after | VARCHAR(50) | NULL | 跟进后客户阶段（用于记录阶段变更） |
| is_stage_changed | TINYINT | DEFAULT 0 | 本次跟进是否变更了客户阶段（1=是，0=否） |
| attachment_urls | TEXT | NULL | 附件URL列表（JSON数组格式，如：["url1", "url2"]） |
| follow_up_result | VARCHAR(20) | NULL | 跟进结果（successful=成功推进，pending=待定，failed=失败/拒绝） |
| **审计字段** | | | |
| creator_id | BIGINT | NOT NULL | 跟进人ID（关联用户表，即执行跟进的销售/客服人员） |
| created_at | DATETIME | NOT NULL | 创建时间（记录录入时间） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间 |

**索引**：
- PRIMARY KEY (follow_up_id)
- INDEX (customer_id)
- INDEX (follow_up_type)
- INDEX (follow_up_time)
- INDEX (creator_id)
- INDEX (next_follow_up_time)
- INDEX (is_stage_changed)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (creator_id) REFERENCES user(user_id)

**业务规则**：
1. **跟进类型区分**：
   - `sales`：用于销售线索阶段（lead/initial_contact/prospect/negotiation），由销售人员创建
   - `after_sales`：用于成交客户的售后回访（stage=client），由运营人员或客服创建
   - 通过follow_up_type区分，避免两种场景的跟进记录混淆

2. **阶段变更记录**：
   - 当跟进导致客户阶段变更时，需同时记录stage_before和stage_after
   - is_stage_changed=1表示本次跟进推动了客户阶段前进
   - 用于后续分析"哪些跟进动作有效推进了销售进程"

3. **下次跟进计划**：
   - next_follow_up_time不为空时，系统自动生成待办任务提醒跟进人
   - 完成下次跟进后，创建新的跟进记录，原记录的next_follow_up_time保持不变（作为历史计划）

4. **必填项校验**：
   - follow_up_content必须填写，不能为空（确保跟进记录有实际内容）
   - follow_up_time默认为当前时间，可修改为实际跟进发生的时间

5. **附件支持**：
   - 可上传聊天截图、邮件截图、合同草稿等附件
   - 存储格式为JSON数组：`["https://example.com/file1.png", "https://example.com/file2.pdf"]`

6. **跟进结果分类**：
   - successful：客户有积极反馈，销售进程推进
   - pending：客户态度模糊，需继续跟进
   - failed：客户明确拒绝或无法联系

7. **数据归属**：
   - creator_id为跟进人（通常为客户的owner_id，但也可能是协同跟进的其他销售）
   - 跟进记录不随客户负责人转移而变更，保持历史真实性

### 7.3 用户与权限实体

#### 7.3.1 用户表（user）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| user_id | BIGINT | PK, AUTO_INCREMENT | 用户ID |
| user_code | VARCHAR(50) | NULL, UNIQUE | 用户工号（可选，可用于内部管理） |
| real_name | VARCHAR(100) | NOT NULL | 真实姓名 |
| mobile | VARCHAR(20) | NOT NULL, UNIQUE | 手机号（用于登录） |
| email | VARCHAR(200) | NULL | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希值（使用bcrypt或类似算法） |
| avatar | VARCHAR(500) | NULL | 头像URL |
| is_active | TINYINT | DEFAULT 1 | 是否启用（1=启用，0=禁用） |
| is_first_login | TINYINT | DEFAULT 1 | 是否首次登录（1=是，0=否，首次登录强制修改密码） |
| last_login_at | DATETIME | NULL | 最后登录时间 |
| last_login_ip | VARCHAR(50) | NULL | 最后登录IP |
| failed_login_count | INT | DEFAULT 0 | 连续登录失败次数 |
| locked_until | DATETIME | NULL | 账户锁定截止时间（NULL表示未锁定） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| creator_id | BIGINT | NULL | 创建人ID（第一个管理员为NULL） |
| deleted_at | DATETIME | NULL | 软删除时间 |

**索引**：
- PRIMARY KEY (user_id)
- UNIQUE KEY (mobile)
- UNIQUE KEY (user_code)
- INDEX (is_active)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- 手机号格式校验（业务逻辑层）
- 密码强度要求：至少8位，包含大小写字母、数字（业务逻辑层）

**业务规则**：
1. 手机号全局唯一，不可重复
2. 密码使用bcrypt哈希，不存储明文
3. 首次登录（is_first_login=1）时，必须强制用户修改初始密码
4. 连续登录失败5次后，账户锁定30分钟（locked_until = NOW() + 30分钟）
5. 成功登录后，重置failed_login_count为0
6. 系统至少保留1个启用状态的系统管理员账户（业务逻辑校验）

---

#### 7.3.2 角色表（role）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| role_id | INT | PK, AUTO_INCREMENT | 角色ID |
| role_code | VARCHAR(50) | NOT NULL, UNIQUE | 角色编码（admin, marketing, sales, finance, operation） |
| role_name | VARCHAR(100) | NOT NULL | 角色名称（系统管理员、营销人员、销售人员、财务人员、运营人员） |
| description | TEXT | NULL | 角色描述 |
| is_system | TINYINT | DEFAULT 1 | 是否系统内置角色（1=是，0=否，系统内置角色不可删除） |
| sort_order | INT | DEFAULT 0 | 排序号 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (role_id)
- UNIQUE KEY (role_code)

**预置数据**（系统初始化时插入）：
```sql
INSERT INTO role (role_code, role_name, description, is_system) VALUES
('admin', '系统管理员', '拥有系统全部权限，可管理用户、产品、客户等所有模块', 1),
('marketing', '营销人员', '负责销售线索收集和录入', 1),
('sales', '销售人员', '负责客户跟进、报价、合同签订', 1),
('finance', '财务人员', '负责发票开具、收款记录', 1),
('operation', '运营人员', '负责产品发货、售后服务', 1);
```

**业务规则**：
1. 5个角色固定，不支持新增/删除角色（is_system=1）
2. 角色名称和描述可以编辑，但role_code不可修改
3. 角色不可删除，仅可通过权限配置控制功能范围

---

#### 7.3.3 用户角色关联表（user_role）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| user_role_id | BIGINT | PK, AUTO_INCREMENT | 关联ID |
| user_id | BIGINT | NOT NULL, FK | 用户ID（外键关联user） |
| role_id | INT | NOT NULL, FK | 角色ID（外键关联role） |
| created_at | DATETIME | NOT NULL | 分配时间 |
| creator_id | BIGINT | NOT NULL | 分配人ID |

**索引**：
- PRIMARY KEY (user_role_id)
- UNIQUE KEY (user_id, role_id) -- 同一用户不能重复分配相同角色
- INDEX (user_id)
- INDEX (role_id)

**约束**：
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE CASCADE
- FOREIGN KEY (role_id) REFERENCES role(role_id) ON DELETE RESTRICT
- FOREIGN KEY (creator_id) REFERENCES user(user_id)

**业务规则**：
1. 一个用户可以拥有多个角色（如某人既是销售又兼任财务）
2. 一个用户至少拥有1个角色（业务逻辑校验）
3. 删除用户时，自动删除该用户的所有角色关联（ON DELETE CASCADE）
4. 角色不可删除（ON DELETE RESTRICT）

---

#### 7.3.4 权限表（permission）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| permission_id | INT | PK, AUTO_INCREMENT | 权限ID |
| permission_code | VARCHAR(100) | NOT NULL, UNIQUE | 权限编码（如：product:view, customer:edit） |
| permission_name | VARCHAR(100) | NOT NULL | 权限名称 |
| module_name | VARCHAR(50) | NOT NULL | 所属模块（产品管理、客户管理、报价单等） |
| permission_type | VARCHAR(20) | NOT NULL | 权限类型（menu=菜单访问，action=操作权限） |
| sort_order | INT | DEFAULT 0 | 排序号 |
| description | TEXT | NULL | 权限描述 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (permission_id)
- UNIQUE KEY (permission_code)
- INDEX (module_name)
- INDEX (permission_type)

**预置数据示例**（模块级权限）：
```sql
INSERT INTO permission (permission_code, permission_name, module_name, permission_type) VALUES
-- 基础数据模块
('product:manage', '产品管理', '产品管理', 'menu'),
('customer:manage', '客户管理', '客户管理', 'menu'),
('user:manage', '用户管理', '用户角色权限', 'menu'),

-- 业务模块（后续扩展）
('quotation:manage', '报价单管理', '报价单', 'menu'),
('contract:manage', '合同管理', '合同', 'menu'),
('delivery:manage', '发货管理', '发货', 'menu'),
('invoice:manage', '发票管理', '发票', 'menu'),
('payment:manage', '收款管理', '收款', 'menu'),
('service:manage', '售后服务', '售后', 'menu');
```

**业务规则**：
1. 模块级权限粒度（不细化到按钮级，简化管理）
2. permission_type=menu 表示菜单访问权限，控制用户能看到哪些功能模块

---

#### 7.3.5 角色权限关联表（role_permission）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| role_permission_id | BIGINT | PK, AUTO_INCREMENT | 关联ID |
| role_id | INT | NOT NULL, FK | 角色ID（外键关联role） |
| permission_id | INT | NOT NULL, FK | 权限ID（外键关联permission） |
| created_at | DATETIME | NOT NULL | 分配时间 |
| creator_id | BIGINT | NOT NULL | 分配人ID |

**索引**：
- PRIMARY KEY (role_permission_id)
- UNIQUE KEY (role_id, permission_id) -- 同一角色不能重复分配相同权限
- INDEX (role_id)
- INDEX (permission_id)

**约束**：
- FOREIGN KEY (role_id) REFERENCES role(role_id) ON DELETE CASCADE
- FOREIGN KEY (permission_id) REFERENCES permission(permission_id) ON DELETE RESTRICT
- FOREIGN KEY (creator_id) REFERENCES user(user_id)

**预置数据示例**（角色权限配置）：
```sql
-- 系统管理员：全部权限
INSERT INTO role_permission (role_id, permission_id, creator_id)
SELECT 1, permission_id, 1 FROM permission; -- 假设role_id=1为admin，creator_id=1为初始管理员

-- 营销人员：客户管理（仅线索阶段）
INSERT INTO role_permission (role_id, permission_id, creator_id) VALUES (2, permission_id_of_customer_manage, 1);

-- 销售人员：客户管理、报价单、合同
INSERT INTO role_permission (role_id, permission_id, creator_id) VALUES
(3, permission_id_of_customer_manage, 1),
(3, permission_id_of_quotation_manage, 1),
(3, permission_id_of_contract_manage, 1);

-- 财务人员：发票、收款、合同查看
INSERT INTO role_permission (role_id, permission_id, creator_id) VALUES
(4, permission_id_of_invoice_manage, 1),
(4, permission_id_of_payment_manage, 1),
(4, permission_id_of_contract_view, 1);

-- 运营人员：发货、售后、产品查看
INSERT INTO role_permission (role_id, permission_id, creator_id) VALUES
(5, permission_id_of_delivery_manage, 1),
(5, permission_id_of_service_manage, 1),
(5, permission_id_of_product_view, 1);
```

**业务规则**：
1. 角色权限配置由系统管理员操作
2. 修改角色权限后，已登录用户需重新登录或刷新Token才能生效
3. 删除角色时，自动删除该角色的所有权限关联（ON DELETE CASCADE）

---

#### 7.3.6 操作审计日志表（audit_log）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| log_id | BIGINT | PK, AUTO_INCREMENT | 日志ID |
| user_id | BIGINT | NOT NULL, FK | 操作人ID（外键关联user） |
| user_name | VARCHAR(100) | NOT NULL | 操作人姓名（冗余字段，防止用户删除后无法追溯） |
| module_name | VARCHAR(50) | NOT NULL | 操作模块（产品管理、客户管理等） |
| action_type | VARCHAR(50) | NOT NULL | 操作类型（create=新增，update=修改，delete=删除，view=查看，login=登录，logout=登出） |
| action_desc | TEXT | NOT NULL | 操作描述（如："新增产品：智能门锁-X200"） |
| target_type | VARCHAR(50) | NULL | 操作对象类型（product, customer, user等） |
| target_id | BIGINT | NULL | 操作对象ID |
| request_ip | VARCHAR(50) | NULL | 请求IP地址 |
| request_url | VARCHAR(500) | NULL | 请求URL |
| request_method | VARCHAR(10) | NULL | 请求方法（GET/POST/PUT/DELETE） |
| request_params | TEXT | NULL | 请求参数（JSON格式，敏感信息需脱敏） |
| response_status | INT | NULL | 响应状态码（200, 400, 500等） |
| created_at | DATETIME | NOT NULL | 操作时间 |

**索引**：
- PRIMARY KEY (log_id)
- INDEX (user_id)
- INDEX (module_name)
- INDEX (action_type)
- INDEX (target_type, target_id)
- INDEX (created_at)

**约束**：
- FOREIGN KEY (user_id) REFERENCES user(user_id) ON DELETE RESTRICT

**业务规则**：
1. 记录所有关键操作：新增、修改、删除（不记录普通查看操作，避免日志过多）
2. 敏感信息脱敏：密码、手机号、身份证号等字段需脱敏后存储
3. 日志不允许删除，仅可查询
4. 日志保留期限：建议至少保留1年，超过期限可归档到冷存储
5. 登录/登出操作也记录到审计日志

**记录示例**：
```json
{
  "user_id": 5,
  "user_name": "张三",
  "module_name": "客户管理",
  "action_type": "update",
  "action_desc": "修改客户：希尔顿酒店，更新阶段从'意向客户'到'商务洽谈'",
  "target_type": "customer",
  "target_id": 123,
  "request_ip": "192.168.1.100",
  "created_at": "2025-12-22 14:30:00"
}
```

---

### 7.4 报价单实体

#### 7.4.1 报价单主表（quotation）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| quotation_id | BIGINT | PK, AUTO_INCREMENT | 报价单ID |
| quotation_no | VARCHAR(100) | NOT NULL, UNIQUE | 报价单编号（自动生成，如：QUOTE-20251223-001） |
| quotation_title | VARCHAR(200) | NOT NULL | 报价单标题（如："XX酒店智能硬件采购报价单"） |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（外键关联customer表） |
| customer_contact_id | BIGINT | NULL, FK | 客户联系人ID（外键关联customer_contact表） |
| status | VARCHAR(20) | NOT NULL | 报价单状态（draft=草稿，sent=已发送，accepted=已接受，rejected=已拒绝，expired=已过期，superseded=已被替代） |
| total_amount | DECIMAL(12,2) | NOT NULL | 报价总金额（从明细表汇总计算） |
| discount_total | DECIMAL(12,2) | DEFAULT 0.00 | 总优惠金额（从明细表汇总计算） |
| payment_terms | TEXT | NULL | 付款条件（如："合同签订后7日内支付30%定金，发货前支付70%尾款"） |
| delivery_terms | TEXT | NULL | 交付条件（如："款到15个工作日内发货"） |
| valid_from | DATE | NOT NULL | 生效日期（通常为创建日期或发送日期） |
| valid_until | DATE | NOT NULL | 失效日期（默认值 = valid_from + 30天，可手动修改） |
| extension_count | INT | DEFAULT 0 | 延期次数（记录报价单被延长有效期的次数） |
| last_extension_at | DATETIME | NULL | 最后延期时间 |
| pdf_file_url | VARCHAR(500) | NULL | 生成的PDF文件URL |
| pdf_generated_at | DATETIME | NULL | PDF生成时间 |
| notes | TEXT | NULL | 备注说明 |
| **关联字段** | | | |
| source_quotation_id | BIGINT | NULL | 来源报价单ID（可选，用于标识"基于哪个报价单复制创建"，预留） |
| related_contract_id | BIGINT | NULL | 关联合同ID（转为合同后，记录合同ID，预留） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NOT NULL, FK | 负责人ID（关联用户表，通常为销售人员，继承自客户的owner_id） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| sent_at | DATETIME | NULL | 发送时间（状态变为sent时记录） |
| sent_by | BIGINT | NULL, FK | 发送人ID（关联用户表） |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (quotation_id)
- UNIQUE KEY (quotation_no)
- INDEX (customer_id)
- INDEX (status)
- INDEX (owner_id)
- INDEX (created_at)
- INDEX (valid_until)
- INDEX (sent_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_contact_id) REFERENCES customer_contact(contact_id) ON DELETE SET NULL
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- FOREIGN KEY (sent_by) REFERENCES user(user_id)
- CHECK (total_amount >= 0)
- CHECK (discount_total >= 0)
- CHECK (valid_until >= valid_from)
- CHECK (extension_count >= 0)

**生命周期（status）**：
1. **草稿（draft）**：报价单编辑中，未发送给客户，可随时修改
2. **已发送（sent）**：已发送给客户，等待客户反馈，不允许修改（如需修改需创建新版本）
3. **已接受（accepted）**：客户确认接受此报价，准备签订合同
4. **已拒绝（rejected）**：客户明确拒绝此报价
5. **已过期（expired）**：超过有效期（valid_until）自动失效
6. **已被替代（superseded）**：有新版本报价单，此版本作废

**状态流转规则**：
```
draft（草稿）
  ↓ [销售发送] → sent（已发送）
  ↓ [删除] → deleted_at有值

sent（已发送）
  ↓ [客户确认] → accepted（已接受）
  ↓ [客户拒绝] → rejected（已拒绝）
  ↓ [超过valid_until] → expired（已过期）
  ↓ [创建新版本] → superseded（已被替代）
  ↓ [延长有效期] → 保持sent状态，更新valid_until和extension_count

accepted（已接受）
  ↓ [转为合同] → 保持accepted状态，记录related_contract_id

rejected/expired/superseded → 终态，不再变更
```

**业务规则**：
1. 报价单编号自动生成，建议格式：QUOTE-YYYYMMDD-流水号（如：QUOTE-20251223-001）
2. 创建报价单时：
   - quotation_title默认为"{客户名称}智能硬件采购报价单"，可手动修改
   - owner_id默认继承客户的owner_id（负责销售）
   - valid_from默认为当前日期
   - valid_until默认为valid_from + 30天（系统参数可配置）
   - status默认为draft
3. 报价单状态为draft时，允许编辑所有字段（包括产品明细、价格）
4. 报价单状态变为sent后，不允许修改产品明细和价格字段，如需调整需创建新版本
5. 报价单延期规则：
   - 仅状态为sent的报价单可延期
   - 每次延期需填写延期原因（记录在操作日志）
   - extension_count记录延期次数，超过3次时系统给出提示
   - 延期后更新valid_until和last_extension_at字段
6. 过期检查：
   - 定时任务每日凌晨2点检查，将valid_until < 当前日期且status=sent的报价单自动标记为expired
   - 过期前3天（valid_until - 当前日期 <= 3天），系统生成待办提醒通知owner
7. 报价单被合同引用后（related_contract_id不为空），不允许删除
8. 报价单明细不能为空，至少包含1个产品（业务逻辑校验）
9. total_amount和discount_total由系统自动从quotation_item表汇总计算，不允许手动修改
10. PDF生成规则：
    - 仅状态为sent/accepted的报价单允许生成PDF
    - PDF文件存储在对象存储服务（如阿里云OSS），pdf_file_url记录访问地址
    - PDF生成失败不阻止报价单保存，可稍后重新生成
11. 创建报价单时客户阶段提示：
    - 推荐客户阶段为prospect（意向客户）或negotiation（商务洽谈）
    - 其他阶段（lead/initial_contact）创建时给出提示："建议先将客户推进至意向阶段后再创建报价单"，但不强制阻止

---

#### 7.4.2 报价单明细表（quotation_item）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| item_id | BIGINT | PK, AUTO_INCREMENT | 明细ID |
| quotation_id | BIGINT | NOT NULL, FK | 报价单ID（外键关联quotation） |
| product_id | BIGINT | NOT NULL, FK | 产品ID（外键关联product） |
| product_code | VARCHAR(100) | NOT NULL | 产品编码（冗余字段，快照保存，防止产品信息变更影响历史报价单） |
| product_name | VARCHAR(200) | NOT NULL | 产品名称（冗余字段，快照保存） |
| product_unit | VARCHAR(20) | NOT NULL | 单位（冗余字段，如：台、个、套） |
| quantity | DECIMAL(10,2) | NOT NULL | 数量 |
| standard_price | DECIMAL(12,2) | NOT NULL | 标准报价（来自产品表的sale_price，创建时自动带入，作为价格快照） |
| actual_price | DECIMAL(12,2) | NOT NULL | 实际销售单价（可手动修改，允许与标准价不同） |
| discount_amount | DECIMAL(12,2) | DEFAULT 0.00 | 优惠金额（= (standard_price - actual_price) × quantity，自动计算） |
| discount_rate | DECIMAL(5,2) | DEFAULT 0.00 | 折扣率（= (standard_price - actual_price) / standard_price × 100%，自动计算，单位：%） |
| subtotal | DECIMAL(12,2) | NOT NULL | 小计（= actual_price × quantity，自动计算） |
| sort_order | INT | DEFAULT 0 | 排序号（控制明细在PDF中的显示顺序） |
| item_note | VARCHAR(500) | NULL | 明细备注（如："赠送安装服务"） |
| **审计字段** | | | |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (item_id)
- INDEX (quotation_id)
- INDEX (product_id)

**约束**：
- FOREIGN KEY (quotation_id) REFERENCES quotation(quotation_id) ON DELETE CASCADE
- FOREIGN KEY (product_id) REFERENCES product(product_id) ON DELETE RESTRICT
- CHECK (quantity > 0)
- CHECK (standard_price >= 0)
- CHECK (actual_price >= 0)
- CHECK (discount_amount >= 0)
- CHECK (discount_rate >= 0 AND discount_rate <= 100)
- CHECK (subtotal >= 0)

**业务规则**：
1. 创建明细时，自动从product表读取并填充以下字段：
   - product_code = product.product_code
   - product_name = product.product_name
   - product_unit = product.unit
   - standard_price = product.sale_price（当前时刻的产品报价）
   - actual_price = product.sale_price（默认与标准价相同，销售可修改）
2. 销售修改actual_price后，系统自动计算：
   - discount_amount = (standard_price - actual_price) × quantity
   - discount_rate = (standard_price - actual_price) / standard_price × 100%
   - subtotal = actual_price × quantity
3. 产品信息冗余存储（product_code、product_name、product_unit）：
   - 保证历史报价单不受产品表变更影响
   - 即使产品被停售或删除，历史报价单仍可正常显示
4. 删除报价单时，自动删除所有明细（ON DELETE CASCADE）
5. 产品被报价单引用后，不允许物理删除（ON DELETE RESTRICT）
6. 明细的数量（quantity）必须大于0
7. 折扣率允许为0（表示无折扣），但不能为负数或超过100%
8. sort_order用于控制PDF生成时产品的显示顺序，默认按创建顺序排列
9. 报价单状态为sent后，不允许新增/修改/删除明细（业务逻辑层校验）

**计算逻辑示例**：
```
产品：自助入住机A100
标准报价（standard_price）：1200元/台
数量（quantity）：10台
销售调整实际价格（actual_price）：1000元/台

自动计算：
discount_amount = (1200 - 1000) × 10 = 2000元
discount_rate = (1200 - 1000) / 1200 × 100% = 16.67%
subtotal = 1000 × 10 = 10000元
```

**报价单总金额汇总计算**（quotation表字段）：
```sql
-- 报价单总金额（total_amount）
SELECT SUM(subtotal) FROM quotation_item WHERE quotation_id = ?

-- 总优惠金额（discount_total）
SELECT SUM(discount_amount) FROM quotation_item WHERE quotation_id = ?
```

---

### 7.5 合同实体

#### 7.5.1 合同主表（contract）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| contract_id | BIGINT | PK, AUTO_INCREMENT | 合同ID |
| contract_no | VARCHAR(100) | NOT NULL, UNIQUE | 合同编号（自动生成，如：CONTRACT-20251223-001） |
| contract_title | VARCHAR(200) | NOT NULL | 合同标题（如："XX酒店智能硬件采购合同"） |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（外键关联customer表） |
| customer_contact_id | BIGINT | NULL, FK | 客户联系人ID（外键关联customer_contact表） |
| status | VARCHAR(20) | NOT NULL | 合同状态（draft=草稿，under_review=待审核，approved=已批准，signed=已签订，executing=执行中，completed=已完成，terminated=已终止） |
| contract_amount | DECIMAL(12,2) | NOT NULL | 合同总金额（从明细表汇总计算，不可手动修改） |
| **条款字段** | | | |
| payment_terms | JSON | NULL | 付款条款（JSON格式，支持多期付款）<br>示例：[{"stage":"签订后","percentage":30,"amount":30000,"due_date":"2025-01-10"},{"stage":"发货前","percentage":70,"amount":70000,"due_date":"2025-02-15"}] |
| delivery_terms | TEXT | NULL | 交付条款（文本格式，如："款到15个工作日内发货，物流方式为德邦物流，运费由供方承担"） |
| warranty_terms | JSON | NULL | 质保条款（JSON格式）<br>示例：{"warranty_period_months":12,"warranty_scope":"硬件质量问题免费维修","response_time_hours":24,"warranty_start_date":"2025-03-01"} |
| penalty_terms | TEXT | NULL | 违约条款（文本格式，如："延期交付每日赔偿合同金额的0.5%，累计不超过10%"） |
| additional_terms | TEXT | NULL | 补充条款（文本格式，记录其他特殊约定） |
| **日期字段** | | | |
| signed_date | DATE | NULL | 合同签订日期（状态变为signed时必填） |
| delivery_deadline | DATE | NULL | 交付期限（约定的最晚交付日期） |
| actual_delivery_date | DATE | NULL | 实际交付日期（所有产品发货完成后记录，可触发质保期开始） |
| warranty_start_date | DATE | NULL | 质保期开始日期（默认=actual_delivery_date，可手动调整） |
| warranty_end_date | DATE | NULL | 质保期结束日期（自动计算 = warranty_start_date + warranty_period_months） |
| **执行进度字段（冗余统计）** | | | |
| shipped_amount | DECIMAL(12,2) | DEFAULT 0.00 | 已发货金额（从shipment表关联统计，自动更新） |
| received_amount | DECIMAL(12,2) | DEFAULT 0.00 | 已收款金额（从payment表关联统计，自动更新） |
| invoiced_amount | DECIMAL(12,2) | DEFAULT 0.00 | 已开票金额（从invoice表关联统计，自动更新） |
| execution_progress | DECIMAL(5,2) | DEFAULT 0.00 | 执行进度百分比（自动计算 = MIN(shipped_amount, received_amount, invoiced_amount) / contract_amount × 100%） |
| **文件管理字段** | | | |
| contract_file_url | VARCHAR(500) | NULL | 合同文件URL（电子合同扫描件或PDF，存储在对象存储） |
| contract_file_uploaded_at | DATETIME | NULL | 合同文件上传时间 |
| contract_file_version | INT | DEFAULT 1 | 合同文件版本号（支持重新上传覆盖，递增） |
| **关联字段** | | | |
| source_quotation_id | BIGINT | NULL, FK | 来源报价单ID（从报价单转化时记录，双向关联quotation.related_contract_id） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NOT NULL, FK | 负责人ID（关联用户表，通常为销售人员或合同管理员，继承自客户/报价单） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| signed_by | BIGINT | NULL, FK | 签订确认人ID（关联用户表，状态变为signed时记录） |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (contract_id)
- UNIQUE KEY (contract_no)
- INDEX (customer_id)
- INDEX (status)
- INDEX (owner_id)
- INDEX (signed_date)
- INDEX (delivery_deadline)
- INDEX (warranty_end_date)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_contact_id) REFERENCES customer_contact(contact_id) ON DELETE SET NULL
- FOREIGN KEY (source_quotation_id) REFERENCES quotation(quotation_id) ON DELETE RESTRICT
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- FOREIGN KEY (signed_by) REFERENCES user(user_id)
- CHECK (contract_amount >= 0)
- CHECK (shipped_amount >= 0 AND shipped_amount <= contract_amount)
- CHECK (received_amount >= 0 AND received_amount <= contract_amount)
- CHECK (invoiced_amount >= 0 AND invoiced_amount <= contract_amount)
- CHECK (execution_progress >= 0 AND execution_progress <= 100)
- CHECK (signed_date >= DATE(created_at))
- CHECK (delivery_deadline IS NULL OR delivery_deadline >= signed_date)
- CHECK (actual_delivery_date IS NULL OR actual_delivery_date >= signed_date)
- CHECK (warranty_end_date IS NULL OR warranty_end_date > warranty_start_date)

**生命周期（status）**：
1. **草稿（draft）**：合同编辑中，未提交审核，可随时修改产品和条款
2. **待审核（under_review）**：已提交审核，等待审批（v1.0跳过此状态，预留v2.0启用）
3. **已批准（approved）**：审批通过，等待签订（v1.0跳过此状态，预留v2.0启用）
4. **已签订（signed）**：双方签订完成，等待执行（已上传合同文件，记录signed_date）
5. **执行中（executing）**：合同执行过程中（已开始发货/收款/开票，execution_progress > 0）
6. **已完成（completed）**：合同全部履行完毕（所有产品已发货、款项已收齐、发票已开具）
7. **已终止（terminated）**：合同提前终止（客户取消、违约等原因）

**状态流转规则**：
```
draft（草稿）
  ↓ [提交审核] → under_review（待审核，v2.0启用）
  ↓ [直接签订，v1.0] → signed（已签订）
  ↓ [删除] → deleted_at有值

under_review（待审核，v2.0）
  ↓ [审批通过] → approved（已批准）
  ↓ [审批拒绝] → draft（草稿）

approved（已批准，v2.0）
  ↓ [上传合同文件，签订确认] → signed（已签订）

signed（已签订）
  ↓ [首次发货/收款/开票] → executing（执行中）
  ↓ [客户取消/违约] → terminated（已终止）

executing（执行中）
  ↓ [执行进度=100%] → completed（已完成）
  ↓ [客户取消/违约] → terminated（已终止）

completed/terminated → 终态，不再变更
```

**业务规则**：
1. 合同编号自动生成，建议格式：CONTRACT-YYYYMMDD-流水号（如：CONTRACT-20251223-001）
2. 创建合同时：
   - contract_title默认为"{客户名称}智能硬件采购合同"，可手动修改
   - owner_id默认继承客户的owner_id或报价单的owner_id
   - status默认为draft
   - 如果从报价单转化，自动填充：
     - source_quotation_id = 报价单ID
     - customer_id、customer_contact_id继承自报价单
     - payment_terms、delivery_terms继承自报价单（可修改）
     - 产品明细从quotation_item复制到contract_item
3. 合同状态为draft时，允许编辑所有字段（包括产品明细、条款）
4. 合同状态变为signed后：
   - 产品明细不允许修改，如需变更需创建补充协议（contract_amendment表）
   - 条款字段不允许修改，如需变更需创建补充协议
   - signed_date必填，contract_file_url必填
   - 自动更新quotation.related_contract_id（如果来源于报价单）
5. 付款条款（payment_terms）JSON结构：
   - stage（文本）：付款阶段描述（如："签订后"、"发货前"、"验收后"）
   - percentage（数字）：付款比例（如：30表示30%）
   - amount（数字）：付款金额（自动计算 = contract_amount × percentage / 100）
   - due_date（日期）：应付日期（可选）
   - 所有期数的percentage之和必须=100%
6. 质保条款（warranty_terms）JSON结构：
   - warranty_period_months（数字）：质保期月数（如：12表示12个月）
   - warranty_scope（文本）：质保范围描述
   - response_time_hours（数字）：响应时间（小时）
   - warranty_start_date（日期）：质保期开始日期（默认=actual_delivery_date，可手动调整）
7. 执行进度自动更新规则：
   - 发货管理模块创建发货单时，自动更新shipped_amount（累加发货金额）
   - 收款管理模块创建收款记录时，自动更新received_amount（累加收款金额）
   - 发票管理模块创建发票时，自动更新invoiced_amount（累加开票金额）
   - execution_progress自动计算：MIN(shipped_amount, received_amount, invoiced_amount) / contract_amount × 100%
   - 当execution_progress=100%且三者都=contract_amount时，系统提示可将状态改为completed
8. 状态自动流转规则：
   - signed → executing：当shipped_amount > 0 或 received_amount > 0 或 invoiced_amount > 0时，自动流转
   - executing → completed：需手动确认（系统提示：所有交付完成，是否标记为已完成？）
9. 合同提醒任务生成规则：
   - 交付期限前7天：生成待办任务"合同{contract_no}交付期限临近，请确保按时发货"
   - 交付期限已过且actual_delivery_date为空：生成待办任务"合同{contract_no}已逾期，请尽快处理"
   - 付款条款到期前3天：生成待办任务"合同{contract_no}应收款到期，请跟进收款"
   - 质保期到期前30天：生成待办任务"合同{contract_no}质保期即将到期"
10. 合同产品明细不能为空，至少包含1个产品（业务逻辑校验）
11. contract_amount由系统自动从contract_item表汇总计算，不允许手动修改
12. 合同被发货单/收款单/发票引用后（关联记录存在），不允许删除，仅可标记为terminated
13. 创建合同时客户阶段提示：
    - 推荐客户阶段为negotiation（商务洽谈）或contract（合同签订）
    - 其他阶段创建时给出提示："建议先将客户推进至商务洽谈或合同签订阶段"，但不强制阻止
14. 质保期结束日期自动计算：warranty_end_date = DATE_ADD(warranty_start_date, INTERVAL warranty_period_months MONTH)

---

#### 7.5.2 合同明细表（contract_item）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| item_id | BIGINT | PK, AUTO_INCREMENT | 明细ID |
| contract_id | BIGINT | NOT NULL, FK | 合同ID（外键关联contract） |
| product_id | BIGINT | NOT NULL, FK | 产品ID（外键关联product） |
| product_code | VARCHAR(100) | NOT NULL | 产品编码（冗余字段，快照保存） |
| product_name | VARCHAR(200) | NOT NULL | 产品名称（冗余字段，快照保存） |
| product_unit | VARCHAR(20) | NOT NULL | 单位（冗余字段，如：台、个、套） |
| quantity | DECIMAL(10,2) | NOT NULL | 数量 |
| unit_price | DECIMAL(12,2) | NOT NULL | 单价（签订时确定的最终价格） |
| subtotal | DECIMAL(12,2) | NOT NULL | 小计（= unit_price × quantity，自动计算） |
| sort_order | INT | DEFAULT 0 | 排序号（控制显示顺序） |
| item_note | VARCHAR(500) | NULL | 明细备注（如："含安装调试服务"） |
| **执行进度字段（冗余统计）** | | | |
| shipped_quantity | DECIMAL(10,2) | DEFAULT 0.00 | 已发货数量（从shipment_item表关联统计） |
| **审计字段** | | | |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (item_id)
- INDEX (contract_id)
- INDEX (product_id)

**约束**：
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE CASCADE
- FOREIGN KEY (product_id) REFERENCES product(product_id) ON DELETE RESTRICT
- CHECK (quantity > 0)
- CHECK (unit_price >= 0)
- CHECK (subtotal >= 0)
- CHECK (shipped_quantity >= 0 AND shipped_quantity <= quantity)

**业务规则**：
1. 从报价单转化创建合同时，自动从quotation_item复制数据：
   - product_id、product_code、product_name、product_unit直接复制
   - unit_price = quotation_item.actual_price（采用报价单的实际销售价格）
   - quantity = quotation_item.quantity（可在合同签订前手动调整）
   - subtotal = unit_price × quantity（自动计算）
2. 手动创建合同时，从product表读取并填充product_code、product_name、product_unit、unit_price（默认=sale_price）
3. 产品信息冗余存储（product_code、product_name、product_unit）：
   - 保证历史合同不受产品表变更影响
   - 即使产品被停售或删除，历史合同仍可正常显示
4. 删除合同时，自动删除所有明细（ON DELETE CASCADE）
5. 产品被合同引用后，不允许物理删除（ON DELETE RESTRICT）
6. 明细的数量（quantity）必须大于0
7. sort_order用于控制合同文件中产品的显示顺序，默认按创建顺序排列
8. 合同状态为signed后，不允许新增/修改/删除明细（业务逻辑层校验），如需变更需创建补充协议
9. shipped_quantity由发货模块自动更新（累加），当shipped_quantity = quantity时，该产品已全部发货

**合同总金额汇总计算**（contract表字段）：
```sql
-- 合同总金额（contract_amount）
SELECT SUM(subtotal) FROM contract_item WHERE contract_id = ?
```

---

#### 7.5.3 合同补充协议表（contract_amendment）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| amendment_id | BIGINT | PK, AUTO_INCREMENT | 补充协议ID |
| amendment_no | VARCHAR(100) | NOT NULL, UNIQUE | 补充协议编号（自动生成，如：AMEND-20251223-001） |
| contract_id | BIGINT | NOT NULL, FK | 原合同ID（外键关联contract） |
| amendment_type | VARCHAR(50) | NOT NULL | 变更类型（product_change=产品变更，amount_change=金额变更，term_change=条款变更，deadline_change=期限变更，other=其他） |
| amendment_title | VARCHAR(200) | NOT NULL | 补充协议标题（如："XX酒店采购合同补充协议（增加产品）"） |
| amendment_content | TEXT | NOT NULL | 变更内容说明（详细描述变更事项） |
| amount_change | DECIMAL(12,2) | DEFAULT 0.00 | 金额变化（正数=增加，负数=减少，如：+5000表示增加5000元） |
| new_contract_amount | DECIMAL(12,2) | NULL | 变更后的合同总金额（= 原合同金额 + amount_change） |
| signed_date | DATE | NULL | 补充协议签订日期 |
| amendment_file_url | VARCHAR(500) | NULL | 补充协议文件URL（电子文件存储路径） |
| status | VARCHAR(20) | NOT NULL | 状态（draft=草稿，signed=已签订，cancelled=已取消） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (amendment_id)
- UNIQUE KEY (amendment_no)
- INDEX (contract_id)
- INDEX (status)
- INDEX (created_at)

**约束**：
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE RESTRICT
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- CHECK (new_contract_amount IS NULL OR new_contract_amount >= 0)

**业务规则**：
1. 补充协议编号自动生成，建议格式：AMEND-YYYYMMDD-流水号（如：AMEND-20251223-001）
2. 补充协议必须关联有效的原合同（状态为signed/executing/completed）
3. 补充协议状态为signed后：
   - 如果amount_change != 0，同步更新contract.contract_amount = new_contract_amount
   - 如果涉及产品变更，需要同步更新contract_item表（新增/修改/删除明细）
   - 如果涉及条款变更，需要同步更新contract表的相关条款字段
   - 如果涉及期限变更，需要同步更新contract.delivery_deadline或warranty_end_date
4. 补充协议类型说明：
   - product_change：产品数量调整、新增产品、删除产品
   - amount_change：仅金额变化（如：额外优惠、违约赔偿）
   - term_change：付款条款、交付条款、质保条款、违约条款变更
   - deadline_change：交付期限延期、质保期延长
   - other：其他未分类的变更
5. amount_change字段：
   - 正数表示合同金额增加（如：新增产品）
   - 负数表示合同金额减少（如：客户违约扣款）
   - 如果仅修改条款/期限不涉及金额，amount_change = 0
6. new_contract_amount字段：
   - 仅当amount_change != 0时填写
   - 自动计算：new_contract_amount = 原contract.contract_amount + amount_change
   - 补充协议签订后，同步更新contract.contract_amount = new_contract_amount
7. 补充协议可以被取消（status = cancelled），取消后不影响原合同
8. 一个合同可以有多个补充协议，按创建时间顺序依次生效
9. 补充协议的变更内容需在amendment_content字段详细记录，作为法律依据
10. 补充协议签订日期必须≥原合同签订日期

---

### 7.6 待办任务实体

#### 7.6.1 任务表（task）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| task_id | BIGINT | PK, AUTO_INCREMENT | 任务ID |
| task_type | VARCHAR(50) | NOT NULL | 任务类型（lead_follow_up=线索跟进提醒，quotation_expiring=报价单即将过期，quotation_expired=报价单已过期，contract_delivery_upcoming=合同交付临近，contract_delivery_overdue=合同交付逾期，contract_payment_due=合同付款到期，contract_payment_overdue=合同付款逾期，contract_warranty_expiring=合同质保到期提醒，custom=自定义任务） |
| task_title | VARCHAR(200) | NOT NULL | 任务标题（如："跟进客户XX"、"报价单QUOTE-001即将过期"、"合同CONTRACT-001交付期临近"） |
| task_description | TEXT | NULL | 任务描述（详细说明任务内容） |
| priority | VARCHAR(20) | DEFAULT 'medium' | 优先级（high=高，medium=中，low=低） |
| status | VARCHAR(20) | NOT NULL | 任务状态（pending=待处理，in_progress=处理中，completed=已完成，cancelled=已取消，overdue=已逾期） |
| **关联业务对象字段（多态关联）** | | | |
| source_type | VARCHAR(50) | NULL | 源业务对象类型（customer=客户/线索，quotation=报价单，contract=合同，NULL=自定义任务） |
| source_id | BIGINT | NULL | 源业务对象ID（对应customer_id/quotation_id/contract_id，NULL=自定义任务） |
| unique_key | VARCHAR(200) | UNIQUE | 防重键（source_type + source_id + task_type + 关键日期的组合，如："customer_123_lead_follow_up_20251225"，确保同一业务事件不重复生成任务） |
| **任务时间字段** | | | |
| due_date | DATE | NULL | 截止日期 |
| due_time | TIME | NULL | 截止时间（预留，v1.0默认NULL） |
| reminder_time | DATETIME | NULL | 提前提醒时间（如：截止前1小时提醒，预留v2.0使用） |
| **任务分配字段** | | | |
| assignee_id | BIGINT | NOT NULL, FK | 任务负责人ID（关联用户表） |
| assigner_id | BIGINT | NULL, FK | 任务分配人ID（自动生成任务时为NULL，手动创建时记录创建人） |
| assigned_at | DATETIME | NULL | 任务分配时间 |
| **任务执行字段** | | | |
| started_at | DATETIME | NULL | 任务开始处理时间（状态变为in_progress时记录） |
| completed_at | DATETIME | NULL | 任务完成时间（状态变为completed时记录） |
| cancelled_at | DATETIME | NULL | 任务取消时间（状态变为cancelled时记录） |
| cancel_reason | VARCHAR(500) | NULL | 取消原因（如："客户已流失"、"报价单已转合同"） |
| result_note | TEXT | NULL | 任务处理结果备注 |
| **提醒通知字段** | | | |
| is_notified | TINYINT | DEFAULT 0 | 是否已发送提醒通知（1=已发送，0=未发送） |
| notified_at | DATETIME | NULL | 提醒发送时间 |
| notification_channels | JSON | NULL | 提醒渠道记录（JSON格式，如：["system","email","wechat"]，v1.0仅支持system） |
| **审计字段** | | | |
| created_by | BIGINT | NULL, FK | 创建人ID（自动生成任务时为NULL或系统用户ID，手动创建时记录创建人） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (task_id)
- UNIQUE KEY (unique_key)
- INDEX (task_type)
- INDEX (status)
- INDEX (assignee_id)
- INDEX (due_date)
- INDEX (source_type, source_id)
- INDEX (priority)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (assignee_id) REFERENCES user(user_id) ON DELETE RESTRICT
- FOREIGN KEY (assigner_id) REFERENCES user(user_id) ON DELETE SET NULL
- FOREIGN KEY (created_by) REFERENCES user(user_id) ON DELETE SET NULL
- FOREIGN KEY (updated_by) REFERENCES user(user_id) ON DELETE SET NULL
- CHECK (priority IN ('high', 'medium', 'low'))
- CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled', 'overdue'))

**生命周期（status）**：
1. **待处理（pending）**：任务创建后的初始状态，等待负责人处理
2. **处理中（in_progress）**：负责人开始处理任务
3. **已完成（completed）**：任务已完成
4. **已取消（cancelled）**：任务被取消（如业务对象状态变更导致任务失效）
5. **已逾期（overdue）**：任务超过截止时间未完成（定时任务自动标记）

**状态流转规则**：
```
pending（待处理）
  ↓ [负责人开始处理] → in_progress（处理中）
  ↓ [直接完成] → completed（已完成）
  ↓ [取消任务] → cancelled（已取消）
  ↓ [超过due_date且status=pending] → overdue（已逾期）

in_progress（处理中）
  ↓ [完成任务] → completed（已完成）
  ↓ [取消任务] → cancelled（已取消）
  ↓ [超过due_date且status=in_progress] → overdue（已逾期）

overdue（已逾期）
  ↓ [完成任务] → completed（已完成）
  ↓ [取消任务] → cancelled（已取消）

completed（已完成）
  终态，不可再变更

cancelled（已取消）
  终态，不可再变更
```

**业务规则说明**：

1. **任务类型与自动生成规则**：
   - **lead_follow_up（线索跟进提醒）**：
     - 触发条件：customer_follow_up表插入新记录且next_follow_up_time不为空
     - 任务标题：跟进客户【客户名称】
     - 任务描述：下次跟进内容：【next_follow_up_content】
     - 截止日期：next_follow_up_time的日期
     - 负责人：跟进记录的创建人（creator_id）
     - unique_key：customer_{customer_id}_lead_follow_up_{next_follow_up_time}

   - **quotation_expiring（报价单即将过期）**：
     - 触发条件：定时任务每日检查quotation表，valid_until - CURRENT_DATE = 3天且状态为sent
     - 任务标题：报价单【quotation_no】即将过期
     - 任务描述：报价单【quotation_title】将于【valid_until】过期，请及时跟进客户
     - 截止日期：valid_until - 3天
     - 负责人：报价单负责人（owner_id）
     - unique_key：quotation_{quotation_id}_expiring_{valid_until}

   - **quotation_expired（报价单已过期）**：
     - 触发条件：定时任务每日检查quotation表，valid_until < CURRENT_DATE且状态为sent
     - 任务标题：报价单【quotation_no】已过期
     - 任务描述：报价单【quotation_title】已于【valid_until】过期，请联系客户确认是否需要延期或重新报价
     - 截止日期：valid_until当天
     - 负责人：报价单负责人（owner_id）
     - unique_key：quotation_{quotation_id}_expired_{valid_until}

   - **contract_delivery_upcoming（合同交付临近）**：
     - 触发条件：定时任务每日检查contract表，delivery_deadline - CURRENT_DATE = 7天且状态为signed/executing
     - 任务标题：合同【contract_no】交付期临近
     - 任务描述：合同【contract_title】交付期限为【delivery_deadline】，请安排发货
     - 截止日期：delivery_deadline - 7天
     - 负责人：合同负责人（owner_id）
     - unique_key：contract_{contract_id}_delivery_upcoming_{delivery_deadline}

   - **contract_delivery_overdue（合同交付逾期）**：
     - 触发条件：定时任务每日检查contract表，delivery_deadline < CURRENT_DATE且actual_delivery_date为空且状态为signed/executing
     - 任务标题：合同【contract_no】交付已逾期
     - 任务描述：合同【contract_title】交付期限为【delivery_deadline】，当前已逾期，请紧急处理
     - 截止日期：delivery_deadline当天
     - 负责人：合同负责人（owner_id）
     - 优先级：high
     - unique_key：contract_{contract_id}_delivery_overdue_{delivery_deadline}

   - **contract_payment_due（合同付款到期）**：
     - 触发条件：定时任务每日检查contract表的payment_terms JSON，遍历每期付款，due_date - CURRENT_DATE = 3天且已收款金额<应收款金额
     - 任务标题：合同【contract_no】第X期付款到期
     - 任务描述：合同【contract_title】第X期付款（应收【amount】元）将于【due_date】到期，当前已收款【received_amount】元
     - 截止日期：due_date - 3天
     - 负责人：合同负责人（owner_id）
     - unique_key：contract_{contract_id}_payment_due_{stage}_{due_date}

   - **contract_payment_overdue（合同付款逾期）**：
     - 触发条件：定时任务每日检查contract表的payment_terms JSON，遍历每期付款，due_date < CURRENT_DATE且已收款金额<应收款金额
     - 任务标题：合同【contract_no】第X期付款已逾期
     - 任务描述：合同【contract_title】第X期付款（应收【amount】元）已于【due_date】逾期，当前已收款【received_amount】元，请紧急催款
     - 截止日期：due_date当天
     - 负责人：合同负责人（owner_id）
     - 优先级：high
     - unique_key：contract_{contract_id}_payment_overdue_{stage}_{due_date}

   - **contract_warranty_expiring（合同质保到期提醒）**：
     - 触发条件：定时任务每日检查contract表，warranty_end_date - CURRENT_DATE = 30天且状态为executing/completed
     - 任务标题：合同【contract_no】质保期即将到期
     - 任务描述：合同【contract_title】质保期将于【warranty_end_date】到期，请联系客户确认是否需要延保服务
     - 截止日期：warranty_end_date - 30天
     - 负责人：合同负责人（owner_id）
     - unique_key：contract_{contract_id}_warranty_expiring_{warranty_end_date}

   - **custom（自定义任务）**：
     - 触发条件：用户手动创建
     - 任务标题/描述/截止日期/负责人：由用户手动填写
     - source_type和source_id：可选关联业务对象
     - unique_key：NULL（不参与防重）

2. **unique_key防重机制**：
   - 自动生成任务时，根据source_type、source_id、task_type、关键日期组合生成unique_key
   - 插入任务前检查unique_key是否已存在，存在则跳过生成（幂等性保证）
   - 手动创建的custom任务不参与防重，unique_key为NULL

3. **任务自动取消规则**：
   - 当源业务对象状态变更导致任务失效时，自动标记任务为cancelled：
     - 客户/线索状态变为inactive/lost，取消关联的所有pending/in_progress任务
     - 报价单状态变为accepted/rejected/superseded，取消关联的quotation_expiring/quotation_expired任务
     - 合同actual_delivery_date填写，取消关联的contract_delivery_upcoming/contract_delivery_overdue任务
     - 合同received_amount达到应收金额，取消关联的contract_payment_due/contract_payment_overdue任务

4. **任务逾期自动标记**：
   - 定时任务每日检查task表，status为pending或in_progress且due_date < CURRENT_DATE，自动更新status为overdue

5. **任务负责人变更规则**：
   - 当源业务对象的owner_id变更时（如线索转移、合同负责人调整），关联的pending任务自动更新assignee_id

6. **提醒通知规则（v1.0范围）**：
   - 系统内提醒：用户登录后显示待办任务计数徽章，点击进入任务列表
   - 逾期任务突出显示：优先级自动提升为high，任务列表中红色标记
   - 邮件/微信提醒：预留字段notification_channels，v2.0实现

---

#### 7.6.2 任务模板表（task_template）（预留v2.0）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| template_id | BIGINT | PK, AUTO_INCREMENT | 模板ID |
| template_name | VARCHAR(100) | NOT NULL | 模板名称（如："线索跟进标准流程"、"合同交付提醒"） |
| template_type | VARCHAR(50) | NOT NULL | 模板类型（对应task.task_type） |
| task_title_template | VARCHAR(200) | NOT NULL | 任务标题模板（支持变量替换，如："跟进客户【{customer_name}】"） |
| task_description_template | TEXT | NULL | 任务描述模板（支持变量替换） |
| default_priority | VARCHAR(20) | DEFAULT 'medium' | 默认优先级 |
| default_due_days | INT | NULL | 默认截止天数（相对于触发日期，如：3表示触发后3天截止） |
| is_active | TINYINT | DEFAULT 1 | 是否启用（1=启用，0=停用） |
| created_by | BIGINT | NOT NULL, FK | 创建人ID |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (template_id)
- INDEX (template_type)
- INDEX (is_active)

**说明**：
- v1.0阶段任务生成规则硬编码在代码中，不使用此表
- v2.0支持前端配置任务模板，灵活调整任务生成规则

---

#### 7.6.3 任务提醒记录表（task_notification）（预留v2.0）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| notification_id | BIGINT | PK, AUTO_INCREMENT | 提醒记录ID |
| task_id | BIGINT | NOT NULL, FK | 任务ID（关联task表） |
| notification_channel | VARCHAR(20) | NOT NULL | 提醒渠道（system=系统内，email=邮件，wechat=微信，sms=短信） |
| recipient_user_id | BIGINT | NOT NULL, FK | 接收人ID |
| notification_title | VARCHAR(200) | NOT NULL | 提醒标题 |
| notification_content | TEXT | NULL | 提醒内容 |
| sent_at | DATETIME | NOT NULL | 发送时间 |
| is_read | TINYINT | DEFAULT 0 | 是否已读（1=已读，0=未读，仅system渠道使用） |
| read_at | DATETIME | NULL | 阅读时间 |
| send_status | VARCHAR(20) | NOT NULL | 发送状态（success=成功，failed=失败，pending=待发送） |
| error_message | VARCHAR(500) | NULL | 失败错误信息 |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**：
- PRIMARY KEY (notification_id)
- INDEX (task_id)
- INDEX (recipient_user_id)
- INDEX (notification_channel)
- INDEX (is_read)
- INDEX (sent_at)

**约束**：
- FOREIGN KEY (task_id) REFERENCES task(task_id) ON DELETE CASCADE
- FOREIGN KEY (recipient_user_id) REFERENCES user(user_id) ON DELETE CASCADE

**说明**：
- v1.0阶段仅支持系统内提醒（notification_channel=system），直接查询task表即可
- v2.0支持邮件/微信提醒，需记录提醒发送历史和发送状态
- v2.0支持提醒已读/未读状态管理

---

### 7.7 发货管理实体

#### 7.7.1 发货单主表（shipment）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| shipment_id | BIGINT | PK, AUTO_INCREMENT | 发货单ID |
| shipment_no | VARCHAR(100) | NOT NULL, UNIQUE | 发货单编号（自动生成，如：SHIP-20251223-001） |
| shipment_title | VARCHAR(200) | NOT NULL | 发货单标题（如："XX酒店智能硬件采购合同第1批发货"） |
| contract_id | BIGINT | NOT NULL, FK | 合同ID（外键关联contract表，发货单必须基于已签订合同创建） |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（冗余字段，从合同继承，便于查询和统计） |
| status | VARCHAR(20) | NOT NULL | 发货状态（draft=草稿，pending=待发货，shipped=已发货，in_transit=运输中，delivered=已签收，cancelled=已取消） |
| **物流信息字段** | | | |
| logistics_company | VARCHAR(100) | NULL | 物流公司（如：德邦物流、顺丰速运，状态为shipped时必填） |
| tracking_no | VARCHAR(100) | NULL | 运单号（状态为shipped时必填） |
| shipping_address | TEXT | NULL | 收货地址（从客户信息继承，可修改） |
| contact_person | VARCHAR(100) | NULL | 收货联系人姓名 |
| contact_phone | VARCHAR(50) | NULL | 收货联系人电话 |
| **日期字段** | | | |
| planned_ship_date | DATE | NULL | 计划发货日期（业务规划发货时间，用于逾期提醒） |
| actual_ship_date | DATE | NULL | 实际发货日期（状态变为shipped时必填） |
| estimated_delivery_date | DATE | NULL | 预计到货日期（可选，默认 = actual_ship_date + 3天） |
| actual_delivery_date | DATE | NULL | 实际签收日期（状态变为delivered时必填） |
| **金额字段（冗余统计）** | | | |
| shipment_amount | DECIMAL(12,2) | NOT NULL | 本次发货金额（从明细表汇总计算，自动更新） |
| **备注字段** | | | |
| notes | TEXT | NULL | 发货备注（如：易碎品请小心搬运、需客户签字确认等） |
| cancel_reason | VARCHAR(500) | NULL | 取消原因（状态为cancelled时必填） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NOT NULL, FK | 负责人ID（关联用户表，通常为运营人员或合同负责人，继承自合同owner_id） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| shipped_by | BIGINT | NULL, FK | 发货确认人ID（状态变为shipped时记录） |
| shipped_at | DATETIME | NULL | 发货确认时间（状态变为shipped时记录） |
| delivered_by | BIGINT | NULL, FK | 签收确认人ID（状态变为delivered时记录） |
| delivered_at | DATETIME | NULL | 签收确认时间（状态变为delivered时记录） |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (shipment_id)
- UNIQUE KEY (shipment_no)
- INDEX (contract_id)
- INDEX (customer_id)
- INDEX (status)
- INDEX (owner_id)
- INDEX (planned_ship_date)
- INDEX (actual_ship_date)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- FOREIGN KEY (shipped_by) REFERENCES user(user_id)
- FOREIGN KEY (delivered_by) REFERENCES user(user_id)
- CHECK (shipment_amount >= 0)
- CHECK (actual_ship_date IS NULL OR planned_ship_date IS NULL OR actual_ship_date >= planned_ship_date OR status='cancelled')
- CHECK (estimated_delivery_date IS NULL OR actual_ship_date IS NULL OR estimated_delivery_date >= actual_ship_date)
- CHECK (actual_delivery_date IS NULL OR actual_ship_date IS NULL OR actual_delivery_date >= actual_ship_date)

**生命周期（status）**：
1. **草稿（draft）**：发货单编辑中，未确认发货，可随时修改产品明细和数量
2. **待发货（pending）**：发货单已确认，等待实际发货（已填写计划发货日期，准备发货）
3. **已发货（shipped）**：已实际发货，物流信息已填写，货物在途
4. **运输中（in_transit）**：物流已揽收，货物运输中（v1.0可选，v2.0对接物流API后自动更新）
5. **已签收（delivered）**：客户已签收，交付完成
6. **已取消（cancelled）**：发货单取消（如客户要求推迟、合同取消等）

**状态流转规则**：
```
draft（草稿）
  ↓ [确认待发货] → pending（待发货）
  ↓ [直接发货] → shipped（已发货）
  ↓ [取消] → cancelled（已取消）

pending（待发货）
  ↓ [确认发货，填写物流信息] → shipped（已发货）
  ↓ [取消] → cancelled（已取消）

shipped（已发货）
  ↓ [物流API更新，v2.0] → in_transit（运输中）
  ↓ [直接签收确认] → delivered（已签收）

in_transit（运输中）
  ↓ [签收确认] → delivered（已签收）

delivered（已签收）
  终态，不再变更

cancelled（已取消）
  终态，不再变更
```

**业务规则**：
1. 发货单编号自动生成，建议格式：SHIP-YYYYMMDD-流水号（如：SHIP-20251223-001）
2. 创建发货单时：
   - shipment_title默认为"{合同标题}第X批发货"（X为该合同的发货批次号），可手动修改
   - owner_id默认继承合同的owner_id（负责人）
   - customer_id、shipping_address、contact_person、contact_phone默认继承自合同关联的客户信息，可修改
   - status默认为draft
   - 仅状态为signed/executing的合同可创建发货单
3. 发货单状态为draft时，允许编辑所有字段（包括产品明细、数量）
4. 发货单状态变为pending时：
   - planned_ship_date必填
   - 发货产品明细不能为空（至少包含1个产品）
5. 发货单状态变为shipped时：
   - logistics_company必填（物流公司名称）
   - tracking_no必填（运单号）
   - actual_ship_date必填（实际发货日期）
   - estimated_delivery_date可选（默认 = actual_ship_date + 3天，系统参数可配置）
   - 自动更新合同执行进度：
     - 遍历发货单明细，更新contract_item.shipped_quantity += this_shipment_quantity
     - 更新contract.shipped_amount += shipment_amount
     - 检查合同所有产品是否全部发货完成（所有contract_item.shipped_quantity = quantity），若是，更新contract.actual_delivery_date = actual_ship_date
     - 若合同状态为signed，自动流转为executing（首次发货触发）
6. 发货单状态变为cancelled时：
   - cancel_reason必填
   - 如果之前状态为shipped/in_transit/delivered，需回退合同执行进度：
     - 遍历发货单明细，更新contract_item.shipped_quantity -= this_shipment_quantity
     - 更新contract.shipped_amount -= shipment_amount
     - 如果合同的actual_delivery_date来源于本发货单，清空contract.actual_delivery_date
7. 发货单状态变为delivered时：
   - actual_delivery_date必填（实际签收日期）
   - 记录delivered_by（签收确认人）和delivered_at（签收确认时间）
8. 物流信息修改规则：
   - 发货单状态为shipped/in_transit时，允许修改logistics_company、tracking_no、estimated_delivery_date（应对物流公司更换或运单号错误）
   - 修改物流信息时，记录操作日志（审计追溯）
9. 发货数量校验规则：
   - 每个产品的发货数量：this_shipment_quantity <= contract_item.quantity - contract_item.shipped_quantity
   - 发货数量必须 > 0
   - 支持小数（适用于按重量/长度计量的产品，数据类型为DECIMAL(10,2)）
10. 分批发货支持：
    - 同一合同可创建多个发货单
    - 每次创建发货单时，系统自动计算各产品的剩余待发货数量 = quantity - shipped_quantity
    - 发货单明细显示：合同数量、已发货数量、本次发货数量、剩余数量
11. 发货逾期提醒任务生成规则：
    - 定时任务每日检查shipment表，planned_ship_date < CURRENT_DATE且status=draft/pending，生成待办任务
    - 任务类型：shipment_overdue
    - 任务标题：发货单【shipment_no】发货已逾期
    - 任务描述：发货单【shipment_title】计划发货日期为【planned_ship_date】，当前已逾期X天，请尽快安排发货
    - 优先级：high
    - 负责人：发货单owner_id
    - unique_key：shipment_{shipment_id}_overdue_{planned_ship_date}
12. shipment_amount由系统自动从shipment_item表汇总计算，不允许手动修改
13. 发货单草稿超过30天未确认发货，定时任务自动标记为cancelled，cancel_reason自动填写："系统自动取消（草稿超过30天未发货）"
14. 发货单的planned_ship_date不能早于合同的signed_date
15. 发货单产品明细不能为空（至少包含1个产品，业务逻辑校验）

---

#### 7.7.2 发货单明细表（shipment_item）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| item_id | BIGINT | PK, AUTO_INCREMENT | 明细ID |
| shipment_id | BIGINT | NOT NULL, FK | 发货单ID（外键关联shipment） |
| contract_item_id | BIGINT | NOT NULL, FK | 合同明细ID（外键关联contract_item，用于追溯和更新合同发货进度） |
| product_id | BIGINT | NOT NULL, FK | 产品ID（外键关联product） |
| product_code | VARCHAR(100) | NOT NULL | 产品编码（冗余字段，快照保存） |
| product_name | VARCHAR(200) | NOT NULL | 产品名称（冗余字段，快照保存） |
| product_unit | VARCHAR(20) | NOT NULL | 单位（冗余字段，如：台、个、套） |
| **数量字段** | | | |
| contract_quantity | DECIMAL(10,2) | NOT NULL | 合同约定数量（冗余字段，从contract_item继承，便于对比） |
| already_shipped_quantity | DECIMAL(10,2) | NOT NULL | 之前已发货数量（创建发货单时自动计算 = contract_item.shipped_quantity - 本发货单之前的发货数量） |
| this_shipment_quantity | DECIMAL(10,2) | NOT NULL | 本次发货数量（用户填写，必须 > 0 且 <= remaining_quantity） |
| remaining_quantity | DECIMAL(10,2) | NOT NULL | 剩余待发货数量（自动计算 = contract_quantity - already_shipped_quantity - this_shipment_quantity） |
| **金额字段** | | | |
| unit_price | DECIMAL(12,2) | NOT NULL | 单价（继承自contract_item，保持一致） |
| subtotal | DECIMAL(12,2) | NOT NULL | 小计（= unit_price × this_shipment_quantity，自动计算） |
| **排序字段** | | | |
| sort_order | INT | DEFAULT 0 | 排序号（控制明细显示顺序） |
| **审计字段** | | | |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
- PRIMARY KEY (item_id)
- INDEX (shipment_id)
- INDEX (contract_item_id)
- INDEX (product_id)

**约束**：
- FOREIGN KEY (shipment_id) REFERENCES shipment(shipment_id) ON DELETE CASCADE
- FOREIGN KEY (contract_item_id) REFERENCES contract_item(item_id) ON DELETE RESTRICT
- FOREIGN KEY (product_id) REFERENCES product(product_id) ON DELETE RESTRICT
- CHECK (contract_quantity > 0)
- CHECK (already_shipped_quantity >= 0)
- CHECK (this_shipment_quantity > 0)
- CHECK (remaining_quantity >= 0)
- CHECK (this_shipment_quantity <= contract_quantity - already_shipped_quantity)
- CHECK (unit_price >= 0)
- CHECK (subtotal >= 0)

**业务规则**：
1. 创建发货单明细时，自动从contract_item读取并填充以下字段：
   - contract_item_id = 合同明细ID
   - product_id = contract_item.product_id
   - product_code = contract_item.product_code
   - product_name = contract_item.product_name
   - product_unit = contract_item.product_unit
   - contract_quantity = contract_item.quantity（合同约定数量）
   - already_shipped_quantity = contract_item.shipped_quantity（创建时的已发货数量）
   - unit_price = contract_item.unit_price
2. 用户填写this_shipment_quantity（本次发货数量）后，系统自动计算：
   - remaining_quantity = contract_quantity - already_shipped_quantity - this_shipment_quantity
   - subtotal = unit_price × this_shipment_quantity
3. 发货数量校验：
   - this_shipment_quantity必须 > 0
   - this_shipment_quantity <= (contract_quantity - already_shipped_quantity)
   - 校验失败时提示："产品【product_name】发货数量（X）超过剩余待发货数量（Y），请检查"
4. 产品信息冗余存储（product_code、product_name、product_unit）：
   - 保证历史发货单不受产品表变更影响
   - 即使产品被停售或删除，历史发货单仍可正常显示
5. 删除发货单时，自动删除所有明细（ON DELETE CASCADE）
6. 产品被发货单引用后，不允许物理删除（ON DELETE RESTRICT）
7. 合同明细被发货单引用后，不允许删除（ON DELETE RESTRICT）
8. sort_order用于控制发货单中产品的显示顺序，默认按创建顺序排列
9. 发货单状态为shipped后，不允许新增/修改/删除明细（业务逻辑层校验），如需调整需取消发货单重新创建
10. 发货单状态变为shipped时，自动更新contract_item.shipped_quantity += this_shipment_quantity
11. 发货单状态变为cancelled时，自动回退contract_item.shipped_quantity -= this_shipment_quantity

**发货单总金额汇总计算**（shipment表字段）：
```sql
-- 发货单总金额（shipment_amount）
SELECT SUM(subtotal) FROM shipment_item WHERE shipment_id = ?
```

**合同产品剩余待发货数量查询**（创建发货单时使用）：
```sql
-- 查询合同各产品的剩余待发货数量
SELECT
  ci.item_id AS contract_item_id,
  ci.product_id,
  ci.product_code,
  ci.product_name,
  ci.product_unit,
  ci.quantity AS contract_quantity,
  ci.shipped_quantity AS already_shipped_quantity,
  (ci.quantity - ci.shipped_quantity) AS remaining_quantity,
  ci.unit_price
FROM contract_item ci
WHERE ci.contract_id = ?
  AND (ci.quantity - ci.shipped_quantity) > 0
ORDER BY ci.sort_order;
```

---

#### 7.7.3 发货单物流跟踪表（shipment_tracking）（预留v2.0）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| tracking_id | BIGINT | PK, AUTO_INCREMENT | 物流跟踪记录ID |
| shipment_id | BIGINT | NOT NULL, FK | 发货单ID（外键关联shipment） |
| tracking_time | DATETIME | NOT NULL | 物流节点时间 |
| tracking_location | VARCHAR(200) | NULL | 物流节点位置（如："北京分拨中心"） |
| tracking_status | VARCHAR(50) | NULL | 物流状态（如："已揽收"、"运输中"、"派送中"、"已签收"） |
| tracking_description | TEXT | NULL | 物流描述（如："您的快件已到达北京分拨中心"） |
| data_source | VARCHAR(20) | DEFAULT 'manual' | 数据来源（manual=手动录入，api=物流API自动同步） |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**：
- PRIMARY KEY (tracking_id)
- INDEX (shipment_id)
- INDEX (tracking_time)

**约束**：
- FOREIGN KEY (shipment_id) REFERENCES shipment(shipment_id) ON DELETE CASCADE

**说明**：
- v1.0阶段不实现物流跟踪功能，预留数据表结构
- v2.0对接第三方物流API（如：快递100、菜鸟裹裹），自动查询和同步物流轨迹
- v2.0支持前端展示物流轨迹时间线
- v2.0可根据物流状态自动更新发货单状态（如：物流状态="已签收"时，自动更新shipment.status=delivered）

---

### 7.8 收款管理实体

#### 7.8.1 收款记录表（payment）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| payment_id | BIGINT | PK, AUTO_INCREMENT | 收款记录ID |
| payment_no | VARCHAR(100) | NOT NULL, UNIQUE | 收款编号（自动生成，如：PAY-20251223-001） |
| contract_id | BIGINT | NOT NULL, FK | 合同ID（外键关联contract） |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（外键关联customer，冗余字段，从contract自动继承，用于按客户统计收款） |
| payment_stage | VARCHAR(100) | NOT NULL | 收款阶段（与contract.payment_terms中的stage对应，如："签订后"、"发货前"、"验收后"） |
| payment_amount | DECIMAL(12,2) | NOT NULL | 本次收款金额（实际到账金额） |
| payment_date | DATE | NOT NULL | 收款日期（实际到账日期） |
| payment_method | VARCHAR(50) | NOT NULL | 收款方式（bank_transfer=银行转账，check=支票，cash=现金，third_party=第三方支付，other=其他） |
| bank_account | VARCHAR(200) | NULL | 收款银行账户（收款方式为bank_transfer时必填） |
| transaction_no | VARCHAR(200) | NULL | 银行流水号/交易单号（收款方式为bank_transfer或third_party时建议填写） |
| payer_name | VARCHAR(200) | NULL | 付款方名称（实际付款公司或个人名称，可能与customer_name不一致） |
| **核销相关字段** | | | |
| expected_amount | DECIMAL(12,2) | NULL | 该期应收金额（从contract.payment_terms中对应stage的amount读取，仅供参考） |
| stage_paid_amount | DECIMAL(12,2) | DEFAULT 0.00 | 该期已收款总额（自动累加：同一contract_id + payment_stage的所有confirmed记录的payment_amount之和，冗余字段） |
| stage_balance_amount | DECIMAL(12,2) | DEFAULT 0.00 | 该期剩余应收金额（= expected_amount - stage_paid_amount，冗余字段） |
| is_stage_settled | TINYINT | DEFAULT 0 | 该期是否已核销完成（1=该期已收齐，0=未收齐，自动判断：stage_paid_amount >= expected_amount） |
| **状态字段** | | | |
| status | VARCHAR(20) | NOT NULL | 收款状态（draft=草稿，confirmed=已确认，cancelled=已取消） |
| confirm_date | DATETIME | NULL | 确认时间（状态变为confirmed时记录） |
| confirmed_by | BIGINT | NULL, FK | 确认人ID（关联用户表，状态变为confirmed时记录） |
| **备注字段** | | | |
| payment_note | VARCHAR(500) | NULL | 收款备注（如："客户延期支付，已沟通确认"） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NOT NULL, FK | 负责人ID（关联用户表，通常继承自合同负责人） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (payment_id)
- UNIQUE KEY (payment_no)
- INDEX (contract_id)
- INDEX (customer_id)
- INDEX (payment_stage)
- INDEX (payment_date)
- INDEX (payment_method)
- INDEX (status)
- INDEX (owner_id)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- FOREIGN KEY (confirmed_by) REFERENCES user(user_id)
- CHECK (payment_amount > 0)
- CHECK (expected_amount IS NULL OR expected_amount >= 0)
- CHECK (stage_paid_amount >= 0)
- CHECK (stage_balance_amount >= 0)
- CHECK (payment_date >= (SELECT signed_date FROM contract WHERE contract_id = payment.contract_id))

**生命周期（status）**：
1. **草稿（draft）**：收款记录创建中，未确认到账，不更新合同的received_amount
2. **已确认（confirmed）**：收款已确认到账，自动累加更新contract.received_amount
3. **已取消（cancelled）**：收款记录作废（如：误录入、客户退款），自动回退contract.received_amount

**状态流转规则**：
```
draft（草稿）
  ↓ [确认收款] → confirmed（已确认）
  ↓ [删除] → deleted_at有值

confirmed（已确认）
  ↓ [取消收款] → cancelled（已取消）

cancelled → 终态，不再变更
```

**业务规则**：

1. **收款编号自动生成**，建议格式：PAY-YYYYMMDD-流水号（如：PAY-20251223-001）

2. **创建收款记录时**：
   - payment_no自动生成
   - contract_id必选（仅状态为signed/executing/completed的合同可创建收款记录）
   - **customer_id自动从contract.customer_id继承**（创建时自动填充，不允许手动修改，确保数据一致性）
   - payment_stage必选（从contract.payment_terms的JSON中读取stage列表供选择）
   - payment_amount必填（> 0）
   - payment_date必填（不能早于合同签订日期）
   - payment_method必选（bank_transfer/check/cash/third_party/other）
   - 如果payment_method = bank_transfer，则bank_account和transaction_no建议必填
   - owner_id默认继承contract.owner_id
   - status默认为draft

3. **收款阶段（payment_stage）校验**：
   - payment_stage必须与contract.payment_terms中的某个stage一致
   - 例如：payment_terms = [{"stage":"签订后","percentage":30},{"stage":"发货前","percentage":70}]
   - 则payment_stage只能选择"签订后"或"发货前"
   - 如果输入不存在的stage，系统提示："收款阶段【XXX】不在合同付款条款中，请检查"

4. **应收金额（expected_amount）自动填充**：
   - 创建收款记录时，根据payment_stage从contract.payment_terms中读取对应的amount
   - 例如：payment_stage = "签订后"，payment_terms中该stage的amount = 30000，则expected_amount = 30000
   - expected_amount仅供参考，不作为强制校验（允许分期调整）

5. **收款状态变为confirmed时**：
   - 记录confirm_date = 当前时间
   - 记录confirmed_by = 当前操作用户ID
   - 自动累加更新contract.received_amount += payment_amount（触发器或应用层逻辑）
   - 更新该期的stage_paid_amount（累加同一contract_id + payment_stage的所有confirmed记录）
   - 更新stage_balance_amount = expected_amount - stage_paid_amount
   - 判断is_stage_settled：如果stage_paid_amount >= expected_amount，则is_stage_settled = 1
   - 如果contract.status = signed，自动变为executing（首次收款触发）

6. **收款状态变为cancelled时**：
   - 自动回退contract.received_amount -= payment_amount
   - 重新计算该期的stage_paid_amount、stage_balance_amount、is_stage_settled

7. **同一合同的同一付款阶段可创建多条收款记录**（支持部分收款）：
   - 例如：合同约定"签订后收30000元"，实际可能分3次收款：10000、10000、10000
   - 创建3条收款记录，payment_stage都是"签订后"，累加计算stage_paid_amount = 30000

8. **收款超额预警（不阻止保存）**：
   - 如果contract.received_amount + payment_amount > contract.contract_amount，系统提示：
     "警告：收款总额（X元）将超过合同金额（Y元），是否确认？（可能存在补偿款或额外付款）"
   - 允许保存，便于处理客户额外支付场景

9. **收款完成提示**：
   - 当contract.received_amount = contract.contract_amount时，系统提示：
     "合同【contract_no】收款已全部完成，已收款金额 = 合同金额"

10. **收款记录被删除或软删除时**：
    - 如果status = confirmed，自动回退contract.received_amount -= payment_amount
    - 如果status = draft 或 cancelled，不影响合同统计

11. **收款逾期判定**（用于生成待办任务）：
    - 从contract.payment_terms中读取每期的due_date（应付日期）
    - 对于每个stage，计算该期的stage_paid_amount（已收款总额）
    - 如果当前日期 > due_date 且 stage_paid_amount < expected_amount，则该期逾期
    - 生成待办任务："合同【contract_no】付款阶段【payment_stage】已逾期，应收【expected_amount】元，已收【stage_paid_amount】元，剩余【stage_balance_amount】元，请尽快催款"

12. **收款到期提醒**（用于生成待办任务）：
    - 从contract.payment_terms中读取每期的due_date
    - 当前日期 = due_date - 3天 时，生成待办任务：
      "合同【contract_no】付款阶段【payment_stage】即将到期（应付日期：due_date），应收【expected_amount】元，已收【stage_paid_amount】元，剩余【stage_balance_amount】元，请跟进收款"

13. **收款记录不允许修改关键字段（status=confirmed后）**：
    - confirmed后不允许修改：contract_id、payment_stage、payment_amount、payment_date
    - 允许修改：payment_note、bank_account、transaction_no、payer_name（补充信息）
    - 如需调整金额，需先取消（status=cancelled），重新创建新记录

14. **收款方式字段说明**：
    - bank_transfer：银行转账（对公/对私账户转账）
    - check：支票（银行支票）
    - cash：现金（现金收款）
    - third_party：第三方支付（支付宝、微信支付等）
    - other：其他方式（如：承兑汇票、货物抵款等）

15. **冗余字段自动更新机制**：
    - stage_paid_amount（该期已收款总额）：
      - 每次创建/确认/取消收款记录时，重新计算同一contract_id + payment_stage的所有confirmed记录的payment_amount之和
      - 更新所有该合同该阶段的收款记录的stage_paid_amount字段（保持一致）
    - stage_balance_amount（该期剩余应收金额）：
      - 自动计算：expected_amount - stage_paid_amount
    - is_stage_settled（该期是否已核销完成）：
      - 自动判断：stage_paid_amount >= expected_amount 时为1，否则为0

16. **仅状态为confirmed的收款记录才更新合同的received_amount**，避免草稿数据污染统计

---

**合同已收款金额汇总计算**（contract表字段）：
```sql
-- 合同已收款金额（contract.received_amount）
SELECT IFNULL(SUM(payment_amount), 0)
FROM payment
WHERE contract_id = ?
  AND status = 'confirmed'
  AND deleted_at IS NULL;
```

**查询合同各付款阶段的收款进度**（应收账款统计）：
```sql
-- 查询合同的付款条款及各阶段收款情况
SELECT
  pt.stage AS payment_stage,
  pt.percentage AS payment_percentage,
  pt.amount AS expected_amount,
  pt.due_date AS due_date,
  IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0) AS stage_paid_amount,
  (pt.amount - IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0)) AS stage_balance_amount,
  CASE
    WHEN IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0) >= pt.amount THEN 1
    ELSE 0
  END AS is_stage_settled,
  CASE
    WHEN pt.due_date < CURDATE() AND IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0) < pt.amount THEN 1
    ELSE 0
  END AS is_overdue
FROM
  (SELECT
     stage,
     percentage,
     amount,
     due_date
   FROM contract
   CROSS JOIN JSON_TABLE(
     payment_terms,
     '$[*]' COLUMNS(
       stage VARCHAR(100) PATH '$.stage',
       percentage DECIMAL(5,2) PATH '$.percentage',
       amount DECIMAL(12,2) PATH '$.amount',
       due_date DATE PATH '$.due_date'
     )
   ) AS jt
   WHERE contract_id = ?) AS pt
LEFT JOIN payment p ON p.contract_id = ? AND p.payment_stage = pt.stage
GROUP BY pt.stage, pt.percentage, pt.amount, pt.due_date
ORDER BY pt.due_date;
```

**应收账款逾期统计**（全局视图）：
```sql
-- 查询所有逾期应收款
SELECT
  c.contract_id,
  c.contract_no,
  c.customer_id,
  cust.customer_name,
  pt.stage AS payment_stage,
  pt.amount AS expected_amount,
  pt.due_date AS due_date,
  IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0) AS stage_paid_amount,
  (pt.amount - IFNULL(SUM(CASE WHEN p.status = 'confirmed' AND p.deleted_at IS NULL THEN p.payment_amount ELSE 0 END), 0)) AS stage_balance_amount,
  DATEDIFF(CURDATE(), pt.due_date) AS overdue_days
FROM contract c
INNER JOIN customer cust ON c.customer_id = cust.customer_id
CROSS JOIN JSON_TABLE(
  c.payment_terms,
  '$[*]' COLUMNS(
    stage VARCHAR(100) PATH '$.stage',
    amount DECIMAL(12,2) PATH '$.amount',
    due_date DATE PATH '$.due_date'
  )
) AS pt
LEFT JOIN payment p ON p.contract_id = c.contract_id AND p.payment_stage = pt.stage
WHERE c.status IN ('signed', 'executing')
  AND c.deleted_at IS NULL
  AND pt.due_date < CURDATE()
GROUP BY c.contract_id, c.contract_no, c.customer_id, cust.customer_name, pt.stage, pt.amount, pt.due_date
HAVING stage_paid_amount < expected_amount
ORDER BY overdue_days DESC, stage_balance_amount DESC;
```

---

### 7.9 发票管理实体

#### 7.9.1 发票记录表（invoice）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| invoice_id | BIGINT | PK, AUTO_INCREMENT | 发票记录ID |
| invoice_no | VARCHAR(100) | NOT NULL, UNIQUE | 发票号码（税务发票号码，全局唯一） |
| contract_id | BIGINT | NOT NULL, FK | 合同ID（外键关联contract） |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（外键关联customer，冗余字段，从contract自动继承，用于按客户统计开票） |
| payment_id | BIGINT | NULL, FK | 收款记录ID（外键关联payment，可为NULL，支持预开票或不关联收款场景） |
| **发票基本信息** | | | |
| invoice_type | VARCHAR(50) | NOT NULL | 发票类型（vat_special=增值税专用发票，vat_normal=增值税普通发票） |
| invoice_amount | DECIMAL(12,2) | NOT NULL | 开票金额（发票金额） |
| invoice_date | DATE | NOT NULL | 开票日期（发票上的开票日期） |
| **发票抬头信息** | | | |
| invoice_title | VARCHAR(200) | NOT NULL | 发票抬头（客户公司名称） |
| tax_number | VARCHAR(100) | NULL | 纳税人识别号（增值税专用发票时必填） |
| company_address | VARCHAR(500) | NULL | 公司地址（增值税专用发票建议填写） |
| company_phone | VARCHAR(100) | NULL | 公司电话（增值税专用发票建议填写） |
| bank_name | VARCHAR(200) | NULL | 开户银行（增值税专用发票建议填写） |
| bank_account | VARCHAR(100) | NULL | 银行账号（增值税专用发票建议填写） |
| **状态字段** | | | |
| status | VARCHAR(20) | NOT NULL | 发票状态（draft=待开票，confirmed=已开具，voided=已作废） |
| confirm_date | DATETIME | NULL | 开具时间（状态变为confirmed时记录） |
| confirmed_by | BIGINT | NULL, FK | 开具人ID（关联用户表，状态变为confirmed时记录） |
| void_date | DATETIME | NULL | 作废时间（状态变为voided时记录） |
| void_reason | VARCHAR(500) | NULL | 作废原因（状态变为voided时填写） |
| voided_by | BIGINT | NULL, FK | 作废人ID（关联用户表，状态变为voided时记录） |
| **备注字段** | | | |
| invoice_note | VARCHAR(500) | NULL | 发票备注（如："客户要求开专票"） |
| **权限控制字段（预留）** | | | |
| owner_id | BIGINT | NOT NULL, FK | 负责人ID（关联用户表，通常继承自合同负责人） |
| department_id | BIGINT | NULL | 所属部门ID（预留） |
| data_permission_level | TINYINT | DEFAULT 0 | 数据权限级别（0=公开，1=部门，2=个人，预留） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (invoice_id)
- UNIQUE KEY (invoice_no)
- INDEX (contract_id)
- INDEX (customer_id)
- INDEX (payment_id)
- INDEX (invoice_type)
- INDEX (invoice_date)
- INDEX (status)
- INDEX (owner_id)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (payment_id) REFERENCES payment(payment_id) ON DELETE SET NULL
- FOREIGN KEY (owner_id) REFERENCES user(user_id)
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- FOREIGN KEY (confirmed_by) REFERENCES user(user_id)
- FOREIGN KEY (voided_by) REFERENCES user(user_id)
- CHECK (invoice_amount > 0)
- CHECK (invoice_date >= (SELECT signed_date FROM contract WHERE contract_id = invoice.contract_id))

**生命周期（status）**：
1. **待开票（draft）**：发票记录创建中，未正式开具，不更新合同的invoiced_amount
2. **已开具（confirmed）**：发票已正式开具，自动累加更新contract.invoiced_amount
3. **已作废（voided）**：发票作废（如：开票错误、客户退票），自动回退contract.invoiced_amount

**状态流转规则**：
```
draft（待开票）
  ↓ [确认开具] → confirmed（已开具）
  ↓ [删除] → deleted_at有值

confirmed（已开具）
  ↓ [作废发票] → voided（已作废）

voided → 终态，不再变更
```

**业务规则**：

1. **发票号码唯一性**：
   - invoice_no必须全局唯一（UNIQUE约束）
   - invoice_no为税务发票号码，由财务人员录入
   - 发票号码格式示例：02345678（8位数字）、031002345678（省份+年份+流水号）
   - 系统不自动生成invoice_no，由财务人员根据实际开具的发票号码手动录入

2. **创建发票记录时**：
   - invoice_no必填（税务发票号码）
   - contract_id必选（仅状态为signed/executing/completed的合同可创建发票记录）
   - **customer_id自动从contract.customer_id继承**（创建时自动填充，不允许手动修改，确保数据一致性）
   - invoice_type必选（vat_special/vat_normal）
   - invoice_amount必填（> 0）
   - invoice_date必填（不能早于合同签订日期）
   - payment_id可选（如果关联收款记录，从收款记录带入合同信息）
   - invoice_title必填（从customer表的company_name读取，允许修改）
   - tax_number根据invoice_type决定是否必填：
     - invoice_type = vat_special，tax_number必填
     - invoice_type = vat_normal，tax_number可选
   - 增值税专用发票建议填写：company_address、company_phone、bank_name、bank_account
   - owner_id默认继承contract.owner_id
   - status默认为draft

3. **发票抬头信息自动填充**：
   - 创建发票记录时，从customer表读取开票信息：
     - invoice_title = customer.company_name
     - tax_number = customer.tax_number
     - company_address = customer.address
     - company_phone = customer.phone
     - bank_name = customer.bank_name
     - bank_account = customer.bank_account
   - 允许手动修改发票抬头信息（实际开票信息可能与客户登记信息不一致）

4. **发票与收款关联（可选）**：
   - payment_id可为NULL（支持预开票或不关联收款场景）
   - 如果payment_id有值，表示该发票基于该笔收款开具
   - 如果payment_id为NULL，表示独立开票（如：预开票、补开票）
   - 关联收款时，建议invoice_amount <= payment.payment_amount（柔性校验，提示但允许保存）

5. **发票状态变为confirmed时**：
   - 记录confirm_date = 当前时间
   - 记录confirmed_by = 当前操作用户ID
   - 自动累加更新contract.invoiced_amount += invoice_amount（触发器或应用层逻辑）
   - 如果contract.status = signed，自动变为executing（首次开票触发）

6. **发票状态变为voided时**：
   - 记录void_date = 当前时间
   - 记录voided_by = 当前操作用户ID
   - 记录void_reason（作废原因必填）
   - 自动回退contract.invoiced_amount -= invoice_amount
   - 已作废的发票不允许再次修改或恢复

7. **发票超额预警（不阻止保存）**：
   - 如果contract.invoiced_amount + invoice_amount > contract.contract_amount，系统提示：
     "警告：开票总额（X元）将超过合同金额（Y元），是否确认？（可能存在补偿开票或额外开票）"
   - 允许保存，便于处理特殊开票场景

8. **发票完成提示**：
   - 当contract.invoiced_amount = contract.contract_amount时，系统提示：
     "合同【contract_no】开票已全部完成，已开票金额 = 合同金额"

9. **发票记录被删除或软删除时**：
   - 如果status = confirmed，不允许直接删除，必须先作废（voided）
   - 如果status = draft，允许删除，不影响合同统计
   - 如果status = voided，允许删除（已作废的发票可清理）

10. **发票记录不允许修改关键字段（status=confirmed后）**：
    - confirmed后不允许修改：contract_id、payment_id、invoice_type、invoice_amount、invoice_date、invoice_no
    - 允许修改：invoice_note、invoice_title、tax_number、company_address等（补充信息）
    - 如需调整金额或发票号码，需先作废（status=voided），重新创建新记录

11. **仅状态为confirmed的发票记录才更新合同的invoiced_amount**，避免草稿数据污染统计

12. **发票类型字段说明**：
    - vat_special：增值税专用发票（可抵扣进项税，需填写完整开票信息）
    - vat_normal：增值税普通发票（不可抵扣，开票信息要求相对简单）

13. **增值税专用发票必填字段校验**：
    - invoice_type = vat_special 时，以下字段必填：
      - invoice_title（发票抬头）
      - tax_number（纳税人识别号）
      - company_address（公司地址）
      - company_phone（公司电话）
      - bank_name（开户银行）
      - bank_account（银行账号）
    - invoice_type = vat_normal 时，仅invoice_title必填

---

**合同已开票金额汇总计算**（contract表字段）：
```sql
-- 合同已开票金额（contract.invoiced_amount）
SELECT IFNULL(SUM(invoice_amount), 0)
FROM invoice
WHERE contract_id = ?
  AND status = 'confirmed'
  AND deleted_at IS NULL;
```

**查询合同的开票进度**：
```sql
-- 查询合同的开票情况
SELECT
  c.contract_id,
  c.contract_no,
  c.customer_id,
  cust.customer_name,
  c.contract_amount,
  c.invoiced_amount,
  (c.contract_amount - c.invoiced_amount) AS uninvoiced_amount,
  ROUND((c.invoiced_amount / c.contract_amount) * 100, 2) AS invoiced_percentage,
  CASE
    WHEN c.invoiced_amount >= c.contract_amount THEN '已完成'
    WHEN c.invoiced_amount > 0 THEN '进行中'
    ELSE '未开始'
  END AS invoiced_status
FROM contract c
INNER JOIN customer cust ON c.customer_id = cust.customer_id
WHERE c.status IN ('signed', 'executing', 'completed')
  AND c.deleted_at IS NULL
ORDER BY c.contract_id DESC;
```

**查询发票明细列表**：
```sql
-- 查询发票记录列表
SELECT
  i.invoice_id,
  i.invoice_no,
  i.invoice_type,
  i.invoice_amount,
  i.invoice_date,
  i.status,
  c.contract_no,
  c.contract_amount,
  cust.customer_name,
  i.invoice_title,
  i.tax_number,
  p.payment_no,
  p.payment_amount,
  u_confirm.user_name AS confirmed_by_name,
  i.confirm_date,
  u_void.user_name AS voided_by_name,
  i.void_date,
  i.void_reason
FROM invoice i
INNER JOIN contract c ON i.contract_id = c.contract_id
INNER JOIN customer cust ON c.customer_id = cust.customer_id
LEFT JOIN payment p ON i.payment_id = p.payment_id
LEFT JOIN user u_confirm ON i.confirmed_by = u_confirm.user_id
LEFT JOIN user u_void ON i.voided_by = u_void.user_id
WHERE i.deleted_at IS NULL
ORDER BY i.invoice_date DESC, i.invoice_id DESC;
```

---

### 7.10 售后服务实体

#### 7.10.1 服务工单表（service_ticket）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| ticket_id | BIGINT | PK, AUTO_INCREMENT | 工单ID |
| ticket_no | VARCHAR(100) | NOT NULL, UNIQUE | 工单编号（自动生成，如：TICKET-20251223-001） |
| ticket_type | VARCHAR(50) | NOT NULL | 工单类型（repair=故障维修，replacement=产品更换，technical_support=技术支持，inspection=定期巡检） |
| ticket_title | VARCHAR(200) | NOT NULL | 工单标题（如："XX酒店自助机故障报修"） |
| priority | VARCHAR(20) | NOT NULL | 优先级（urgent=紧急，high=高，medium=中，low=低） |
| status | VARCHAR(20) | NOT NULL | 工单状态（pending=待处理，in_progress=处理中，pending_acceptance=待验收，resolved=已解决，closed=已关闭，cancelled=已取消） |
| **关联字段** | | | |
| customer_id | BIGINT | NOT NULL, FK | 客户ID（外键关联customer表） |
| customer_contact_id | BIGINT | NULL, FK | 客户联系人ID（外键关联customer_contact表） |
| contract_id | BIGINT | NULL, FK | 关联合同ID（外键关联contract表，可选，用于判断质保期） |
| product_id | BIGINT | NULL, FK | 故障产品ID（外键关联product表，可选） |
| product_name | VARCHAR(200) | NULL | 产品名称（冗余字段，快照保存，避免产品表变更影响历史工单） |
| product_code | VARCHAR(100) | NULL | 产品编码（冗余字段） |
| **工单内容字段** | | | |
| problem_description | TEXT | NOT NULL | 问题描述（客户报修时填写的故障描述） |
| problem_analysis | TEXT | NULL | 问题分析（售后工程师填写的故障原因分析） |
| solution | TEXT | NULL | 解决方案（售后工程师填写的处理方法） |
| attachment_urls | TEXT | NULL | 附件URL列表（JSON数组格式，如：["url1.png", "url2.jpg"]，上传故障照片/现场照片） |
| **质保与费用字段** | | | |
| is_under_warranty | TINYINT | DEFAULT 0 | 是否在质保期内（1=在保，0=不在保，创建工单时自动判断） |
| warranty_end_date | DATE | NULL | 质保期结束日期（从合同表读取，冗余保存） |
| service_fee | DECIMAL(10,2) | DEFAULT 0.00 | 服务费用（0表示免费服务，质保期内或厂商承担） |
| parts_cost | DECIMAL(10,2) | DEFAULT 0.00 | 配件费用（更换配件的费用） |
| total_cost | DECIMAL(10,2) | DEFAULT 0.00 | 总费用（= service_fee + parts_cost，自动计算） |
| payment_status | VARCHAR(20) | NULL | 费用支付状态（unpaid=未支付，paid=已支付，waived=免费，NULL=不涉及费用） |
| **配件更换字段** | | | |
| replaced_parts | TEXT | NULL | 更换配件清单（JSON数组格式，如：[{"part_name":"主板","part_code":"MB-001","quantity":1,"cost":500}]） |
| **人员与时间字段** | | | |
| assigned_to | BIGINT | NULL, FK | 当前处理人ID（关联用户表，售后工程师） |
| reported_by | BIGINT | NULL, FK | 报修人ID（关联用户表，客服人员录入工单时为客服ID，v2.0客户自助提交时为客户ID） |
| reported_at | DATETIME | NOT NULL | 报修时间（工单创建时间） |
| first_response_at | DATETIME | NULL | 首次响应时间（工单状态从pending变为in_progress的时间） |
| resolved_at | DATETIME | NULL | 解决时间（工单状态变为resolved的时间） |
| closed_at | DATETIME | NULL | 关闭时间（工单状态变为closed的时间） |
| expected_resolve_date | DATE | NULL | 期望解决日期（客户期望的最晚解决时间） |
| **客户满意度字段** | | | |
| customer_rating | TINYINT | NULL | 客户评分（1-5分，1=非常不满意，5=非常满意） |
| customer_feedback | TEXT | NULL | 客户反馈（客户对本次服务的评价） |
| rated_at | DATETIME | NULL | 评价时间 |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 创建人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_by | BIGINT | NULL, FK | 修改人ID（关联用户表） |
| updated_at | DATETIME | NOT NULL | 更新时间 |
| deleted_at | DATETIME | NULL | 软删除时间（NULL表示未删除） |

**索引**：
- PRIMARY KEY (ticket_id)
- UNIQUE KEY (ticket_no)
- INDEX (customer_id)
- INDEX (contract_id)
- INDEX (product_id)
- INDEX (ticket_type)
- INDEX (priority)
- INDEX (status)
- INDEX (assigned_to)
- INDEX (is_under_warranty)
- INDEX (reported_at)
- INDEX (expected_resolve_date)
- INDEX (customer_rating)
- INDEX (created_at)
- INDEX (deleted_at)

**约束**：
- FOREIGN KEY (customer_id) REFERENCES customer(customer_id) ON DELETE RESTRICT
- FOREIGN KEY (customer_contact_id) REFERENCES customer_contact(contact_id) ON DELETE SET NULL
- FOREIGN KEY (contract_id) REFERENCES contract(contract_id) ON DELETE RESTRICT
- FOREIGN KEY (product_id) REFERENCES product(product_id) ON DELETE RESTRICT
- FOREIGN KEY (assigned_to) REFERENCES user(user_id) ON DELETE SET NULL
- FOREIGN KEY (reported_by) REFERENCES user(user_id) ON DELETE SET NULL
- FOREIGN KEY (created_by) REFERENCES user(user_id)
- FOREIGN KEY (updated_by) REFERENCES user(user_id)
- CHECK (service_fee >= 0)
- CHECK (parts_cost >= 0)
- CHECK (total_cost >= 0)
- CHECK (customer_rating IS NULL OR (customer_rating >= 1 AND customer_rating <= 5))
- CHECK (first_response_at IS NULL OR first_response_at >= reported_at)
- CHECK (resolved_at IS NULL OR resolved_at >= first_response_at)
- CHECK (closed_at IS NULL OR closed_at >= resolved_at)

**生命周期（status）**：
1. **待处理（pending）**：工单已创建，等待分配处理人或处理人确认接单
2. **处理中（in_progress）**：售后工程师已接单，正在处理中
3. **待验收（pending_acceptance）**：售后工程师已处理完成，等待客户验收确认
4. **已解决（resolved）**：客户验收通过，问题已解决，可以评价
5. **已关闭（closed）**：工单正常关闭，归档
6. **已取消（cancelled）**：工单被取消（客户撤销报修、重复工单等）

**状态流转规则**：
```
pending（待处理）
  ↓ [分配处理人，开始处理] → in_progress（处理中）
  ↓ [客户撤销] → cancelled（已取消）

in_progress（处理中）
  ↓ [处理完成，提交验收] → pending_acceptance（待验收）
  ↓ [重新评估，退回待处理] → pending（待处理）
  ↓ [客户撤销] → cancelled（已取消）

pending_acceptance（待验收）
  ↓ [客户验收通过] → resolved（已解决）
  ↓ [客户验收不通过，返工] → in_progress（处理中）

resolved（已解决）
  ↓ [客户评价后关闭或超过7天自动关闭] → closed（已关闭）

closed/cancelled → 终态，不再变更
```

**业务规则**：
1. 工单编号自动生成，建议格式：TICKET-YYYYMMDD-流水号（如：TICKET-20251223-001）
2. 创建工单时：
   - ticket_title默认为"{客户名称}-{工单类型}-{产品名称}"，可手动修改
   - status默认为pending
   - reported_at默认为当前时间
   - priority根据问题紧急程度手动选择
   - 如果关联合同（contract_id有值），自动判断质保期：
     - 读取contract.warranty_start_date和warranty_end_date
     - 如果当前时间在[warranty_start_date, warranty_end_date]区间内，is_under_warranty=1
     - 否则is_under_warranty=0
     - warranty_end_date冗余保存，避免合同变更影响历史工单
   - 如果关联产品（product_id有值），冗余保存product_name和product_code
3. 工单状态为pending时：
   - assigned_to可以为空（未分配）
   - 如果assigned_to有值，表示已分配，等待处理人确认接单
4. 工单状态变为in_progress时：
   - assigned_to必填（必须有处理人）
   - 记录first_response_at = 当前时间（仅首次流转时记录）
5. 工单状态变为resolved时：
   - 记录resolved_at = 当前时间
   - 允许客户评价（填写customer_rating和customer_feedback）
6. 工单状态变为closed时：
   - 记录closed_at = 当前时间
   - 不允许再次修改（终态）
7. 工单费用计算：
   - total_cost = service_fee + parts_cost（自动计算）
   - 如果is_under_warranty=1且厂商承担费用，service_fee和parts_cost均为0，payment_status='waived'
   - 如果is_under_warranty=0，根据实际情况填写费用，payment_status='unpaid'或'paid'
8. 配件更换清单（replaced_parts）JSON结构：
   ```json
   [
     {
       "part_name": "主板",
       "part_code": "MB-001",
       "quantity": 1,
       "cost": 500
     },
     {
       "part_name": "电源模块",
       "part_code": "PS-002",
       "quantity": 1,
       "cost": 200
     }
   ]
   ```
9. 工单状态变更时，自动记录操作日志到service_ticket_log表（操作人、操作时间、状态变更、操作内容）
10. 工单提醒任务生成规则（集成待办任务系统）：
    - 工单创建后，立即生成待办任务"新工单【{ticket_no}】待处理"，分配给assigned_to（如果已分配）或售后主管
    - 工单响应超时提醒（根据优先级）：
      - urgent：2小时内未响应（status仍为pending）→ 生成高优先级待办任务
      - high：4小时内未响应 → 生成高优先级待办任务
      - medium：1个工作日内未响应 → 生成中优先级待办任务
      - low：2个工作日内未响应 → 生成低优先级待办任务
    - 工单处理超时提醒（根据优先级）：
      - urgent：8小时内未解决（status未变为resolved/closed）→ 生成逾期预警任务
      - high：24小时内未解决 → 生成逾期预警任务
      - medium：3个工作日内未解决 → 生成逾期预警任务
      - low：7个工作日内未解决 → 生成逾期预警任务
11. 客户满意度评价规则：
    - 仅状态为resolved或closed的工单才允许评价
    - 评分范围：1-5分（1=非常不满意，2=不满意，3=一般，4=满意，5=非常满意）
    - 评价提交后记录rated_at = 当前时间
12. 工单关闭规则：
    - 状态为resolved后，客户评价完成即可关闭
    - 如果客户7天内未评价，系统自动将工单状态从resolved变为closed
13. 工单被其他业务对象引用后（如售后回访记录），不允许删除，仅可标记为cancelled
14. 工单创建后自动生成售后回访计划：
    - 在customer_follow_up表创建一条记录：follow_up_type='after_sales'，next_follow_up_time = resolved_at + 7天

---

#### 7.10.2 服务工单操作记录表（service_ticket_log）

| 字段名 | 数据类型 | 约束 | 说明 |
|-------|---------|------|------|
| log_id | BIGINT | PK, AUTO_INCREMENT | 日志记录ID |
| ticket_id | BIGINT | NOT NULL, FK | 工单ID（外键关联service_ticket） |
| log_type | VARCHAR(50) | NOT NULL | 日志类型（status_change=状态变更，assign=分配/转派，update=更新内容，comment=备注，rating=客户评价） |
| old_status | VARCHAR(20) | NULL | 变更前状态（仅log_type=status_change时有值） |
| new_status | VARCHAR(20) | NULL | 变更后状态（仅log_type=status_change时有值） |
| old_assigned_to | BIGINT | NULL | 变更前处理人ID（仅log_type=assign时有值） |
| new_assigned_to | BIGINT | NULL | 变更后处理人ID（仅log_type=assign时有值） |
| log_content | TEXT | NOT NULL | 日志内容（操作描述或备注） |
| attachment_urls | TEXT | NULL | 附件URL列表（JSON数组格式，如现场照片） |
| **审计字段** | | | |
| created_by | BIGINT | NOT NULL, FK | 操作人ID（关联用户表） |
| created_at | DATETIME | NOT NULL | 操作时间 |

**索引**：
- PRIMARY KEY (log_id)
- INDEX (ticket_id)
- INDEX (log_type)
- INDEX (created_by)
- INDEX (created_at)

**约束**：
- FOREIGN KEY (ticket_id) REFERENCES service_ticket(ticket_id) ON DELETE CASCADE
- FOREIGN KEY (created_by) REFERENCES user(user_id)

**业务规则**：
1. 工单状态变更时，自动创建日志记录：
   - log_type = 'status_change'
   - old_status = 变更前状态
   - new_status = 变更后状态
   - log_content = "{操作人姓名}将工单状态从{old_status}变更为{new_status}"
2. 工单分配/转派时，自动创建日志记录：
   - log_type = 'assign'
   - old_assigned_to = 变更前处理人ID（可为NULL）
   - new_assigned_to = 变更后处理人ID
   - log_content = "{操作人姓名}将工单分配给{新处理人姓名}"或"{操作人姓名}将工单从{原处理人姓名}转派给{新处理人姓名}"
3. 工单内容更新时，手动创建日志记录：
   - log_type = 'update'
   - log_content = 售后工程师填写的更新内容（如："已到达现场，正在检测故障"）
4. 添加备注时，手动创建日志记录：
   - log_type = 'comment'
   - log_content = 备注内容
5. 客户评价时，自动创建日志记录：
   - log_type = 'rating'
   - log_content = "客户评分：{customer_rating}分，反馈：{customer_feedback}"
6. 删除工单时，自动删除所有关联日志（ON DELETE CASCADE）
7. 日志记录按创建时间倒序排列，展示工单处理全过程
8. attachment_urls支持上传现场照片、维修前后对比照片等

**查询示例**（工单详情页展示操作日志时间线）：
```sql
-- 查询工单的完整操作日志（时间线）
SELECT
  l.log_id,
  l.log_type,
  l.old_status,
  l.new_status,
  u_old.real_name AS old_assigned_to_name,
  u_new.real_name AS new_assigned_to_name,
  l.log_content,
  l.attachment_urls,
  u_creator.real_name AS created_by_name,
  l.created_at
FROM service_ticket_log l
LEFT JOIN user u_old ON l.old_assigned_to = u_old.user_id
LEFT JOIN user u_new ON l.new_assigned_to = u_new.user_id
INNER JOIN user u_creator ON l.created_by = u_creator.user_id
WHERE l.ticket_id = ?
ORDER BY l.created_at DESC;
```

---

**售后服务模块数据查询示例**：

```sql
-- 查询工单列表（带客户、产品、处理人信息）
SELECT
  t.ticket_id,
  t.ticket_no,
  t.ticket_type,
  t.ticket_title,
  t.priority,
  t.status,
  cust.customer_name,
  cust.customer_code,
  t.product_name,
  t.product_code,
  t.is_under_warranty,
  t.warranty_end_date,
  t.total_cost,
  u_assigned.real_name AS assigned_to_name,
  t.reported_at,
  t.first_response_at,
  t.resolved_at,
  t.customer_rating,
  t.created_at
FROM service_ticket t
INNER JOIN customer cust ON t.customer_id = cust.customer_id
LEFT JOIN user u_assigned ON t.assigned_to = u_assigned.user_id
WHERE t.deleted_at IS NULL
ORDER BY t.priority DESC, t.reported_at DESC;
```

```sql
-- 查询工单详情（含合同、联系人、费用明细）
SELECT
  t.*,
  cust.customer_name,
  cust.customer_code,
  cc.contact_name,
  cc.mobile AS contact_mobile,
  c.contract_no,
  c.warranty_start_date AS contract_warranty_start_date,
  c.warranty_end_date AS contract_warranty_end_date,
  u_assigned.real_name AS assigned_to_name,
  u_reported.real_name AS reported_by_name,
  u_created.real_name AS created_by_name
FROM service_ticket t
INNER JOIN customer cust ON t.customer_id = cust.customer_id
LEFT JOIN customer_contact cc ON t.customer_contact_id = cc.contact_id
LEFT JOIN contract c ON t.contract_id = c.contract_id
LEFT JOIN user u_assigned ON t.assigned_to = u_assigned.user_id
LEFT JOIN user u_reported ON t.reported_by = u_reported.user_id
LEFT JOIN user u_created ON t.created_by = u_created.user_id
WHERE t.ticket_id = ? AND t.deleted_at IS NULL;
```

```sql
-- 查询售后服务统计（按工单类型、优先级、状态汇总）
SELECT
  t.ticket_type,
  t.priority,
  t.status,
  COUNT(*) AS ticket_count,
  AVG(TIMESTAMPDIFF(HOUR, t.reported_at, t.first_response_at)) AS avg_response_hours,
  AVG(TIMESTAMPDIFF(HOUR, t.first_response_at, t.resolved_at)) AS avg_resolve_hours,
  AVG(t.customer_rating) AS avg_rating,
  SUM(t.total_cost) AS total_cost
FROM service_ticket t
WHERE t.deleted_at IS NULL
  AND t.reported_at >= ?
  AND t.reported_at < ?
GROUP BY t.ticket_type, t.priority, t.status
ORDER BY t.priority DESC, ticket_count DESC;
```

```sql
-- 查询质保期即将到期的工单（提醒客户延保）
SELECT
  t.ticket_id,
  t.ticket_no,
  cust.customer_name,
  t.warranty_end_date,
  DATEDIFF(t.warranty_end_date, CURDATE()) AS days_to_expiry
FROM service_ticket t
INNER JOIN customer cust ON t.customer_id = cust.customer_id
WHERE t.deleted_at IS NULL
  AND t.warranty_end_date IS NOT NULL
  AND t.warranty_end_date BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 30 DAY)
  AND t.status NOT IN ('closed', 'cancelled')
ORDER BY t.warranty_end_date ASC;
```

---

## 8. 功能需求（User Stories & Acceptance Criteria）

### 8.1 产品管理需求

#### 需求 PRD-001：产品分类管理

**User Story**：
作为系统管理员，我希望能够管理产品分类，以便对200-300个产品SKU进行有序归类。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我进入产品分类管理页面
Then 我应该能看到所有产品分类列表（显示分类名称、编码、产品数量）
And 我可以新增分类（输入分类名称、编码、排序号、描述）
And 我可以编辑已有分类
And 我可以停用/启用分类
And 删除分类时，如果该分类下有产品，系统应提示"该分类下有N个产品，无法删除"并阻止删除

Given 我尝试创建新分类
When 我输入分类编码为"CHECKIN"
And 系统中已存在编码为"CHECKIN"的分类
Then 系统应提示"分类编码已存在"并阻止保存
```

**优先级**：P0（高）
**依赖**：无
**关联模块**：产品管理

---

#### 需求 PRD-002：产品SKU新增与编辑

**User Story**：
作为系统管理员或运营人员，我希望能够录入和维护产品信息，以便销售人员在报价时选择使用。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员或运营人员
When 我进入产品管理页面点击"新增产品"
Then 我应该看到产品录入表单，包含以下必填项：
  - 产品编码（自动生成或手工输入）
  - 产品名称
  - 产品分类（下拉选择）
  - 成本价
  - 报价
And 可选填项：
  - 供应商
  - 单位（默认"台"）
  - 产品图片（支持上传多张）
  - 产品描述/备注
And 我填写完成点击保存后，系统应提示"保存成功"并跳转到产品列表

Given 我输入的产品编码已存在
When 我点击保存
Then 系统应提示"产品编码已存在，请修改"并阻止保存

Given 我输入的成本价为负数
When 我点击保存
Then 系统应提示"成本价不能为负数"并阻止保存

Given 我保存了一个新产品
When 未设置产品状态
Then 系统应默认设置为"草稿"状态
And 该产品在报价单选择器中不可见
```

**优先级**：P0（高）
**依赖**：PRD-001（产品分类管理）
**关联模块**：报价单、合同管理

---

#### 需求 PRD-003：产品状态管理

**User Story**：
作为系统管理员，我希望能够管理产品的在售状态，以便控制哪些产品可以用于报价。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我查看产品列表
Then 我应该能看到每个产品的状态标签（草稿/在售/停售）
And 我可以点击"上架"按钮将"草稿"状态改为"在售"
And 我可以点击"下架"按钮将"在售"状态改为"停售"

Given 某个产品状态为"草稿"或"停售"
When 销售人员在报价单中选择产品
Then 该产品不应出现在可选产品列表中

Given 某个产品状态为"在售"
When 销售人员在报价单中选择产品
Then 该产品应出现在可选产品列表中

Given 某个产品已被合同或报价单引用
When 管理员尝试删除该产品
Then 系统应提示"该产品已被N个合同/报价单引用，无法删除，仅可下架"并阻止删除
```

**优先级**：P0（高）
**依赖**：PRD-002
**关联模块**：报价单、合同管理

---

#### 需求 PRD-004：产品搜索与筛选

**User Story**：
作为销售人员或管理员，我希望能够快速搜索和筛选产品，以便在200-300个SKU中快速找到目标产品。

**Acceptance Criteria**：
```gherkin
Given 我在产品列表页面
When 我在搜索框输入关键词（如"智能门锁"）
Then 系统应实时搜索产品名称、产品编码、供应商字段
And 显示匹配的产品列表

Given 我在产品列表页面
When 我选择分类筛选（如"自助入住机"）
Then 系统应只显示该分类下的产品

Given 我在产品列表页面
When 我选择状态筛选（如"在售"）
Then 系统应只显示该状态的产品

Given 我同时使用关键词搜索和分类筛选
When 我输入关键词"门锁"并选择分类"开关"
Then 系统应显示分类为"开关"且名称包含"门锁"的产品（组合筛选）
```

**优先级**：P1（中高）
**依赖**：PRD-002
**关联模块**：无

---

#### 需求 PRD-005：产品数据导入导出

**User Story**：
作为系统管理员，我希望能够批量导入产品数据，以便快速初始化200-300个SKU。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我进入产品管理页面点击"导入"
Then 我应该能下载Excel模板（包含所有必填和可选字段）
And 我上传填写好的Excel文件后
And 系统应校验数据格式（产品编码唯一性、价格非负数等）
And 校验通过后导入数据
And 显示导入结果（成功N条，失败N条，并列出失败原因）

Given 我是系统管理员或运营人员
When 我进入产品管理页面点击"导出"
Then 系统应导出当前筛选条件下的产品数据为Excel文件
And Excel应包含所有字段（含自定义字段）

Given 导入的Excel中某行产品编码与现有产品重复
When 系统执行导入
Then 该行应导入失败，并在失败报告中提示"产品编码重复：CHECKIN-A100"
And 其他行不受影响，继续导入
```

**优先级**：P1（中高）
**依赖**：PRD-002
**关联模块**：无

---

#### 需求 PRD-006：产品信息历史快照（关联数据保护）

**User Story**：
作为财务人员或销售人员，我希望历史合同和报价单中的产品信息不受当前产品信息修改的影响，以便确保历史数据的准确性。

**Acceptance Criteria**：
```gherkin
Given 某个产品的报价为1000元
And 该产品已被某个报价单引用
When 管理员将该产品的报价修改为1200元
Then 该报价单中的产品价格应仍显示为1000元（使用快照数据）
And 新创建的报价单应使用新价格1200元

Given 某个产品的名称为"智能门锁-X200"
And 该产品已被某个合同引用
When 管理员将产品名称修改为"智能门锁-X200-升级版"
Then 该合同中的产品名称应仍显示为"智能门锁-X200"
And 新创建的合同应使用新名称
```

**优先级**：P0（高）
**依赖**：PRD-002
**关联模块**：报价单、合同管理

**技术实现建议**：
- 报价单明细表、合同明细表应冗余存储产品名称、价格等关键信息（快照）
- 仅保留product_id作为外键用于查询当前产品信息

### 8.2 客户管理需求

#### 需求 CRM-001：客户信息录入与编辑

**User Story**：
作为营销人员或销售人员，我希望能够录入和维护客户信息，以便建立完整的客户档案。

**Acceptance Criteria**：
```gherkin
Given 我是营销人员或销售人员
When 我进入客户管理页面点击"新增客户"
Then 我应该看到客户录入表单，包含以下必填项：
  - 客户名称（公司名称）
  - 客户类型（连锁酒店集团/单体酒店/经销商）
  - 客户阶段（默认为"销售线索"）
And 可选填项：
  - 客户等级（A/B/C）
  - 行业、省份、城市、详细地址
  - 联系电话
  - 酒店房间数量、酒店星级
  - 客户来源
  - 备注
And 我填写完成点击保存后，系统应自动生成客户编码（如CUST-20251222-001）
And 系统应提示"保存成功，请添加联系人"并跳转到联系人录入页面

Given 我保存客户时未填写客户名称
When 我点击保存
Then 系统应提示"客户名称为必填项"并阻止保存

Given 我创建的客户名称与现有客户重复
When 我点击保存
Then 系统应提示"客户名称已存在，是否继续创建？"供用户确认（允许同名客户，但需提醒）
```

**优先级**：P0（高）
**依赖**：无
**关联模块**：联系人管理、跟进记录管理

---

#### 需求 CRM-002：客户联系人管理

**User Story**：
作为销售人员，我希望能够为每个客户维护多个联系人信息，以便与不同部门的负责人沟通。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
When 我进入客户详情页面的"联系人"标签
Then 我应该能看到该客户的所有联系人列表（显示姓名、职位、手机、主要联系人标识）
And 我可以点击"新增联系人"录入新联系人
And 联系人表单包含：姓名（必填）、职位、手机号、微信号、邮箱、是否主要联系人、备注

Given 我为客户添加第一个联系人
When 我保存联系人
Then 系统应自动将该联系人设为"主要联系人"

Given 客户已有主要联系人A
When 我将另一个联系人B设为"主要联系人"
Then 系统应自动取消联系人A的"主要联系人"标识
And 仅保留联系人B为主要联系人

Given 我尝试删除主要联系人
And 该客户只有这一个联系人
When 我点击删除
Then 系统应提示"主要联系人不可删除，请先指定其他联系人为主要联系人"并阻止删除

Given 联系人的手机号、微信、邮箱都未填写
When 我保存联系人
Then 系统应提示"手机号、微信、邮箱至少填写一项"并阻止保存
```

**优先级**：P0（高）
**依赖**：CRM-001
**关联模块**：客户管理

---

#### 需求 CRM-003：客户阶段管理与推进

**User Story**：
作为销售人员，我希望能够管理客户的生命周期阶段，以便跟踪销售进展。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
When 我查看客户详情
Then 我应该能看到当前客户阶段（销售线索/初步接触/意向客户/商务洽谈/成交客户/流失客户）
And 我可以点击"推进阶段"按钮选择下一个阶段
And 推进时需填写"阶段变更原因"

Given 客户当前阶段为"销售线索"
When 我点击"推进阶段"
Then 系统应显示可选阶段：初步接触、流失客户
And 我选择"初步接触"并填写原因"已电话联系客户"后保存
And 系统应更新客户阶段为"初步接触"
And 系统应更新stage_updated_at字段为当前时间

Given 客户当前阶段为"成交客户"
When 我查看"推进阶段"按钮
Then 该按钮应不可用或隐藏（成交客户已是最终阶段）

Given 客户阶段为"成交客户"
When 系统显示客户等级字段
Then 该字段应为可编辑状态（供销售设置A/B/C等级）

Given 客户阶段为"销售线索"
When 系统显示客户等级字段
Then 该字段应为灰色不可编辑（仅成交后可设置等级）
```

**优先级**：P0（高）
**依赖**：CRM-001
**关联模块**：无

**说明**：客户跟进记录功能在"客户回访模块"中实现，本需求不涉及跟进记录管理。

---

#### 需求 CRM-004：客户搜索与筛选

**User Story**：
作为销售人员，我希望能够快速搜索和筛选客户，以便高效管理客户资源。

**Acceptance Criteria**：
```gherkin
Given 我在客户列表页面
When 我在搜索框输入关键词（如"希尔顿"）
Then 系统应实时搜索客户名称、地址、备注字段
And 显示匹配的客户列表

Given 我在客户列表页面
When 我选择客户阶段筛选（如"意向客户"）
Then 系统应只显示该阶段的客户

Given 我在客户列表页面
When 我选择客户类型筛选（如"连锁酒店集团"）
Then 系统应只显示该类型的客户

Given 我在客户列表页面
When 我选择地区筛选（省份"广东省"，城市"深圳市"）
Then 系统应只显示该地区的客户

Given 我在客户列表页面
When 我选择负责人筛选（如"张三"）
Then 系统应只显示张三负责的客户

Given 我在客户列表页面
When 我选择客户来源筛选（如"新媒体营销"）
Then 系统应只显示来源为"新媒体营销"的客户

Given 我同时使用多个筛选条件
When 我选择阶段"意向客户"、类型"单体酒店"、负责人"张三"
Then 系统应显示同时满足这三个条件的客户（组合筛选）
```

**优先级**：P1（中高）
**依赖**：CRM-001
**关联模块**：无

---

#### 需求 CRM-005：客户负责人转移

**User Story**：
作为销售主管或管理员，我希望能够转移客户的负责人，以便在人员变动时重新分配客户资源。

**Acceptance Criteria**：
```gherkin
Given 我是销售主管或管理员
When 我在客户详情页面点击"转移负责人"
Then 系统应显示负责人选择器（显示所有销售人员列表）
And 我选择新负责人"李四"
And 我填写转移原因"原负责人张三离职"
When 我确认转移
Then 系统应更新客户的owner_id为李四的用户ID
And 系统应在操作审计日志中记录负责人变更（内容包含原负责人、新负责人、转移原因）
And 系统应向新负责人李四发送通知（如有通知模块）
```

**优先级**：P1（中高）
**依赖**：CRM-001
**关联模块**：用户管理、操作审计日志

---

#### 需求 CRM-006：客户数据导入导出

**User Story**：
作为营销人员或管理员，我希望能够批量导入销售线索，以便快速初始化客户数据。

**Acceptance Criteria**：
```gherkin
Given 我是营销人员或管理员
When 我进入客户管理页面点击"导入"
Then 我应该能下载Excel模板（包含所有必填和可选字段）
And 我上传填写好的Excel文件后
And 系统应校验数据格式（客户名称非空等）
And 校验通过后导入数据
And 显示导入结果（成功N条，失败N条，并列出失败原因）

Given 我是销售人员或管理员
When 我进入客户管理页面点击"导出"
Then 系统应导出当前筛选条件下的客户数据为Excel文件
And Excel应包含客户基本信息、联系人信息

Given 导入的Excel中某行客户名称为空
When 系统执行导入
Then 该行应导入失败，并在失败报告中提示"第N行：客户名称不能为空"
And 其他行不受影响，继续导入

Given 导入的Excel中包含联系人信息（姓名、手机等列）
When 系统执行导入
Then 系统应同时创建客户和对应的联系人记录
And 自动将首个联系人设为主要联系人
```

**优先级**：P1（中高）
**依赖**：CRM-001, CRM-002
**关联模块**：无

---

#### 需求 CRM-007：客户全流程关联查看

**User Story**：
作为销售人员或管理员，我希望能够在客户详情页查看该客户的全流程业务记录，以便全面了解客户情况。

**Acceptance Criteria**：
```gherkin
Given 我在客户详情页面
When 我查看页面标签
Then 我应该能看到以下标签页：
  - 基本信息（客户基本信息+编辑）
  - 联系人（联系人列表+新增）
  - 报价单（该客户的所有报价单，显示报价单号、金额、创建时间、状态）
  - 合同（该客户的所有合同，显示合同号、金额、签订时间、状态）
  - 发票（该客户的所有发票，显示发票号、金额、开票时间、状态）
  - 收款记录（该客户的所有收款记录，显示收款金额、收款时间）

Given 我在客户详情的"报价单"标签
When 我查看报价单列表
Then 列表应按创建时间倒序排列
And 我可以点击报价单号跳转到报价单详情页
And 我可以点击"新建报价单"快速为该客户创建报价单（自动带入客户信息）

Given 客户"希尔顿酒店"有3个合同，总金额100万
When 我查看客户详情的"基本信息"标签
Then 我应该能看到该客户的统计数据：
  - 合同数量：3
  - 合同总金额：1,000,000元
  - 阶段最后更新时间：2025-12-20
```

**优先级**：P0（高）
**依赖**：CRM-001，报价单模块、合同模块、财务模块
**关联模块**：报价单、合同、发票、收款

**说明**：客户跟进记录相关的标签页和统计数据在"客户回访模块"中实现。

### 8.3 用户角色权限管理需求

#### 需求 AUTH-001：用户登录

**User Story**：
作为系统用户，我希望能够使用手机号和密码登录系统，以便访问我的工作台。

**Acceptance Criteria**：
```gherkin
Given 我是注册用户
When 我在登录页面输入正确的手机号和密码
And 我的账户状态为"启用"
Then 系统应验证通过并跳转到工作台
And 系统应生成登录Token（JWT）并存储到Cookie或LocalStorage
And 系统应记录最后登录时间和IP到用户表
And 系统应在审计日志中记录登录操作

Given 我输入的密码错误
When 我点击登录
Then 系统应提示"手机号或密码错误"
And 系统应增加failed_login_count计数
And 若失败次数达到5次，系统应锁定账户30分钟

Given 我的账户被锁定（locked_until未过期）
When 我尝试登录
Then 系统应提示"账户已锁定，请30分钟后重试"
And 不允许登录

Given 我的账户状态为"禁用"（is_active=0）
When 我尝试登录
Then 系统应提示"账户已被禁用，请联系管理员"
And 不允许登录

Given 我是首次登录（is_first_login=1）
When 我登录成功
Then 系统应强制跳转到修改密码页面
And 提示"首次登录，请修改初始密码"
And 修改密码成功后，设置is_first_login=0
```

**优先级**：P0（高）
**依赖**：无
**关联模块**：操作审计日志

---

#### 需求 AUTH-002：用户管理

**User Story**：
作为系统管理员，我希望能够管理系统用户账户，以便为团队成员分配系统访问权限。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我进入用户管理页面点击"新增用户"
Then 我应该看到用户录入表单，包含必填项：
  - 真实姓名
  - 手机号
  - 初始密码
  - 所属角色（可多选）
And 可选填项：
  - 用户工号
  - 邮箱
  - 头像

Given 我填写完成点击保存
When 手机号未被占用且密码符合强度要求（至少8位，包含大小写字母和数字）
Then 系统应创建用户并提示"保存成功"
And 系统应自动设置is_first_login=1（首次登录强制修改密码）
And 系统应在审计日志中记录"新增用户"操作

Given 我输入的手机号已被占用
When 我点击保存
Then 系统应提示"手机号已存在"并阻止保存

Given 我输入的密码为"123456"（不符合强度要求）
When 我点击保存
Then 系统应提示"密码强度不足，至少8位且包含大小写字母和数字"并阻止保存

Given 我在用户列表点击"编辑"
When 我修改用户的姓名或角色
Then 系统应更新用户信息
And 系统应在审计日志中记录"修改用户"操作
```

**优先级**：P0（高）
**依赖**：AUTH-001
**关联模块**：角色管理、操作审计日志

---

#### 需求 AUTH-003：用户启用/禁用

**User Story**：
作为系统管理员，我希望能够启用或禁用用户账户，以便在人员离职或暂时离开时控制系统访问。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我在用户列表点击某个启用用户的"禁用"按钮
Then 系统应提示"确认禁用该用户？禁用后该用户将无法登录系统"
And 我确认后，系统应设置该用户的is_active=0
And 系统应在审计日志中记录"禁用用户"操作

Given 某个用户被禁用
When 该用户尝试登录
Then 系统应提示"账户已被禁用，请联系管理员"

Given 我尝试禁用最后一个启用状态的系统管理员
When 我点击"禁用"
Then 系统应提示"至少保留一个启用状态的系统管理员"并阻止操作

Given 我在用户列表点击某个禁用用户的"启用"按钮
When 我确认启用
Then 系统应设置该用户的is_active=1
And 系统应在审计日志中记录"启用用户"操作
```

**优先级**：P0（高）
**依赖**：AUTH-002
**关联模块**：操作审计日志

---

#### 需求 AUTH-004：用户密码重置

**User Story**：
作为系统管理员，我希望能够重置用户密码，以便在用户忘记密码时提供帮助。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我在用户列表点击某个用户的"重置密码"按钮
Then 系统应显示密码重置弹窗，要求输入新密码
And 新密码需符合强度要求（至少8位，包含大小写字母和数字）

Given 我输入新密码"NewPass123"并确认
When 我点击"确认重置"
Then 系统应更新用户的password_hash（使用bcrypt哈希）
And 系统应设置is_first_login=1（强制用户首次登录修改密码）
And 系统应在审计日志中记录"重置用户密码"操作
And 系统应提示"密码重置成功，用户首次登录时需修改密码"

Given 我是普通用户
When 我在个人中心点击"修改密码"
Then 我应该能输入旧密码和新密码
And 系统应验证旧密码正确后，更新为新密码
And 系统应在审计日志中记录"修改个人密码"操作
```

**优先级**：P1（中高）
**依赖**：AUTH-002
**关联模块**：操作审计日志

---

#### 需求 AUTH-005：角色权限配置

**User Story**：
作为系统管理员，我希望能够为每个角色配置可访问的功能模块，以便控制不同岗位的权限范围。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我进入角色管理页面
Then 我应该能看到5个固定角色列表：系统管理员、营销人员、销售人员、财务人员、运营人员
And 每个角色显示：角色名称、描述、权限数量

Given 我点击某个角色的"配置权限"按钮（如"销售人员"）
When 系统显示权限配置页面
Then 我应该能看到所有功能模块的树形列表（产品管理、客户管理、报价单、合同等）
And 每个模块前有复选框，当前角色已有的权限应勾选

Given 我为"销售人员"角色勾选"客户管理"、"报价单管理"、"合同管理"
When 我点击"保存"
Then 系统应更新role_permission表，删除未勾选的权限，新增勾选的权限
And 系统应在审计日志中记录"修改角色权限：销售人员"操作
And 系统应提示"权限配置成功，已登录用户需重新登录生效"

Given "销售人员"角色被配置了"客户管理"权限
When 具有"销售人员"角色的用户张三登录系统
Then 张三应该能在菜单中看到"客户管理"模块
And 张三不应该能看到未配置权限的模块（如"用户管理"）

Given 我尝试编辑角色名称和描述
When 我修改"销售人员"的描述为"负责客户跟进、报价、合同签订"
Then 系统应允许修改并保存
And 系统应在审计日志中记录"修改角色信息"操作

Given 我尝试删除角色
When 我点击"删除"按钮
Then 系统应提示"系统内置角色不可删除"并阻止操作
```

**优先级**：P0（高）
**依赖**：AUTH-002
**关联模块**：权限管理、操作审计日志

---

#### 需求 AUTH-006：用户角色分配

**User Story**：
作为系统管理员，我希望能够为用户分配一个或多个角色，以便灵活适应一人多职的情况。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我在编辑用户页面查看"所属角色"字段
Then 我应该能看到角色多选框，显示5个固定角色
And 已分配的角色应勾选

Given 我为用户张三勾选"销售人员"和"财务人员"两个角色
When 我保存
Then 系统应在user_role表中创建两条关联记录
And 系统应在审计日志中记录"分配角色：张三 → 销售人员,财务人员"操作

Given 用户张三拥有"销售人员"和"财务人员"两个角色
When 张三登录系统
Then 张三应该能看到这两个角色的所有权限的并集
And 张三可以访问"客户管理"（销售权限）和"发票管理"（财务权限）

Given 我尝试取消用户的所有角色
When 我保存
Then 系统应提示"用户至少需要一个角色"并阻止保存

Given 用户张三已分配"销售人员"角色
When 我再次为张三分配"销售人员"角色
Then 系统应忽略重复分配（通过UNIQUE KEY约束）
```

**优先级**：P0（高）
**依赖**：AUTH-002, AUTH-005
**关联模块**：角色管理、操作审计日志

---

#### 需求 AUTH-007：操作审计日志查询

**User Story**：
作为系统管理员，我希望能够查询操作审计日志，以便追溯系统中的关键操作和排查问题。

**Acceptance Criteria**：
```gherkin
Given 我是系统管理员
When 我进入操作日志页面
Then 我应该能看到日志列表（按时间倒序，最新的在最前面）
And 每条日志显示：操作时间、操作人、操作模块、操作类型、操作描述、IP地址

Given 我在日志查询页面
When 我使用筛选条件：
  - 操作人：张三
  - 操作模块：客户管理
  - 操作类型：修改
  - 时间范围：2025-12-01 至 2025-12-22
Then 系统应显示符合条件的日志记录

Given 我点击某条日志的"详情"按钮
When 系统显示日志详情弹窗
Then 我应该能看到完整的请求参数和响应状态

Given 系统记录了包含密码的操作（如修改密码）
When 我查看该日志的请求参数
Then 密码字段应显示为"******"（已脱敏）

Given 我尝试删除某条日志
When 我点击"删除"按钮
Then 系统应提示"审计日志不允许删除"并阻止操作

Given 日志数量超过100万条
When 系统自动执行日志归档任务
Then 超过1年的日志应被归档到冷存储（或单独的归档表）
And 归档日志仍可通过"归档日志查询"功能访问
```

**优先级**：P1（中高）
**依赖**：AUTH-002
**关联模块**：无

---

#### 需求 AUTH-008：登录Token管理与自动登出

**User Story**：
作为系统用户，我希望系统能够安全管理我的登录状态，并在长时间不操作时自动登出。

**Acceptance Criteria**：
```gherkin
Given 我成功登录系统
When 系统生成JWT Token
Then Token应包含以下信息：
  - user_id（用户ID）
  - mobile（手机号）
  - roles（角色列表）
  - permissions（权限列表）
  - exp（过期时间，默认7天）
And Token应存储到Cookie或LocalStorage

Given 我的Token有效期为7天
And 我在第6天再次访问系统
When 系统检测到Token即将过期（剩余时间<24小时）
Then 系统应自动刷新Token，延长有效期到新的7天

Given 我的Token已过期
When 我访问系统任何需要登录的页面
Then 系统应提示"登录已过期，请重新登录"
And 自动跳转到登录页面

Given 我在工作台页面无任何操作
When 超过30分钟未操作（前端检测）
Then 系统应弹窗提示"长时间未操作，即将自动登出"
And 倒计时60秒
And 若60秒内仍无操作，系统应清除Token并跳转到登录页面

Given 我点击"退出登录"按钮
When 我确认退出
Then 系统应清除Token
And 系统应在审计日志中记录"登出"操作
And 跳转到登录页面
```

**优先级**：P1（中高）
**依赖**：AUTH-001
**关联模块**：操作审计日志

---

### 8.4 销售线索管理需求

#### 需求 LEAD-001：线索录入

**User Story**：
作为营销人员或销售人员，我希望能够快速录入销售线索，以便将潜在客户信息录入系统进行后续跟进。

**Acceptance Criteria**：
```gherkin
Given 我是营销人员或销售人员
When 我进入线索管理页面点击"新增线索"
Then 我应该看到线索录入表单，包含以下必填项：
  - 客户名称（公司名称）
  - 客户类型（连锁酒店集团/单体酒店/经销商/民宿/公寓）
  - 主要联系人姓名
  - 联系方式（手机号/微信/邮箱至少一项）
And 可选填项：
  - 省份、城市、详细地址
  - 酒店房间数、酒店星级
  - 客户来源（新媒体营销/线下展会/老客户转介绍/官网咨询/电话来访/其他）
  - 备注
And 负责人分配选项：
  - 立即指定销售人员（下拉选择，系统推荐销售角色用户）
  - 或选择"暂不分配"（进入公共线索池，owner_id=NULL）

Given 我选择"立即指定销售人员"
When 我点击负责人下拉框
Then 系统应显示所有销售角色的用户列表
And 系统应在列表顶部标注"推荐"用户（销售角色且is_active=1）

Given 我填写完成并选择"立即指定销售人员"为张三
When 我点击保存
Then 系统应创建客户记录，设置customer_stage='lead'，owner_id=张三的user_id
And 系统应自动生成客户编码（如：CUST-20251223-001）
And 系统应创建至少一条联系人记录（is_primary=1）
And 系统应提示"线索保存成功，已分配给张三"
And 系统应生成待办任务提醒张三"新线索待跟进：[客户名称]"

Given 我选择"暂不分配"
When 我点击保存
Then 系统应创建客户记录，设置customer_stage='lead'，owner_id=NULL
And 线索进入公共线索池
And 系统应提示"线索保存成功，已进入公共线索池"

Given 我输入的客户名称为"北京悦华酒店"
And 系统中已存在同名客户
When 我点击保存
Then 系统应提示"客户名称已存在，是否继续创建？（可能是重复线索）"
And 我确认后允许创建（允许同名客户，通过customer_code区分）

Given 我输入的联系人手机号为"13800138000"
And 系统中已有其他客户使用该手机号
When 我点击保存
Then 系统应弹窗警告"该手机号已关联客户：[客户名称]，可能是重复线索"
And 我确认后允许创建
```

**优先级**：P0（高）
**依赖**：CRM-001（客户信息录入），AUTH-002（用户管理）
**关联模块**：客户管理、待办任务

---

#### 需求 LEAD-002：线索分配与领取

**User Story**：
作为销售人员，我希望能够从公共线索池中领取线索或接收分配的线索，以便开始跟进潜在客户。

**Acceptance Criteria**：
```gherkin
# 场景1：销售人员主动领取线索
Given 我是销售人员
When 我进入"公共线索池"页面
Then 我应该能看到所有owner_id=NULL且customer_stage='lead'的线索列表
And 列表显示：客户名称、客户类型、来源、创建时间、联系方式
And 列表不显示已标记为inactive的线索

Given 我在公共线索池点击某条线索的"领取"按钮
When 我确认领取
Then 系统应设置该线索的owner_id=我的user_id
And 系统应提示"领取成功，请及时跟进"
And 该线索应从公共线索池移除，进入我的"我的线索"列表
And 系统应生成待办任务"新线索待跟进：[客户名称]"

# 场景2：管理员手动分配线索
Given 我是系统管理员
When 我在线索列表选择一条owner_id=NULL的线索，点击"分配"按钮
Then 系统应显示销售人员选择弹窗，列出所有销售角色且is_active=1的用户

Given 我选择销售人员李四
When 我点击"确认分配"
Then 系统应设置该线索的owner_id=李四的user_id
And 系统应生成待办任务提醒李四"新分配线索待跟进：[客户名称]"
And 系统应在跟进记录中自动创建一条记录：
  - follow_up_type='sales'
  - follow_up_content='线索由管理员[姓名]分配给销售[李四姓名]'
  - creator_id=管理员user_id

# 场景3：营销人员转交线索给销售
Given 我是营销人员，我创建了一条线索（owner_id=我的user_id）
When 我在线索详情页点击"转交"按钮
Then 系统应显示销售人员选择弹窗

Given 我选择销售人员王五
When 我点击"确认转交"
Then 系统应设置该线索的owner_id=王五的user_id
And 系统应生成待办任务提醒王五"新转交线索待跟进：[客户名称]"
And 系统应在跟进记录中记录转交操作

# 场景4：销售负责人之间的线索转移
Given 我是销售人员，我负责线索A（owner_id=我的user_id）
When 我点击线索A的"转交"按钮并选择另一个销售人员赵六
Then 系统应允许转交
And 系统应设置该线索的owner_id=赵六的user_id
And 系统应在跟进记录中记录"线索由[我的姓名]转交给[赵六姓名]"

Given 我尝试将线索分配给已禁用的用户（is_active=0）
When 我点击"确认分配"
Then 系统应提示"该用户已被禁用，无法分配线索"并阻止操作
```

**优先级**：P0（高）
**依赖**：LEAD-001
**关联模块**：待办任务、客户跟进记录

---

#### 需求 LEAD-003：线索跟进记录

**User Story**：
作为销售人员，我希望能够记录每次与线索客户的沟通情况，以便追踪销售进展和计划下次跟进。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
And 我负责线索A（owner_id=我的user_id）
When 我进入线索A的详情页点击"添加跟进记录"
Then 我应该看到跟进记录表单，包含必填项：
  - 跟进时间（默认当前时间，可修改）
  - 跟进方式（电话/微信/拜访/邮件/其他）
  - 跟进内容（文本框）
And 可选填项：
  - 联系的对方人员姓名
  - 客户反馈
  - 下次跟进计划时间
  - 下次跟进计划内容
  - 跟进结果（成功推进/待定/失败或拒绝）
  - 附件上传（聊天截图、邮件截图等）

Given 我填写跟进内容为"电话沟通，客户表示有采购意向，计划下周拜访"
And 设置下次跟进时间为"2025-12-30 14:00"
When 我点击保存
Then 系统应创建跟进记录，设置follow_up_type='sales'，creator_id=我的user_id
And 系统应生成待办任务"跟进线索：[客户名称]"，计划时间为2025-12-30 14:00
And 系统应在线索详情页的跟进时间线中显示该记录

Given 我在跟进记录中将客户阶段从'lead'推进到'initial_contact'
When 我勾选"本次跟进推进了客户阶段"并选择新阶段
Then 系统应更新customer表的customer_stage='initial_contact'
And 系统应在跟进记录中设置：
  - stage_before='lead'
  - stage_after='initial_contact'
  - is_stage_changed=1
And 系统应更新customer表的stage_updated_at为当前时间

Given 我尝试为公共线索池中的线索（owner_id=NULL）添加跟进记录
When 我点击"添加跟进记录"
Then 系统应提示"请先领取或分配该线索后再添加跟进记录"并阻止操作

Given 我上传跟进附件（微信聊天截图）
When 我保存跟进记录
Then 系统应将附件URL存储到attachment_urls字段（JSON数组格式）
And 在跟进记录详情中可点击查看或下载附件

Given 我在线索详情页查看跟进历史
When 我进入"跟进记录"标签页
Then 我应该能看到所有跟进记录的时间线（按跟进时间倒序）
And 每条记录显示：跟进人、跟进时间、跟进方式、跟进内容摘要
And 标记了阶段变更的记录应高亮显示"阶段推进：lead → initial_contact"
And 我可以点击展开查看完整跟进详情
```

**优先级**：P0（高）
**依赖**：LEAD-002
**关联模块**：客户跟进记录、待办任务

---

#### 需求 LEAD-004：线索阶段推进

**User Story**：
作为销售人员，我希望能够根据跟进情况推进线索阶段，以便清晰追踪销售漏斗的进展。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
And 我负责的线索A当前阶段为'lead'
When 我在线索详情页点击"推进阶段"按钮
Then 我应该看到阶段选择器，显示可推进的下一阶段：
  - initial_contact（初步接触）
  - prospect（意向客户）
  - negotiation（商务洽谈）

Given 我选择推进到'initial_contact'阶段
When 我点击"确认推进"
Then 系统应提示"推进阶段需同时添加跟进记录，记录推进原因"
And 弹出跟进记录表单，自动勾选"本次跟进推进了客户阶段"

Given 我填写跟进内容为"电话确认了采购需求，客户有明确意向"
When 我保存
Then 系统应更新customer_stage='initial_contact'
And 系统应更新stage_updated_at为当前时间
And 系统应创建跟进记录，记录阶段变更
And 系统应提示"阶段推进成功：销售线索 → 初步接触"

Given 线索阶段为'negotiation'（商务洽谈）
When 我点击"推进阶段"选择'client'（成交客户）
Then 系统应提示"线索转化为成交客户需在合同模块中操作，签订合同后自动推进"
And 阻止直接推进到'client'阶段（必须通过合同签订流程）

Given 我是管理员
When 我强制修改线索阶段（如从'prospect'回退到'lead'）
Then 系统应允许操作
And 系统应在跟进记录中自动记录"管理员[姓名]强制修改阶段：prospect → lead，原因：[需填写]"
And 系统应弹窗要求填写回退原因

Given 线索A已标记为'inactive'（流失客户）
When 我尝试推进阶段
Then 系统应提示"流失客户无法推进阶段，如需恢复请先将状态改为active"并阻止操作

Given 我查看销售漏斗报表
When 我进入"线索分析"页面
Then 我应该能看到各阶段的线索数量统计：
  - 销售线索（lead）：X条
  - 初步接触（initial_contact）：X条
  - 意向客户（prospect）：X条
  - 商务洽谈（negotiation）：X条
And 显示各阶段的转化率
And 显示各阶段的平均停留时长（基于stage_updated_at计算）
```

**优先级**：P0（高）
**依赖**：LEAD-003
**关联模块**：客户跟进记录、合同管理

---

#### 需求 LEAD-005：线索池管理与筛选

**User Story**：
作为销售人员或管理员，我希望能够查看和管理不同状态的线索池，以便高效分配和跟进线索。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
When 我进入线索管理页面
Then 我应该能看到以下标签页分类：
  - 我的线索（owner_id=我的user_id，且stage in ['lead','initial_contact','prospect','negotiation']）
  - 公共线索池（owner_id=NULL，且stage='lead'，且customer_stage≠'inactive'）
  - 全部线索（所有线索，管理员可见全部，销售人员可见全部但仅能操作自己的）
  - 已流失（customer_stage='inactive'）

Given 我在"我的线索"标签页
When 系统加载线索列表
Then 列表应按创建时间倒序排列（最新的在最前面）
And 每条线索显示：
  - 客户名称
  - 客户类型
  - 当前阶段（用标签颜色区分：lead=灰色，initial_contact=蓝色，prospect=橙色，negotiation=绿色）
  - 来源渠道
  - 最后跟进时间
  - 下次跟进计划时间（若有）
  - 操作按钮（查看详情、添加跟进、推进阶段、转交、放弃）

Given 我在线索列表使用筛选器
When 我设置筛选条件：
  - 客户阶段：prospect
  - 来源：新媒体营销
  - 省份：北京
  - 创建时间：2025-12-01 至 2025-12-23
  - 负责人：张三
Then 系统应显示符合所有条件的线索列表

Given 我在线索列表使用搜索框
When 我输入关键词"悦华"
Then 系统应搜索客户名称、联系人姓名、手机号、备注字段
And 显示包含关键词的线索列表

Given 我在"我的线索"列表看到下次跟进时间为"2025-12-23 14:00"的线索
And 当前时间已超过该时间
When 系统加载列表
Then 该线索应标记为"逾期未跟进"（红色高亮或图标提示）
And 我的待办任务中应有对应的逾期提醒

Given 我是管理员
When 我在"全部线索"标签页
Then 我应该能看到所有销售人员的线索
And 我可以对任何线索执行：查看详情、强制分配、标记流失等操作

Given 我在公共线索池看到创建时间超过30天未被领取的线索
When 系统执行定期检查任务
Then 系统应在管理员的待办任务中提示"公共线索池有X条线索超过30天未分配，请处理"
```

**优先级**：P0（高）
**依赖**：LEAD-002
**关联模块**：待办任务

---

#### 需求 LEAD-006：线索放弃与回收

**User Story**：
作为销售人员，我希望能够放弃无效或无法跟进的线索，以便集中精力跟进有价值的线索。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
And 我负责线索A（owner_id=我的user_id）
When 我在线索详情页点击"放弃线索"按钮
Then 系统应弹窗提示"放弃线索后，该线索将退回公共线索池，其他销售可领取。确认放弃吗？"
And 弹窗要求我选择放弃原因：
  - 客户无明确需求
  - 客户预算不足
  - 联系不上客户
  - 其他（需填写具体原因）

Given 我选择放弃原因为"联系不上客户"
When 我点击"确认放弃"
Then 系统应设置该线索的owner_id=NULL（退回公共线索池）
And 系统应在跟进记录中自动创建一条记录：
  - follow_up_content='销售[我的姓名]放弃线索，原因：联系不上客户'
  - creator_id=我的user_id
And 系统应提示"线索已放弃，已退回公共线索池"
And 该线索应从我的"我的线索"列表移除，进入"公共线索池"

Given 我是管理员
And 销售人员张三负责线索B已超过60天未跟进（无跟进记录）
When 我在线索B详情页点击"回收线索"按钮
Then 系统应弹窗提示"确认回收该线索？回收后线索将退回公共线索池"
And 我确认后，系统应设置owner_id=NULL
And 系统应在跟进记录中记录"管理员[姓名]回收线索，原因：超过60天未跟进"
And 系统应生成待办任务通知张三"您的线索[客户名称]已被管理员回收"

Given 我是销售人员
When 我点击线索A的"标记为无效"按钮
Then 系统应弹窗提示"标记为无效后，该线索将不再出现在线索池，仅管理员可查看。确认标记吗？"
And 弹窗要求填写无效原因

Given 我填写无效原因为"客户信息错误，非目标客户"
When 我点击"确认标记"
Then 系统应设置customer_stage='inactive'
And 系统应在跟进记录中记录"线索标记为无效，原因：客户信息错误，非目标客户"
And 该线索应从所有线索池移除（公共池、我的线索）
And 该线索仅在"已流失"标签页可见

Given 管理员查看"已流失"标签页的线索
When 管理员点击某条无效线索的"恢复"按钮
Then 系统应弹窗提示"恢复后该线索将进入公共线索池，确认恢复吗？"
And 确认后，系统应设置customer_stage='lead'，owner_id=NULL
And 系统应在跟进记录中记录"管理员[姓名]恢复线索"
```

**优先级**：P1（中高）
**依赖**：LEAD-002
**关联模块**：客户跟进记录、待办任务

---

#### 需求 LEAD-007：线索批量导入

**User Story**：
作为营销人员，我希望能够批量导入线索数据，以便快速将展会或活动收集的大量线索录入系统。

**Acceptance Criteria**：
```gherkin
Given 我是营销人员或管理员
When 我进入线索管理页面点击"批量导入"按钮
Then 我应该能下载Excel模板文件，包含以下列：
  - 客户名称（必填）
  - 客户类型（必填，可选值：连锁酒店集团/单体酒店/经销商/民宿/公寓）
  - 联系人姓名（必填）
  - 联系人手机号
  - 联系人微信
  - 联系人邮箱（手机/微信/邮箱至少填一项）
  - 省份、城市、详细地址
  - 酒店房间数、酒店星级
  - 客户来源
  - 备注

Given 我填写完成Excel文件（包含50条线索数据）
When 我上传文件并点击"开始导入"
Then 系统应逐行校验数据：
  - 客户名称、客户类型、联系人姓名为必填
  - 联系人手机/微信/邮箱至少一项不为空
  - 客户类型必须在可选值范围内
And 校验通过后显示预览列表，标注有警告的行（如客户名称重复）

Given 预览列表中有3条数据校验失败（缺少必填项）
When 我点击"确认导入"
Then 系统应提示"有3条数据校验失败，是否仅导入校验通过的47条？"
And 我确认后，系统应导入47条线索
And 系统应为所有导入的线索设置：
  - customer_stage='lead'
  - owner_id=NULL（进入公共线索池）
  - creator_id=我的user_id
And 系统应提示"成功导入47条线索，3条失败，可下载失败数据查看原因"
And 提供失败数据的Excel下载链接（标注失败原因）

Given 批量导入的线索中有客户名称重复
When 导入完成
Then 系统应允许创建（同名客户通过customer_code区分）
And 在导入结果中标注"客户名称重复"警告
```

**优先级**：P1（中高）
**依赖**：LEAD-001
**关联模块**：客户管理

---

#### 需求 LEAD-008：线索导出与统计

**User Story**：
作为销售主管或管理员，我希望能够导出线索数据和查看统计报表，以便分析线索质量和转化效果。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员或管理员
When 我在线索列表页点击"导出"按钮
Then 系统应提示选择导出范围：
  - 当前筛选结果（导出当前筛选条件下的线索）
  - 我的线索（仅导出我负责的线索）
  - 全部线索（仅管理员可选）

Given 我选择"当前筛选结果"并确认
When 系统生成Excel文件
Then Excel应包含以下列：
  - 客户编码、客户名称、客户类型
  - 当前阶段、客户来源
  - 负责人姓名
  - 主要联系人姓名、手机号、微信、邮箱
  - 省份、城市、地址
  - 酒店房间数、酒店星级
  - 创建时间、最后跟进时间、下次跟进计划时间
  - 跟进次数（该线索的跟进记录总数）
  - 备注
And 系统应自动下载Excel文件（文件名：线索数据_YYYYMMDD_HHMMSS.xlsx）

Given 我是管理员
When 我进入"线索统计"页面
Then 我应该能看到以下统计数据：
  - 按来源统计：各来源渠道的线索数量、转化率
  - 按阶段统计：各阶段的线索数量、分布占比
  - 按负责人统计：各销售人员的线索数量、跟进次数、转化率
  - 按时间统计：本周/本月/本季度新增线索数量趋势图
And 支持时间范围筛选（如：2025-12-01 至 2025-12-23）

Given 我查看"按负责人统计"报表
When 系统展示数据
Then 列表应显示：
  - 销售人员姓名
  - 负责线索总数
  - 各阶段线索数量（lead/initial_contact/prospect/negotiation）
  - 平均跟进次数
  - 转化为成交客户的数量
  - 转化率（成交客户数 / 负责线索总数 × 100%）
And 支持按转化率降序排列

Given 我查看"线索转化漏斗"图表
When 系统加载数据
Then 应显示销售漏斗图：
  - lead（销售线索）：100条
  - initial_contact（初步接触）：60条（转化率60%）
  - prospect（意向客户）：30条（转化率30%）
  - negotiation（商务洽谈）：15条（转化率15%）
  - client（成交客户）：5条（转化率5%）
And 可点击各阶段查看明细列表
```

**优先级**：P1（中高）
**依赖**：LEAD-005
**关联模块**：无

---

### 8.5 报价单管理需求

#### 需求 QUOTE-001：创建报价单

**User Story**：
作为销售人员，我希望能够为客户/线索创建报价单，以便向客户提供正式的产品报价文档。

**Acceptance Criteria**：
```gherkin
Given 我是销售人员
When 我在客户详情页点击"创建报价单"或在报价单列表页点击"新增报价单"
Then 我应该看到报价单创建表单，包含以下字段：
  - 客户名称（必填，下拉选择或搜索客户）
  - 报价单标题（必填，默认值："{客户名称}智能硬件采购报价单"，可修改）
  - 客户联系人（可选，下拉选择该客户的联系人）
  - 有效期起止（生效日期默认为今天，失效日期默认为today+30天，可修改）
  - 付款条件（可选，文本框，如："合同签订后7日内支付30%定金"）
  - 交付条件（可选，文本框，如："款到15个工作日内发货"）
  - 备注（可选，文本框）
And 产品明细区域为空，提示"请添加产品"

Given 我选择的客户阶段为lead（销售线索）或initial_contact（初步接触）
When 系统检测到客户阶段
Then 系统应给出提示："建议先将客户推进至意向阶段（prospect）或商务洽谈阶段（negotiation）后再创建报价单"
And 提示不阻止我继续创建报价单

Given 我填写完报价单基本信息
When 我点击"添加产品"
Then 系统应弹出产品选择对话框
And 显示所有状态为active（在售）的产品列表
And 支持按分类、品牌、产品名称搜索筛选
And 每个产品显示：产品编码、产品名称、品牌、单位、标准报价

Given 我选择产品"自助入住机A100"（标准报价1200元/台）
When 我点击"添加"
Then 系统应在产品明细表格中新增一行，自动填充：
  - 产品编码：CHECKIN-A100
  - 产品名称：自助入住机A100
  - 单位：台
  - 标准报价：1200元
  - 实际单价：1200元（默认值，可修改）
  - 数量：1（默认值，可修改）
And 自动计算：
  - 优惠金额：0元
  - 折扣率：0%
  - 小计：1200元

Given 我修改数量为10台，实际单价为1000元
When 我输入完成（失去焦点或按回车）
Then 系统应自动重新计算：
  - 优惠金额：(1200 - 1000) × 10 = 2000元
  - 折扣率：(1200 - 1000) / 1200 × 100% = 16.67%
  - 小计：1000 × 10 = 10000元
And 报价单底部显示汇总信息：
  - 总金额：10000元
  - 总优惠：2000元

Given 我添加了多个产品明细
When 我点击"保存草稿"
Then 系统应创建报价单记录，status=draft
And 自动生成报价单编号（如：QUOTE-20251223-001）
And 负责人（owner_id）自动继承客户的owner_id
And 系统应提示"报价单草稿保存成功，编号：QUOTE-20251223-001"
And 跳转到报价单详情页

Given 我点击"保存草稿"时，产品明细为空
When 系统校验
Then 系统应提示"报价单明细不能为空，请至少添加1个产品"
And 阻止保存
```

**优先级**：P0（高）
**依赖**：产品管理（PRD-002）、客户管理（CRM-002）
**关联模块**：产品管理、客户管理

---

#### 需求 QUOTE-002：发送报价单

**User Story**：
作为销售人员，我希望能够将草稿报价单发送给客户，以便正式提交报价并生成PDF文档。

**Acceptance Criteria**：
```gherkin
Given 我打开一个状态为draft的报价单
When 我点击"发送报价单"按钮
Then 系统应进行校验：
  - 产品明细不能为空
  - 报价单标题、客户、有效期必填
And 校验通过后，系统应：
  - 更新报价单状态为sent
  - 记录发送时间（sent_at = 当前时间）
  - 记录发送人（sent_by = 当前用户ID）
  - 自动触发PDF生成任务
And 系统应提示"报价单已发送，PDF生成中，请稍候..."

Given PDF生成成功
When 生成任务完成
Then 系统应更新pdf_file_url和pdf_generated_at字段
And 在报价单详情页显示"下载PDF"按钮
And 我可以点击下载或预览PDF文件

Given PDF生成失败（如：模板错误、存储服务异常）
When 生成任务失败
Then 报价单状态仍为sent（不回退到draft）
And 系统应记录错误日志
And 显示"PDF生成失败，请稍后重试"提示
And 提供"重新生成PDF"按钮

Given 报价单状态为sent
When 我打开报价单详情页
Then "编辑"、"添加产品"、"修改价格"等按钮应禁用或不显示
And 系统提示"已发送的报价单不可修改，如需调整请创建新版本报价单"
And 显示"创建新版本"按钮
```

**优先级**：P0（高）
**依赖**：QUOTE-001
**关联模块**：文件存储（阿里云OSS）

---

#### 需求 QUOTE-003：报价单版本管理

**User Story**：
作为销售人员，我希望能够基于已发送的报价单创建新版本，以便在客户要求调整时快速生成修改后的报价单。

**Acceptance Criteria**：
```gherkin
Given 我打开一个状态为sent的报价单（编号QUOTE-20251223-001）
When 我点击"创建新版本"按钮
Then 系统应：
  - 复制当前报价单的所有字段（客户、联系人、产品明细、价格、付款条件等）
  - 生成新的报价单编号（如：QUOTE-20251223-002）
  - 设置新报价单状态为draft
  - 重置有效期（valid_from=今天，valid_until=today+30天）
  - 清空PDF相关字段（pdf_file_url、pdf_generated_at）
  - owner_id继承原报价单
And 跳转到新报价单的编辑页面
And 系统提示"已基于QUOTE-20251223-001创建新版本草稿，可修改后发送"

Given 我修改了新版本报价单的产品或价格
When 我点击"保存草稿"并发送
Then 新报价单（QUOTE-20251223-002）状态变为sent
And 原报价单（QUOTE-20251223-001）保持sent状态

Given 我希望标记原报价单为"已被替代"
When 我在新版本报价单详情页点击"标记原版本为已替代"（可选操作）
Then 系统应将QUOTE-20251223-001的状态更新为superseded
And 在原报价单详情页显示提示："此报价单已被QUOTE-20251223-002替代"

Given 我在客户详情页查看报价单历史
When 我打开"报价单"Tab
Then 系统应按创建时间倒序显示该客户的所有报价单
And 每个报价单显示：编号、标题、金额、状态、创建时间
And 可筛选状态（草稿/已发送/已接受/已拒绝/已过期/已被替代）
And 同一客户的多个报价单清晰列出，便于对比版本差异
```

**优先级**：P0（高）
**依赖**：QUOTE-002
**关联模块**：无

---

#### 需求 QUOTE-004：报价单有效期与延期管理

**User Story**：
作为销售人员，我希望能够管理报价单的有效期并在需要时延长，以便适应客户的决策周期。

**Acceptance Criteria**：
```gherkin
Given 系统定时任务每日凌晨2点执行
When 检测到报价单valid_until < 当前日期 且 status = sent
Then 系统应自动将这些报价单的status更新为expired
And 记录操作日志："系统自动标记过期：QUOTE-20251223-001"

Given 当前日期为2025-12-23
And 报价单QUOTE-20251223-001的valid_until为2025-12-26（还剩3天）
And status=sent
When 定时任务执行过期提醒检查
Then 系统应生成待办任务提醒owner："报价单QUOTE-20251223-001将于3天后（2025-12-26）过期，请及时跟进或延期"
And 待办任务优先级为高

Given 我打开一个status=sent且未过期的报价单
When 我点击"延长有效期"按钮
Then 系统应显示延期对话框：
  - 当前失效日期：2025-12-26
  - 新的失效日期（日期选择器，默认值=当前失效日期+30天）
  - 延期原因（必填，文本框）
And 我填写新失效日期为2026-01-15，延期原因为"客户要求延长决策时间"
And 点击确认

When 系统处理延期请求
Then 系统应：
  - 更新valid_until = 2026-01-15
  - extension_count + 1
  - last_extension_at = 当前时间
  - 记录操作日志："延长有效期：QUOTE-20251223-001，原到期日2025-12-26，新到期日2026-01-15，原因：客户要求延长决策时间"
And 系统提示"有效期延长成功，新的失效日期：2026-01-15"

Given 报价单已被延期3次（extension_count = 3）
When 我再次点击"延长有效期"
Then 系统应在对话框顶部显示警告提示："此报价单已延期3次，建议重新评估客户意向或创建新报价单"
And 仍允许我继续延期（不强制阻止）

Given 报价单状态为draft/accepted/rejected/expired/superseded
When 我尝试点击"延长有效期"
Then 按钮应禁用或不显示
And 鼠标悬停时提示"仅已发送状态的报价单可延期"
```

**优先级**：P1（中高）
**依赖**：QUOTE-002
**关联模块**：待办任务模块

---

#### 需求 QUOTE-005：报价单状态变更

**User Story**：
作为销售人员，我希望能够标记报价单的接受/拒绝状态，以便跟踪报价结果和后续操作。

**Acceptance Criteria**：
```gherkin
Given 我打开一个status=sent的报价单
When 客户确认接受报价
And 我点击"标记为已接受"按钮
Then 系统应：
  - 更新status = accepted
  - 记录操作日志："标记报价单为已接受：QUOTE-20251223-001"
And 系统提示"报价单已标记为已接受，可转为合同"
And 显示"转为合同"按钮

Given 我打开一个status=sent的报价单
When 客户明确拒绝报价
And 我点击"标记为已拒绝"按钮
Then 系统应显示确认对话框："确定标记为已拒绝？请填写拒绝原因（可选）"
And 我填写拒绝原因为"价格超出预算"并确认
Then 系统应：
  - 更新status = rejected
  - 记录操作日志："标记报价单为已拒绝：QUOTE-20251223-001，原因：价格超出预算"
And 系统提示"报价单已标记为已拒绝"

Given 报价单status=draft
When 我尝试标记为已接受或已拒绝
Then 按钮应禁用，提示"仅已发送的报价单可标记接受/拒绝"

Given 报价单status=expired
When 我打开报价单详情页
Then 系统应在页面顶部显示提示："此报价单已过期（失效日期：2025-12-20）"
And 提供"创建新版本"和"重新激活"按钮

Given 我点击"重新激活"按钮
When 确认重新激活
Then 系统应：
  - 更新status = sent
  - 更新valid_until = 当前日期 + 30天
  - extension_count + 1
  - 记录操作日志："重新激活过期报价单：QUOTE-20251223-001"
And 系统提示"报价单已重新激活，新的失效日期：{new_valid_until}"
```

**优先级**：P0（高）
**依赖**：QUOTE-002
**关联模块**：无

---

#### 需求 QUOTE-006：报价单PDF生成

**User Story**：
作为销售人员，我希望能够生成标准格式的PDF报价单文档，以便发送给客户或打印归档。

**Acceptance Criteria**：
```gherkin
Given 报价单状态为sent或accepted
When 我点击"下载PDF"按钮
And PDF文件已生成（pdf_file_url不为空）
Then 系统应直接下载PDF文件或在新标签页打开预览
And PDF文件名格式为"{报价单编号}_{客户名称}_报价单.pdf"（如：QUOTE-20251223-001_希尔顿酒店_报价单.pdf）

Given PDF文件未生成（pdf_file_url为空）或生成失败
When 我点击"生成PDF"按钮
Then 系统应：
  - 显示加载提示"PDF生成中，请稍候..."
  - 调用PDF生成服务，使用默认报价单模板
  - PDF模板应包含以下内容：
    * 报价单标题
    * 客户名称、联系人、联系方式
    * 报价单编号、生效日期、失效日期
    * 产品明细表格（产品编码、名称、单位、数量、单价、小计）
    * 总金额、总优惠、优惠后金额
    * 付款条件、交付条件
    * 备注
    * 公司信息（公司名称、地址、电话、统一社会信用代码）

Given PDF生成成功
When 生成任务完成
Then 系统应：
  - 将PDF文件上传到阿里云OSS
  - 更新pdf_file_url和pdf_generated_at
  - 提示"PDF生成成功，可下载查看"
And 自动触发下载或预览

Given PDF生成失败
When 生成任务失败（如：模板错误、网络异常、存储服务故障）
Then 系统应：
  - 记录错误日志（包含失败原因和堆栈信息）
  - 提示"PDF生成失败：{错误原因}，请稍后重试或联系管理员"
And 不更新pdf_file_url字段
And 提供"重新生成"按钮

Given 我修改了报价单内容（如更新产品或价格）
And 之前已生成PDF
When 我保存修改
Then 系统应清空pdf_file_url和pdf_generated_at
And 提示"报价单已修改，请重新生成PDF"

Given 系统管理员配置了报价单PDF模板（预留功能）
When PDF生成时
Then 系统应使用配置的HTML模板进行渲染
And 支持模板变量替换（如：{{quotation_no}}、{{customer_name}}等）
```

**优先级**：P0（高）
**依赖**：QUOTE-002
**关联模块**：文件存储（阿里云OSS）、PDF生成服务

**技术说明**：
- 推荐使用wkhtmltopdf、Puppeteer或类似库生成PDF
- PDF模板采用HTML+CSS，便于后续调整样式
- 模板配置预留扩展点，v1.0使用固定默认模板

---

#### 需求 QUOTE-007：报价单转合同

**User Story**：
作为销售人员，我希望能够将已接受的报价单一键转为合同，以便快速签订合同并减少重复录入。

**Acceptance Criteria**：
```gherkin
Given 我打开一个status=accepted的报价单
When 我点击"转为合同"按钮
Then 系统应显示确认对话框："确认将此报价单转为合同？合同信息将从报价单自动预填充"
And 我点击确认

When 系统处理转合同请求
Then 系统应：
  - 跳转到合同创建页面
  - 自动预填充以下字段（从报价单复制）：
    * 客户ID（customer_id）
    * 客户联系人（customer_contact_id）
    * 合同标题（默认为"{客户名称}智能硬件采购合同"）
    * 产品明细（从quotation_item复制到contract_item）
      - 产品ID、产品编码、产品名称、单位
      - 数量、单价（使用actual_price）
      - 小计
    * 合同总金额（使用报价单的total_amount）
    * 付款条件（payment_terms）
    * 交付条件（delivery_terms）
    * 备注（notes）
    * 来源报价单ID（source_quotation_id = 当前报价单ID）
  - 合同状态默认为draft
  - 合同编号自动生成（如：CONTRACT-20251223-001）

Given 合同创建页面已预填充报价单数据
When 我查看页面
Then 所有预填充字段应可编辑（允许在转合同时调整）
And 页面顶部显示提示："此合同基于报价单QUOTE-20251223-001创建，可继续编辑后保存"

Given 我修改了部分字段（如调整数量或新增产品）
When 我点击"保存合同"
Then 系统应创建新的合同记录
And 记录source_quotation_id关联原报价单
And 系统提示"合同创建成功，编号：CONTRACT-20251223-001"
And 跳转到合同详情页

Given 合同创建成功后
When 我返回原报价单详情页
Then 报价单的related_contract_id应更新为新合同ID
And 页面显示提示："此报价单已转为合同CONTRACT-20251223-001"
And 提供快捷链接跳转到合同详情页

Given 报价单已转过一次合同（related_contract_id不为空）
When 我再次点击"转为合同"
Then 系统应显示提示："此报价单已转为合同CONTRACT-20251223-001，是否再次转为新合同？"
And 我确认后，允许再次转换（支持分批签约场景）
And 生成新的合同记录

Given 报价单状态为draft/sent/rejected/expired/superseded
When 我打开报价单详情页
Then "转为合同"按钮应禁用或不显示
And 鼠标悬停时提示"仅已接受状态的报价单可转为合同"
```

**优先级**：P0（高）
**依赖**：QUOTE-005、合同管理模块（待设计）
**关联模块**：合同管理

**说明**：
- 此需求依赖合同管理模块的数据模型和创建功能
- contract表和contract_item表的设计已在§7.5完成
- 关联字段：quotation.related_contract_id ↔ contract.source_quotation_id（双向关联）

---

### 8.6 合同管理需求

#### 需求 CONTRACT-001：创建合同（从报价单转化或手动创建）

**User Story**：
作为销售人员或合同管理员，我希望能够创建合同（从报价单转化或手动创建），以便将客户意向转为正式合同并开始项目执行。

**Acceptance Criteria**：
```gherkin
# 场景1：从报价单转化创建合同（主流程）
Given 我打开一个status=accepted的报价单详情页
When 我点击"转为合同"按钮
Then 系统应跳转到合同创建页面
And 自动预填充以下字段（从报价单复制）：
  - 客户ID、客户联系人ID
  - 合同标题（默认="{客户名称}智能硬件采购合同"）
  - 产品明细（从quotation_item复制，unit_price=actual_price）
  - 合同总金额（=报价单total_amount）
  - 付款条款（payment_terms）
  - 交付条款（delivery_terms）
  - 来源报价单ID（source_quotation_id）
And 合同编号自动生成（格式：CONTRACT-YYYYMMDD-流水号）
And 合同状态默认为draft
And 负责人ID继承报价单的owner_id

Given 合同创建页面已预填充报价单数据
When 我编辑产品明细（调整数量、单价、新增或删除产品）
And 点击"保存草稿"
Then 系统应创建合同记录
And 产品明细保存到contract_item表
And 合同总金额重新计算（=SUM(contract_item.subtotal)）
And 系统提示"合同创建成功，编号：CONTRACT-20251223-001"
And 跳转到合同详情页

Given 合同创建成功后
When 我返回原报价单详情页
Then 报价单的related_contract_id应更新为新合同ID
And 页面显示"此报价单已转为合同CONTRACT-20251223-001"
And 提供链接快捷跳转到合同详情

# 场景2：手动创建合同（不基于报价单）
Given 我进入合同列表页
When 我点击"新建合同"按钮
Then 系统应跳转到合同创建页面
And 显示空白表单

Given 合同创建页面
When 我填写以下字段：
  - 选择客户（下拉搜索）
  - 选择联系人（可选）
  - 合同标题（默认值可修改）
  - 产品明细（点击"添加产品"，从产品库选择，设置数量和单价）
And 点击"保存草稿"
Then 系统应创建合同记录（status=draft）
And 合同编号自动生成
And 来源报价单ID（source_quotation_id）为空
And 负责人ID默认为当前登录用户
And 系统提示"合同创建成功"

# 场景3：客户阶段校验（友好提示）
Given 我创建合同时选择的客户阶段为lead/initial_contact/prospect
When 我点击"保存草稿"
Then 系统应显示提示："建议先将客户推进至商务洽谈或合同签订阶段"
And 提供选项："继续保存" 或 "取消并推进客户阶段"
And 我选择"继续保存"时，合同正常创建（不强制阻止）

# 场景4：数据校验
Given 我创建合同
When 我保存时产品明细为空
Then 系统应提示"合同至少需要包含1个产品"
And 阻止保存

Given 我创建合同
When 我保存时未选择客户
Then 系统应提示"客户为必填字段"
And 阻止保存
```

**优先级**：P0（高）
**依赖**：QUOTE-007、产品管理、客户管理
**关联模块**：报价单管理、产品管理、客户管理

---

#### 需求 CONTRACT-002：合同条款管理

**User Story**：
作为合同管理员，我希望能够编辑和管理合同条款（付款、交付、质保、违约、补充条款），以便明确双方权责并降低合同风险。

**Acceptance Criteria**：
```gherkin
Given 我编辑一个status=draft的合同
When 我进入"合同条款"标签页
Then 系统应显示以下条款编辑区域：
  - 付款条款（支持多期付款，JSON格式录入）
  - 交付条款（富文本编辑器）
  - 质保条款（结构化字段+富文本）
  - 违约条款（富文本编辑器）
  - 补充条款（富文本编辑器）

# 场景1：付款条款编辑（支持多期）
Given 我点击"编辑付款条款"
When 系统显示付款条款表单
Then 我可以添加多期付款：
  - 付款阶段描述（如："签订后"、"发货前"、"验收后"）
  - 付款比例（%，如：30%）
  - 应付日期（可选）
And 每添加一期，系统自动计算金额（=合同总金额×比例）
And 页面实时显示已分配比例总和

Given 我设置了3期付款：签订后30%、发货前50%、验收后20%
When 我点击"保存"
Then 系统应校验：所有期数的percentage之和=100%
And 如果总和≠100%，提示"付款比例总和必须为100%"
And 如果总和=100%，保存payment_terms字段（JSON格式）

# 场景2：质保条款编辑（结构化字段）
Given 我点击"编辑质保条款"
When 系统显示质保条款表单
Then 我可以填写以下字段：
  - 质保期（月数，如：12个月）
  - 质保范围（富文本，如："硬件质量问题免费维修"）
  - 响应时间（小时，如：24小时）
And 保存后生成warranty_terms的JSON结构

# 场景3：交付条款和违约条款编辑（富文本）
Given 我点击"编辑交付条款"
When 系统显示富文本编辑器
Then 我可以输入交付条款文本（如："款到15个工作日内发货，物流方式为德邦物流，运费由供方承担"）
And 支持富文本格式（加粗、列表、段落）
And 保存后更新delivery_terms字段（TEXT格式）

Given 我编辑违约条款和补充条款
Then 流程与交付条款相同（富文本编辑器，保存为TEXT）

# 场景4：合同签订后条款不可修改
Given 一个status=signed的合同
When 我尝试编辑任何条款字段
Then 系统应禁用所有编辑按钮
And 显示提示"合同已签订，条款不可修改。如需变更请创建补充协议"
And 提供"创建补充协议"按钮
```

**优先级**：P0（高）
**依赖**：CONTRACT-001
**关联模块**：无

---

#### 需求 CONTRACT-003：合同签订流程

**User Story**：
作为合同管理员，我希望能够将草稿合同标记为已签订并上传合同文件，以便正式启动合同执行。

**Acceptance Criteria**：
```gherkin
# 场景1：合同签订操作（v1.0简化流程，无审批）
Given 我打开一个status=draft的合同详情页
When 我点击"签订合同"按钮
Then 系统应显示签订确认对话框：
  - 合同签订日期（默认当前日期，可修改）
  - 交付期限（可选）
  - 合同文件上传（必填）
  - 确认按钮

Given 我选择签订日期为2025-01-10
And 设置交付期限为2025-02-15
And 上传合同文件（PDF格式，文件名：XX酒店采购合同.pdf）
When 我点击"确认签订"
Then 系统应执行以下操作：
  - 校验：签订日期≥创建日期
  - 校验：交付期限≥签订日期（如果填写）
  - 校验：合同文件已上传
  - 上传文件到对象存储（如阿里云OSS）
  - 更新合同字段：
    * status = signed
    * signed_date = 2025-01-10
    * delivery_deadline = 2025-02-15
    * contract_file_url = OSS文件URL
    * contract_file_uploaded_at = 当前时间
    * contract_file_version = 1
    * signed_by = 当前用户ID
  - 如果来源于报价单，更新quotation.related_contract_id
  - 生成待办任务（如果设置了delivery_deadline）：
    * "合同{contract_no}交付期限临近提醒"（delivery_deadline前7天）
  - 系统提示"合同签订成功"

# 场景2：重新上传合同文件（覆盖版本）
Given 一个status=signed的合同
When 我点击"重新上传合同文件"
And 上传新文件
Then 系统应：
  - 上传新文件到对象存储
  - 更新contract_file_url = 新文件URL
  - contract_file_version递增（如：1→2）
  - contract_file_uploaded_at更新为当前时间
And 系统提示"合同文件已更新为版本2"

# 场景3：合同签订后产品明细锁定
Given 一个status=signed的合同
When 我尝试编辑产品明细
Then 系统应禁用所有编辑操作
And 显示提示"合同已签订，产品明细不可修改。如需变更请创建补充协议"

# 场景4：数据校验
Given 我签订合同时
When 签订日期晚于交付期限
Then 系统应提示"交付期限不能早于签订日期"
And 阻止签订

Given 我签订合同时
When 未上传合同文件
Then 系统应提示"请上传合同文件"
And 阻止签订

Given 我签订合同时
When 产品明细为空
Then 系统应提示"合同产品明细不能为空，请先添加产品"
And 阻止签订
```

**优先级**：P0（高）
**依赖**：CONTRACT-001、CONTRACT-002
**关联模块**：文件存储（对象存储服务）

---

#### 需求 CONTRACT-004：合同变更管理（补充协议）

**User Story**：
作为合同管理员，我希望能够创建合同补充协议以管理已签订合同的变更，以便合规处理产品调整、金额变更、条款变更等情况。

**Acceptance Criteria**：
```gherkin
# 场景1：创建补充协议（产品变更）
Given 一个status=signed/executing的合同详情页
When 我点击"创建补充协议"按钮
Then 系统应跳转到补充协议创建页面
And 自动关联原合同ID

Given 补充协议创建页面
When 我填写以下字段：
  - 变更类型（下拉选择：product_change/amount_change/term_change/deadline_change/other）
  - 补充协议标题（默认="{客户名称}采购合同补充协议（产品变更）"）
  - 变更内容说明（富文本，详细描述变更事项）
  - 金额变化（如果涉及金额，填写正负数值，如：+5000）
  - 补充协议文件上传（可选）
And 点击"保存草稿"
Then 系统应创建补充协议记录（status=draft）
And 补充协议编号自动生成（格式：AMEND-YYYYMMDD-流水号）

# 场景2：补充协议签订（同步更新原合同）
Given 一个status=draft的补充协议
When 我点击"签订补充协议"
And 填写签订日期（必须≥原合同签订日期）
And 上传补充协议文件（可选）
And 确认
Then 系统应执行以下操作：
  - 更新补充协议：status = signed，signed_date = 填写日期
  - 如果amendment_type=product_change且变更内容包含产品调整：
    * 提示"请手动更新原合同产品明细"（业务逻辑复杂，v1.0不自动更新）
  - 如果amount_change≠0：
    * 计算new_contract_amount = 原合同金额 + amount_change
    * 更新contract.contract_amount = new_contract_amount
  - 如果amendment_type=term_change：
    * 提示"请手动更新原合同相关条款字段"（v1.0不自动更新）
  - 如果amendment_type=deadline_change：
    * 提示"请手动更新原合同delivery_deadline或warranty_end_date"
  - 系统提示"补充协议签订成功"

# 场景3：补充协议取消
Given 一个status=draft的补充协议
When 我点击"取消补充协议"
Then 系统应提示"确认取消此补充协议？取消后不影响原合同"
And 我确认后，更新补充协议：status = cancelled
And 系统提示"补充协议已取消"

# 场景4：补充协议历史查看
Given 一个有多个补充协议的合同详情页
When 我点击"补充协议"标签页
Then 系统应显示所有关联的补充协议列表：
  - 补充协议编号
  - 变更类型
  - 金额变化
  - 签订日期
  - 状态（draft/signed/cancelled）
  - 操作按钮（查看详情、下载文件）
And 列表按创建时间倒序排列

# 场景5：数据校验
Given 我创建补充协议时
When 原合同状态为draft/terminated
Then 系统应提示"仅已签订或执行中的合同可创建补充协议"
And 阻止创建

Given 我签订补充协议时
When 签订日期早于原合同签订日期
Then 系统应提示"补充协议签订日期不能早于原合同签订日期"
And 阻止签订
```

**优先级**：P1（中）
**依赖**：CONTRACT-003
**关联模块**：无

**说明**：
- v1.0阶段补充协议签订后不自动同步更新原合同产品明细和条款，需手动操作（降低复杂度）
- v2.0可增强为智能同步更新

---

#### 需求 CONTRACT-005：合同执行跟踪（进度统计）

**User Story**：
作为合同管理员或销售人员，我希望能够实时查看合同的执行进度（发货、收款、开票情况），以便掌握项目进展并及时跟进。

**Acceptance Criteria**：
```gherkin
# 场景1：合同执行进度概览
Given 一个status=executing的合同详情页
When 我查看"执行进度"标签页
Then 系统应显示以下统计信息：
  - 合同总金额：100,000元
  - 已发货金额：60,000元（60%）
  - 已收款金额：30,000元（30%）
  - 已开票金额：30,000元（30%）
  - 执行进度：30%（MIN(发货、收款、开票) / 总金额）
  - 进度条可视化展示

And 显示各维度的明细列表：
  - 发货记录列表（关联shipment表）
  - 收款记录列表（关联payment表）
  - 发票记录列表（关联invoice表）

# 场景2：执行进度自动更新（发货触发）
Given 发货管理模块创建了一条发货记录
And 发货记录关联contract_id=123，发货金额=20,000元
When 发货记录保存成功
Then 系统应自动更新contract表：
  - shipped_amount = shipped_amount + 20,000（累加）
  - execution_progress重新计算 = MIN(shipped_amount, received_amount, invoiced_amount) / contract_amount × 100%
  - updated_at更新为当前时间

And 如果shipped_amount > 0 且 status=signed
Then 自动流转状态：status = executing

And 如果所有产品已发货完毕（contract_item.shipped_quantity全部=quantity）
Then actual_delivery_date = 最后一次发货日期
And 如果设置了质保期，自动计算：
  - warranty_start_date = actual_delivery_date（如果未手动设置）
  - warranty_end_date = DATE_ADD(warranty_start_date, INTERVAL warranty_period_months MONTH)

# 场景3：执行进度自动更新（收款触发）
Given 收款管理模块创建了一条收款记录
And 收款记录关联contract_id=123，收款金额=30,000元
When 收款记录保存成功
Then 系统应自动更新contract表：
  - received_amount = received_amount + 30,000（累加）
  - execution_progress重新计算

# 场景4：执行进度自动更新（开票触发）
Given 发票管理模块创建了一条发票记录
And 发票记录关联contract_id=123，开票金额=30,000元
When 发票保存成功
Then 系统应自动更新contract表：
  - invoiced_amount = invoiced_amount + 30,000（累加）
  - execution_progress重新计算

# 场景5：合同完成提示
Given 一个status=executing的合同
When 系统检测到：
  - shipped_amount = contract_amount
  - received_amount = contract_amount
  - invoiced_amount = contract_amount
  - execution_progress = 100%
Then 系统应生成待办任务："合同{contract_no}已全部执行完毕，建议标记为已完成"
And 在合同详情页显示提示："所有交付已完成，是否将状态改为已完成？"
And 提供"标记为已完成"按钮

# 场景6：执行进度字段只读
Given 合同详情页
When 我查看执行进度字段（shipped_amount、received_amount、invoiced_amount、execution_progress）
Then 这些字段应为只读（灰色显示）
And 鼠标悬停时提示"此字段由系统自动更新，不可手动修改"
```

**优先级**：P0（高）
**依赖**：CONTRACT-003、发货管理模块、收款管理模块、发票管理模块
**关联模块**：发货管理、收款管理、发票管理

**说明**：
- 执行进度字段由关联模块触发更新，通过数据库触发器或应用层事件机制实现
- execution_progress计算规则：MIN(发货、收款、开票) / 总金额，取最小值确保保守计算

---

#### 需求 CONTRACT-006：合同提醒与预警

**User Story**：
作为合同管理员，我希望系统能够自动生成合同相关的提醒和预警任务，以便及时处理关键节点事项。

**Acceptance Criteria**：
```gherkin
# 场景1：交付期限临近提醒
Given 一个status=signed/executing的合同
And 设置了delivery_deadline=2025-02-15
When 系统定时任务每日凌晨2点检查
And 当前日期=2025-02-08（delivery_deadline前7天）
Then 系统应生成待办任务：
  - 任务标题："合同{contract_no}交付期限临近"
  - 任务描述："合同将于7天后（2025-02-15）到期，请确保按时发货"
  - 负责人：合同owner_id
  - 优先级：高
  - 截止日期：delivery_deadline

# 场景2：交付逾期预警
Given 一个status=signed/executing的合同
And 设置了delivery_deadline=2025-02-15
And actual_delivery_date为空（未实际交付）
When 系统定时任务检查
And 当前日期>2025-02-15
Then 系统应生成待办任务：
  - 任务标题："合同{contract_no}已逾期"
  - 任务描述："合同交付期限为2025-02-15，已逾期{X}天，请尽快处理"
  - 负责人：合同owner_id
  - 优先级：紧急
And 在合同详情页显示红色预警标签："已逾期{X}天"

# 场景3：付款到期提醒
Given 一个合同的付款条款包含应付日期（due_date）
And payment_terms = [{"stage":"签订后","percentage":30,"amount":30000,"due_date":"2025-01-10"}]
When 系统定时任务检查
And 当前日期=2025-01-07（due_date前3天）
And received_amount < 30000（该期款项未收齐）
Then 系统应生成待办任务：
  - 任务标题："合同{contract_no}应收款到期提醒"
  - 任务描述："付款阶段【签订后】应收30,000元，将于3天后（2025-01-10）到期，请跟进收款"
  - 负责人：合同owner_id
  - 优先级：高

# 场景4：质保期到期提醒
Given 一个合同设置了质保期
And warranty_end_date=2026-03-01
When 系统定时任务检查
And 当前日期=2026-02-01（warranty_end_date前30天）
Then 系统应生成待办任务：
  - 任务标题："合同{contract_no}质保期即将到期"
  - 任务描述："合同质保期将于30天后（2026-03-01）到期，请做好质保期结束准备"
  - 负责人：合同owner_id
  - 优先级：中

# 场景5：提醒任务去重
Given 系统已生成某个提醒任务（如"交付期限临近"）
When 次日再次运行定时任务检查
Then 系统应校验：相同合同ID+相同任务类型的待办任务是否已存在且未完成
And 如果已存在，不重复生成
And 如果已完成，重新生成（用于周期性提醒）

# 场景6：提醒任务列表查看
Given 我进入待办任务列表页
When 我筛选"合同提醒"类型
Then 系统应显示所有合同相关的待办任务
And 支持按合同编号、负责人、优先级、状态筛选
And 点击任务可快捷跳转到合同详情页
```

**优先级**：P1（中）
**依赖**：CONTRACT-003、待办任务模块
**关联模块**：待办任务管理

**说明**：
- 提醒任务由系统定时任务自动生成（建议每日凌晨2点运行）
- 任务去重规则：合同ID+任务类型+未完成状态，防止重复提醒

---

#### 需求 CONTRACT-007：合同文件管理

**User Story**：
作为合同管理员，我希望能够管理合同文件（上传、版本管理、下载），以便保存合同电子档案并支持历史追溯。

**Acceptance Criteria**：
```gherkin
# 场景1：合同文件上传（签订时）
Given 我在合同签订对话框
When 我点击"上传合同文件"
Then 系统应显示文件选择器
And 限制文件类型为PDF格式
And 限制文件大小≤20MB

Given 我选择文件"XX酒店采购合同.pdf"
When 上传成功
Then 系统应：
  - 上传文件到对象存储（如阿里云OSS）
  - 文件路径格式：contracts/{contract_id}/v{version}/{filename}
  - 返回文件URL
And 显示上传成功提示和文件预览

# 场景2：合同文件重新上传（版本管理）
Given 一个已签订的合同
When 我进入合同详情页的"文件管理"标签页
And 点击"重新上传合同文件"
Then 系统应显示确认对话框："重新上传将覆盖当前文件版本，确认继续？"

Given 我确认并上传新文件
Then 系统应：
  - 上传新文件到对象存储
  - contract_file_url更新为新文件URL
  - contract_file_version递增（如：1→2）
  - contract_file_uploaded_at更新为当前时间
  - 保留旧文件在对象存储（路径包含版本号，支持历史追溯）
And 系统提示"合同文件已更新为版本2"

# 场景3：合同文件下载
Given 合同详情页
When 我点击"下载合同文件"按钮
Then 系统应：
  - 从对象存储生成临时访问URL（有效期24小时）
  - 打开新窗口/标签页下载文件
And 下载文件名格式：{合同编号}_{客户名称}_v{版本号}.pdf（如：CONTRACT-20251223-001_XX酒店_v2.pdf）

# 场景4：合同文件预览
Given 合同详情页
When 我点击"预览合同文件"按钮
Then 系统应在新窗口/内嵌iframe中显示PDF预览
And 提供工具栏（放大、缩小、下载、打印）

# 场景5：补充协议文件管理
Given 补充协议创建/编辑页面
When 我上传补充协议文件
Then 文件管理逻辑与合同文件相同
And 文件路径格式：amendments/{amendment_id}/{filename}

# 场景6：文件安全与权限
Given 我访问合同文件URL
When URL过期（超过24小时）
Then 系统应返回403错误："文件访问链接已过期，请重新生成"

Given 我无权限查看某合同
When 我尝试访问合同文件URL
Then 系统应校验权限
And 如果无权限，返回403错误："无权限访问此文件"
```

**优先级**：P0（高）
**依赖**：CONTRACT-003、对象存储服务
**关联模块**：文件存储（阿里云OSS）

**说明**：
- 文件存储采用对象存储服务（如阿里云OSS），不存储在数据库
- 文件版本管理：保留历史版本文件，路径包含版本号，支持追溯
- 文件访问安全：生成临时访问URL，设置有效期和权限校验

---

#### 需求 CONTRACT-008：合同状态管理与流转

**User Story**：
作为合同管理员，我希望能够管理合同状态（签订、执行中、完成、终止），以便准确反映合同当前阶段。

**Acceptance Criteria**：
```gherkin
# 场景1：状态自动流转（signed → executing）
Given 一个status=signed的合同
When 发货模块创建发货记录并关联此合同
Or 收款模块创建收款记录并关联此合同
Or 发票模块创建发票并关联此合同
Then 系统应自动更新合同状态：status = executing
And 记录状态变更日志（操作日志表）

# 场景2：手动标记合同为已完成
Given 一个status=executing的合同
And execution_progress=100%
And shipped_amount=received_amount=invoiced_amount=contract_amount
When 我点击"标记为已完成"按钮
Then 系统应显示确认对话框："确认将合同标记为已完成？完成后合同状态不可变更"

Given 我确认
Then 系统应：
  - 更新status = completed
  - 记录状态变更日志
  - 生成待办任务："合同{contract_no}已完成，请归档相关文件"
And 系统提示"合同已标记为已完成"

# 场景3：手动终止合同
Given 一个status=signed/executing的合同
When 我点击"终止合同"按钮
Then 系统应显示终止确认对话框：
  - 终止原因（必填，下拉+文本框：客户取消/供方违约/客方违约/双方协商/其他）
  - 终止说明（可选，富文本）

Given 我填写终止原因为"客户取消"
And 填写终止说明
And 确认
Then 系统应：
  - 更新status = terminated
  - 记录终止原因和说明（预留字段：termination_reason, termination_note）
  - 记录状态变更日志
And 系统提示"合同已终止"

# 场景4：已终止/已完成合同不可再修改
Given 一个status=completed/terminated的合同
When 我尝试编辑任何字段
Then 系统应禁用所有编辑操作
And 显示提示"合同已{完成/终止}，不可修改"
And 仅允许查看和下载文件操作

# 场景5：合同状态查看与筛选
Given 合同列表页
When 我查看合同列表
Then 系统应显示状态标签（颜色区分）：
  - draft（草稿）：灰色
  - under_review（待审核，v2.0）：橙色
  - approved（已批准，v2.0）：蓝色
  - signed（已签订）：绿色
  - executing（执行中）：青色
  - completed（已完成）：深绿色
  - terminated（已终止）：红色

And 支持按状态筛选合同
And 状态字段支持排序
```

**优先级**：P0（高）
**依赖**：CONTRACT-003、CONTRACT-005
**关联模块**：发货管理、收款管理、发票管理

**说明**：
- v1.0阶段跳过审批状态（under_review、approved），状态保留但不使用
- 状态自动流转仅限signed→executing，其他状态变更需手动操作
- 合同终止原因和说明字段需在contract表中预留（termination_reason, termination_note）

---

#### 需求 CONTRACT-009：合同搜索与筛选

**User Story**：
作为销售人员或合同管理员,我希望能够快速搜索和筛选合同，以便高效查找目标合同并统计分析。

**Acceptance Criteria**：
```gherkin
# 场景1：多条件筛选
Given 我进入合同列表页
When 我展开筛选面板
Then 系统应显示以下筛选条件：
  - 合同编号（模糊搜索）
  - 客户名称（下拉搜索）
  - 合同状态（多选：draft/signed/executing/completed/terminated）
  - 签订日期范围（起止日期）
  - 交付期限范围（起止日期）
  - 负责人（下拉选择）
  - 合同金额范围（最小值-最大值）
  - 来源报价单（是/否）

Given 我选择筛选条件：
  - 合同状态=signed,executing
  - 签订日期范围=2025-01-01至2025-01-31
  - 负责人=张三
When 我点击"查询"
Then 系统应返回符合条件的合同列表
And 显示结果数量："共找到15条合同"

# 场景2：快速搜索
Given 合同列表页顶部搜索框
When 我输入关键字"XX酒店"
And 按回车或点击搜索按钮
Then 系统应搜索以下字段：
  - 合同编号（contract_no）
  - 合同标题（contract_title）
  - 客户名称（customer.customer_name）
And 返回模糊匹配结果

# 场景3：列表排序
Given 合同列表页
When 我点击列头"签订日期"
Then 系统应按签订日期倒序排列
And 再次点击，切换为正序排列

Given 我点击列头"合同金额"
Then 系统应按金额倒序排列（从大到小）

# 场景4：批量导出
Given 合同列表页（已筛选出目标合同）
When 我勾选多个合同（或全选）
And 点击"导出Excel"按钮
Then 系统应导出选中合同的Excel文件
And 包含以下字段：
  - 合同编号
  - 客户名称
  - 合同金额
  - 签订日期
  - 交付期限
  - 状态
  - 执行进度
  - 已发货/已收款/已开票金额
  - 负责人
And 文件名格式：合同列表_{导出日期}.xlsx

# 场景5：高级统计（快捷筛选）
Given 合同列表页顶部统计卡片
When 页面加载
Then 系统应显示以下统计数据（可点击快捷筛选）：
  - 本月新签合同数量（点击筛选本月signed的合同）
  - 执行中合同数量（点击筛选executing状态）
  - 逾期未交付合同数量（点击筛选delivery_deadline<当前日期且actual_delivery_date为空）
  - 本月到期质保合同数量（点击筛选warranty_end_date在本月内）
And 每个卡片显示数量和环比变化（如：15 ↑20%）
```

**优先级**：P0（高）
**依赖**：CONTRACT-001
**关联模块**：无

---

#### 需求 CONTRACT-010：合同详情查看与关联信息

**User Story**：
作为销售人员或合同管理员,我希望能够查看合同的完整详情及关联业务信息，以便全面了解合同执行情况。

**Acceptance Criteria**：
```gherkin
# 场景1：合同基本信息展示
Given 我打开一个合同详情页
When 页面加载
Then 系统应显示以下基本信息：
  - 合同编号（contract_no）
  - 合同标题（contract_title）
  - 客户名称（点击可跳转客户详情）
  - 客户联系人（姓名、电话、邮箱）
  - 合同状态（状态标签）
  - 合同金额（contract_amount）
  - 签订日期（signed_date）
  - 交付期限（delivery_deadline）
  - 负责人（owner_id）
  - 创建时间/创建人
  - 更新时间/修改人

# 场景2：产品明细展示
Given 合同详情页"产品明细"标签页
When 我点击进入
Then 系统应显示产品明细表格：
  - 序号
  - 产品编码
  - 产品名称
  - 单位
  - 数量
  - 单价
  - 小计
  - 已发货数量（shipped_quantity）
  - 备注
And 表格底部显示：合同总金额=SUM(subtotal)

# 场景3：合同条款展示
Given 合同详情页"合同条款"标签页
When 我点击进入
Then 系统应分区域展示：
  - 付款条款（表格形式：付款阶段、比例、金额、应付日期）
  - 交付条款（富文本展示）
  - 质保条款（结构化展示：质保期、质保范围、响应时间）
  - 违约条款（富文本展示）
  - 补充条款（富文本展示）

# 场景4：执行进度展示
Given 合同详情页"执行进度"标签页
When 我点击进入
Then 系统应显示：
  - 进度概览（卡片形式）：
    * 合同总金额
    * 已发货金额（百分比进度条）
    * 已收款金额（百分比进度条）
    * 已开票金额（百分比进度条）
    * 执行进度（综合进度条）
  - 发货记录列表（表格：发货单号、发货日期、发货金额、物流单号、操作）
  - 收款记录列表（表格：收款单号、收款日期、收款金额、收款方式、操作）
  - 发票记录列表（表格：发票号、开票日期、开票金额、发票类型、操作）

# 场景5：补充协议展示
Given 合同详情页"补充协议"标签页
When 我点击进入
Then 系统应显示补充协议列表（表格）：
  - 补充协议编号
  - 变更类型
  - 金额变化
  - 签订日期
  - 状态
  - 操作（查看详情、下载文件）

# 场景6：来源报价单关联展示
Given 合同是从报价单转化的（source_quotation_id不为空）
When 我查看合同详情页
Then 页面顶部应显示关联信息："此合同基于报价单{quotation_no}创建"
And 提供链接快捷跳转到报价单详情

# 场景7：操作日志展示
Given 合同详情页"操作日志"标签页
When 我点击进入
Then 系统应显示时间线格式的操作日志：
  - 创建合同（创建人、创建时间）
  - 修改合同（修改人、修改时间、修改字段）
  - 签订合同（签订人、签订时间）
  - 状态变更（变更人、变更时间、原状态→新状态）
  - 上传文件（上传人、上传时间、文件版本）
  - 创建补充协议（创建人、创建时间、补充协议编号）
And 日志按时间倒序排列（最新在上）
```

**优先级**：P0（高）
**依赖**：CONTRACT-001至CONTRACT-007
**关联模块**：报价单管理、发货管理、收款管理、发票管理、操作日志

---

### 8.7 待办任务管理需求

#### 需求 TASK-001：线索跟进任务自动生成

**User Story**：
作为销售人员，当我在跟进记录中设置下次跟进时间时，系统能够自动生成跟进提醒任务，以便我不会遗漏任何跟进机会。

**Acceptance Criteria**：

```gherkin
Scenario: 创建跟进记录并设置下次跟进时间时自动生成任务
  Given 我是销售人员
  And 我负责客户"XX酒店"（customer_id=123）
  When 我创建一条跟进记录，填写以下信息：
    | 字段                    | 值                           |
    | follow_up_time         | 2025-12-23 10:00            |
    | follow_up_content      | 电话沟通了采购需求           |
    | next_follow_up_time    | 2025-12-26 14:00            |
    | next_follow_up_content | 发送产品方案给客户           |
  And 点击"保存"
  Then 系统应成功创建跟进记录
  And 系统应自动生成一条待办任务：
    | 字段              | 值                                                |
    | task_type        | lead_follow_up                                   |
    | task_title       | 跟进客户【XX酒店】                                |
    | task_description | 下次跟进内容：发送产品方案给客户                    |
    | assignee_id      | 123（当前用户ID）                                 |
    | due_date         | 2025-12-26                                       |
    | status           | pending                                          |
    | source_type      | customer                                         |
    | source_id        | 123                                              |
    | unique_key       | customer_123_lead_follow_up_2025-12-26 14:00:00 |
    | priority         | medium                                           |
  And 任务应出现在我的待办任务列表中

Scenario: 跟进记录未设置下次跟进时间时不生成任务
  Given 我是销售人员
  And 我负责客户"XX酒店"（customer_id=123）
  When 我创建一条跟进记录，填写以下信息：
    | 字段               | 值                    |
    | follow_up_time    | 2025-12-23 10:00     |
    | follow_up_content | 电话沟通了采购需求    |
    | next_follow_up_time | NULL（未设置）      |
  And 点击"保存"
  Then 系统应成功创建跟进记录
  And 系统不应生成待办任务

Scenario: 同一跟进时间不重复生成任务（防重机制）
  Given 系统已存在一条待办任务：
    | unique_key | customer_123_lead_follow_up_2025-12-26 14:00:00 |
  When 我再次创建跟进记录，next_follow_up_time设置为"2025-12-26 14:00"
  Then 系统应成功创建跟进记录
  But 系统不应生成重复的待办任务（根据unique_key判断已存在）
```

**优先级**：P0（高）
**依赖**：LEAD-003（线索跟进记录）
**关联模块**：销售线索管理、客户管理

---

#### 需求 TASK-002：报价单过期提醒任务自动生成

**User Story**：
作为销售人员，系统应在报价单即将过期前3天和过期当天自动生成提醒任务，以便我及时跟进客户避免报价单失效。

**Acceptance Criteria**：

```gherkin
Scenario: 报价单有效期剩余3天时自动生成即将过期任务
  Given 系统定时任务在每日凌晨2点执行
  And 当前日期为2025-12-23
  And 存在报价单QUOTE-001：
    | 字段         | 值           |
    | quotation_id | 1001        |
    | quotation_no | QUOTE-001   |
    | valid_until  | 2025-12-26  |
    | status       | sent        |
    | owner_id     | 123         |
  When 定时任务扫描quotation表
  Then 系统应自动生成一条待办任务：
    | 字段              | 值                                                        |
    | task_type        | quotation_expiring                                       |
    | task_title       | 报价单【QUOTE-001】即将过期                               |
    | task_description | 报价单【XX酒店智能硬件采购报价单】将于2025-12-26过期，请及时跟进客户 |
    | assignee_id      | 123                                                      |
    | due_date         | 2025-12-23（提前3天）                                     |
    | status           | pending                                                  |
    | source_type      | quotation                                                |
    | source_id        | 1001                                                     |
    | unique_key       | quotation_1001_expiring_2025-12-26                      |
    | priority         | medium                                                   |

Scenario: 报价单过期当天自动生成已过期任务
  Given 系统定时任务在每日凌晨2点执行
  And 当前日期为2025-12-26
  And 存在报价单QUOTE-001：
    | valid_until | 2025-12-25 |
    | status      | sent       |
  When 定时任务扫描quotation表
  Then 系统应自动生成一条待办任务：
    | task_type        | quotation_expired                                         |
    | task_title       | 报价单【QUOTE-001】已过期                                  |
    | task_description | 报价单【XX酒店智能硬件采购报价单】已于2025-12-25过期，请联系客户确认是否需要延期或重新报价 |
    | priority         | medium                                                    |

Scenario: 报价单状态为非sent时不生成过期任务
  Given 存在报价单QUOTE-002：
    | valid_until | 2025-12-26 |
    | status      | accepted   |
  When 定时任务扫描quotation表（当前日期=2025-12-23，剩余3天）
  Then 系统不应为QUOTE-002生成任务（状态已非sent）

Scenario: 报价单已转合同后自动取消过期任务
  Given 存在待办任务：
    | task_type   | quotation_expiring      |
    | source_id   | 1001                    |
    | status      | pending                 |
  When 报价单QUOTE-001状态变更为accepted（已转合同）
  Then 系统应自动更新关联任务状态为cancelled
  And cancel_reason为"报价单已转合同"
```

**优先级**：P0（高）
**依赖**：QUOTE-001至QUOTE-005（报价单管理）
**关联模块**：报价单管理

---

#### 需求 TASK-003：合同交付与收款提醒任务自动生成

**User Story**：
作为合同管理员，系统应在合同交付期限临近、逾期、收款到期时自动生成提醒任务，确保合同按时履约。

**Acceptance Criteria**：

```gherkin
Scenario: 合同交付期限前7天自动生成临近提醒任务
  Given 系统定时任务在每日凌晨2点执行
  And 当前日期为2025-12-23
  And 存在合同CONTRACT-001：
    | contract_id       | 2001             |
    | contract_no       | CONTRACT-001     |
    | delivery_deadline | 2025-12-30       |
    | status            | signed           |
    | owner_id          | 123              |
  When 定时任务扫描contract表
  Then 系统应自动生成一条待办任务：
    | task_type        | contract_delivery_upcoming                                |
    | task_title       | 合同【CONTRACT-001】交付期临近                             |
    | task_description | 合同【XX酒店智能硬件采购合同】交付期限为2025-12-30，请安排发货 |
    | due_date         | 2025-12-23（提前7天）                                      |
    | priority         | medium                                                    |
    | unique_key       | contract_2001_delivery_upcoming_2025-12-30               |

Scenario: 合同交付逾期自动生成逾期任务
  Given 当前日期为2025-12-31
  And 存在合同CONTRACT-001：
    | delivery_deadline    | 2025-12-30  |
    | actual_delivery_date | NULL（未发货）|
    | status               | signed      |
  When 定时任务扫描contract表
  Then 系统应自动生成一条待办任务：
    | task_type        | contract_delivery_overdue                                  |
    | task_title       | 合同【CONTRACT-001】交付已逾期                              |
    | task_description | 合同【XX酒店智能硬件采购合同】交付期限为2025-12-30，当前已逾期，请紧急处理 |
    | priority         | high（逾期任务优先级提升为高）                              |

Scenario: 合同付款到期前3天自动生成收款提醒任务
  Given 当前日期为2025-12-23
  And 存在合同CONTRACT-001：
    | contract_id     | 2001                                                                    |
    | contract_amount | 100000                                                                  |
    | received_amount | 30000                                                                   |
    | payment_terms   | [{"stage":"签订后","percentage":30,"amount":30000,"due_date":"2025-12-10"},{"stage":"发货前","percentage":70,"amount":70000,"due_date":"2025-12-26"}] |
  When 定时任务扫描contract表的payment_terms JSON
  Then 系统应为第2期付款生成待办任务：
    | task_type        | contract_payment_due                                       |
    | task_title       | 合同【CONTRACT-001】第2期付款到期                           |
    | task_description | 合同【XX酒店智能硬件采购合同】第2期付款（应收70000元）将于2025-12-26到期，当前已收款30000元 |
    | due_date         | 2025-12-23（提前3天）                                       |
    | unique_key       | contract_2001_payment_due_发货前_2025-12-26                |

Scenario: 合同已发货后自动取消交付提醒任务
  Given 存在待办任务：
    | task_type | contract_delivery_upcoming |
    | source_id | 2001                       |
    | status    | pending                    |
  When 合同CONTRACT-001的actual_delivery_date填写为2025-12-28
  Then 系统应自动更新关联任务状态为cancelled
  And cancel_reason为"合同已发货"

Scenario: 合同收款完成后自动取消收款提醒任务
  Given 存在待办任务：
    | task_type | contract_payment_due |
    | source_id | 2001                 |
    | status    | pending              |
  And 合同CONTRACT-001的payment_terms第2期应收金额为70000元
  When 合同CONTRACT-001的received_amount更新为100000元（全部收齐）
  Then 系统应自动取消关联的所有收款提醒任务
```

**优先级**：P0（高）
**依赖**：CONTRACT-001至CONTRACT-007（合同管理）
**关联模块**：合同管理、发货管理、收款管理

---

#### 需求 TASK-004：合同质保期到期提醒任务自动生成

**User Story**：
作为客服人员，系统应在合同质保期到期前30天自动生成提醒任务，以便我提前联系客户确认是否需要延保服务。

**Acceptance Criteria**：

```gherkin
Scenario: 质保期到期前30天自动生成提醒任务
  Given 系统定时任务在每日凌晨2点执行
  And 当前日期为2025-12-23
  And 存在合同CONTRACT-001：
    | contract_id       | 2001        |
    | warranty_end_date | 2026-01-22  |
    | status            | executing   |
    | owner_id          | 123         |
  When 定时任务扫描contract表
  Then 系统应自动生成一条待办任务：
    | task_type        | contract_warranty_expiring                                   |
    | task_title       | 合同【CONTRACT-001】质保期即将到期                            |
    | task_description | 合同【XX酒店智能硬件采购合同】质保期将于2026-01-22到期，请联系客户确认是否需要延保服务 |
    | due_date         | 2025-12-23（提前30天）                                        |
    | priority         | medium                                                       |
    | unique_key       | contract_2001_warranty_expiring_2026-01-22                  |

Scenario: 质保期未填写时不生成任务
  Given 存在合同CONTRACT-002：
    | warranty_end_date | NULL（未填写） |
  When 定时任务扫描contract表
  Then 系统不应为CONTRACT-002生成质保到期提醒任务
```

**优先级**：P1（中）
**依赖**：CONTRACT-001（合同管理）
**关联模块**：合同管理、客户管理

---

#### 需求 TASK-005：手动创建自定义任务

**User Story**：
作为系统用户，我希望能够手动创建自定义任务（不关联特定业务对象或关联任意客户/报价单/合同），以便管理一些临时性或特殊性的待办事项。

**Acceptance Criteria**：

```gherkin
Scenario: 创建不关联业务对象的纯自定义任务
  Given 我是系统用户
  When 我在待办任务页面点击"新建任务"
  And 填写任务信息：
    | 字段             | 值                              |
    | task_title      | 准备销售会议材料                 |
    | task_description | 准备下周一销售会议的PPT和产品资料 |
    | assignee_id     | 123（选择负责人）                |
    | due_date        | 2025-12-30                      |
    | priority        | high                            |
    | source_type     | NULL（不关联）                   |
    | source_id       | NULL                            |
  And 点击"保存"
  Then 系统应成功创建任务
  And task_type应为custom
  And status应为pending
  And unique_key应为NULL（自定义任务不参与防重）

Scenario: 创建关联特定客户的自定义任务
  Given 我是销售人员
  When 我在客户详情页（customer_id=123）点击"新建任务"
  And 填写任务信息：
    | task_title  | 邀请客户参加产品发布会 |
    | due_date    | 2026-01-10            |
    | source_type | customer              |
    | source_id   | 123                   |
  And 点击"保存"
  Then 系统应成功创建任务
  And 任务应关联客户"XX酒店"
  And 点击任务标题可跳转至客户详情页

Scenario: 手动创建任务时截止日期不能早于当前日期
  Given 当前日期为2025-12-23
  When 我创建任务，设置due_date为2025-12-20（过去日期）
  And 点击"保存"
  Then 系统应提示错误："截止日期不能早于当前日期"
  And 任务创建失败
```

**优先级**：P1（中）
**依赖**：无
**关联模块**：客户管理、报价单管理、合同管理

---

#### 需求 TASK-006：任务查看、筛选与处理

**User Story**：
作为系统用户，我希望能够查看我的待办任务列表，按状态/优先级/截止时间筛选，并处理任务（开始处理、完成、取消），以便高效管理我的工作事项。

**Acceptance Criteria**：

```gherkin
Scenario: 查看我的待办任务列表
  Given 我是用户（user_id=123）
  And 系统存在以下任务：
    | task_id | assignee_id | status      | priority | due_date   | task_title             |
    | 1       | 123         | pending     | high     | 2025-12-23 | 合同交付已逾期          |
    | 2       | 123         | in_progress | medium   | 2025-12-25 | 跟进客户XX酒店          |
    | 3       | 123         | completed   | low      | 2025-12-22 | 报价单审核              |
    | 4       | 456         | pending     | high     | 2025-12-23 | 其他人的任务            |
  When 我进入"我的待办任务"页面
  Then 系统应显示我的任务列表（task_id=1,2,3）
  And 默认按优先级（high > medium > low）和截止时间（近到远）排序
  And 逾期任务应红色高亮显示
  And 页面顶部应显示待办任务计数徽章："待处理任务：1，逾期任务：1"

Scenario: 按状态筛选任务
  Given 我进入"我的待办任务"页面
  When 我勾选筛选条件：status = pending
  Then 系统应仅显示status=pending的任务

Scenario: 按优先级筛选任务
  Given 我进入"我的待办任务"页面
  When 我勾选筛选条件：priority = high
  Then 系统应仅显示priority=high的任务

Scenario: 按截止日期范围筛选任务
  Given 我进入"我的待办任务"页面
  When 我选择截止日期范围：2025-12-23 至 2025-12-31
  Then 系统应仅显示due_date在此范围内的任务

Scenario: 开始处理任务
  Given 我的待办任务列表中存在任务"跟进客户XX酒店"（task_id=2，status=pending）
  When 我点击任务行的"开始处理"按钮
  Then 系统应更新任务状态为in_progress
  And started_at应记录当前时间
  And 任务状态标签显示"处理中"

Scenario: 完成任务
  Given 我的待办任务列表中存在任务"跟进客户XX酒店"（task_id=2，status=in_progress）
  When 我点击任务行的"完成"按钮
  And 填写任务处理结果备注："已电话联系客户，客户确认下周签合同"
  And 点击"确定"
  Then 系统应更新任务状态为completed
  And completed_at应记录当前时间
  And result_note应保存备注内容
  And 任务从待办任务列表移至"已完成"列表

Scenario: 取消任务
  Given 我的待办任务列表中存在任务"报价单即将过期"（task_id=3，status=pending）
  When 我点击任务行的"取消"按钮
  And 填写取消原因："客户已明确拒绝此报价"
  And 点击"确定"
  Then 系统应更新任务状态为cancelled
  And cancelled_at应记录当前时间
  And cancel_reason应保存取消原因
  And 任务从待办任务列表移除

Scenario: 已完成/已取消的任务不允许再次修改状态
  Given 存在任务"报价单审核"（task_id=4，status=completed）
  When 我尝试再次修改任务状态
  Then 系统应提示："任务已完成，无法再次修改"
  And 所有状态操作按钮应不可用
```

**优先级**：P0（高）
**依赖**：TASK-001至TASK-005
**关联模块**：无

---

#### 需求 TASK-007：任务逾期自动标记与预警

**User Story**：
作为系统管理员，系统应每日自动检查任务截止时间，将逾期未完成的任务自动标记为"已逾期"状态，并优先级提升为高，以便用户优先处理逾期任务。

**Acceptance Criteria**：

```gherkin
Scenario: 定时任务自动标记逾期任务
  Given 系统定时任务在每日凌晨2点执行
  And 当前日期为2025-12-24
  And 系统存在以下任务：
    | task_id | status      | due_date   | priority |
    | 1       | pending     | 2025-12-23 | medium   |
    | 2       | in_progress | 2025-12-22 | low      |
    | 3       | pending     | 2025-12-25 | high     |
    | 4       | completed   | 2025-12-20 | medium   |
  When 定时任务扫描task表
  Then 系统应自动更新task_id=1和2的状态为overdue
  And task_id=1和2的priority应自动提升为high
  And task_id=3不应被标记为逾期（截止日期未到）
  And task_id=4不应被标记为逾期（已完成）

Scenario: 逾期任务在待办列表中突出显示
  Given 我的待办任务列表中存在逾期任务：
    | task_id | status  | due_date   | task_title       |
    | 1       | overdue | 2025-12-23 | 合同交付已逾期    |
  When 我进入"我的待办任务"页面
  Then 逾期任务应在列表顶部显示
  And 任务行背景色为红色或带有"逾期"标签
  And 优先级显示为"高"

Scenario: 逾期任务完成后状态正常更新
  Given 存在逾期任务（task_id=1，status=overdue）
  When 我完成该任务
  Then 系统应更新status为completed
  And completed_at应记录当前时间
```

**优先级**：P0（高）
**依赖**：TASK-001至TASK-006
**关联模块**：定时任务调度

---

#### 需求 TASK-008：任务统计与分析

**User Story**：
作为管理员，我希望能够查看待办任务的统计数据（完成率、逾期率、平均响应时间），了解团队的任务执行情况，以便优化流程和提升效率。

**Acceptance Criteria**：

```gherkin
Scenario: 查看任务统计报表（全员）
  Given 我是管理员
  And 系统存在以下任务（所有用户）：
    | task_id | status      | created_at          | completed_at        | assignee_id |
    | 1       | completed   | 2025-12-20 10:00   | 2025-12-21 14:00   | 123         |
    | 2       | completed   | 2025-12-21 09:00   | 2025-12-22 11:00   | 123         |
    | 3       | pending     | 2025-12-22 08:00   | NULL               | 456         |
    | 4       | overdue     | 2025-12-19 10:00   | NULL               | 456         |
    | 5       | cancelled   | 2025-12-18 12:00   | NULL               | 789         |
  When 我进入"任务统计"页面
  And 选择时间范围：2025-12-18 至 2025-12-23
  Then 系统应显示以下统计数据：
    | 指标             | 值                                      |
    | 总任务数         | 5                                       |
    | 已完成任务数     | 2                                       |
    | 待处理任务数     | 1                                       |
    | 逾期任务数       | 1                                       |
    | 已取消任务数     | 1                                       |
    | 任务完成率       | 40%（2/5）                              |
    | 逾期任务占比     | 20%（1/5）                              |
    | 平均响应时间     | 1.4天（task_id=1响应1.17天，task_id=2响应1.08天，平均1.125天） |

Scenario: 按用户筛选任务统计
  Given 我是管理员
  When 我在"任务统计"页面选择用户：user_id=123
  Then 系统应仅统计该用户的任务数据

Scenario: 按任务类型统计
  Given 系统存在以下任务：
    | task_type             | status    |
    | lead_follow_up       | completed |
    | lead_follow_up       | pending   |
    | quotation_expiring   | completed |
    | contract_delivery_overdue | overdue |
  When 我在"任务统计"页面按任务类型分组查看
  Then 系统应显示：
    | 任务类型                  | 总数 | 已完成 | 逾期 |
    | lead_follow_up           | 2    | 1      | 0    |
    | quotation_expiring       | 1    | 1      | 0    |
    | contract_delivery_overdue| 1    | 0      | 1    |

Scenario: 导出任务统计报表
  Given 我在"任务统计"页面
  When 我点击"导出Excel"按钮
  Then 系统应生成Excel文件
  And 文件应包含所有统计数据和明细列表
  And 文件名格式为：任务统计报表_20251223.xlsx
```

**优先级**：P1（中）
**依赖**：TASK-001至TASK-007
**关联模块**：数据分析、报表导出

---

### 8.8 发货管理需求

#### 需求 SHIP-001：创建发货单

**User Story**：
作为运营人员，我想基于已签订的合同创建发货单，以便记录发货信息和安排物流。

**Acceptance Criteria**：
```gherkin
Scenario: 正常创建发货单
  Given 合同CONTRACT-001状态为signed，合同总金额100000元
  And 合同包含产品A（数量10台，单价8000元），产品B（数量5台，单价4000元）
  And 产品A已发货2台，剩余8台待发货
  And 产品B未发货，剩余5台待发货
  When 我创建发货单，选择产品A发货3台，产品B发货2台
  Then 系统应自动生成发货单编号（格式：SHIP-YYYYMMDD-流水号，如：SHIP-20251223-001）
  And 发货单状态为draft（草稿）
  And 发货单金额自动计算为32000元（= 8000×3 + 4000×2）
  And 发货单明细应显示：
    | 产品   | 合同数量 | 已发货数量 | 本次发货数量 | 剩余数量 | 单价  | 小计  |
    | 产品A | 10台     | 2台        | 3台          | 5台      | 8000  | 24000 |
    | 产品B | 5台      | 0台        | 2台          | 3台      | 4000  | 8000  |

Scenario: 仅允许签订或执行中的合同创建发货单
  Given 合同CONTRACT-002状态为draft（草稿）
  When 我尝试为该合同创建发货单
  Then 系统应拒绝并提示："仅状态为已签订或执行中的合同可创建发货单"

Scenario: 发货单明细不能为空
  Given 合同CONTRACT-001状态为signed
  When 我创建发货单但未选择任何产品
  And 我尝试保存
  Then 系统应拒绝并提示："发货单明细不能为空，请至少选择1个产品"
```

**优先级**：P0（高）
**依赖**：CONTRACT-001（合同创建）
**关联模块**：合同管理、产品管理

---

#### 需求 SHIP-002：发货数量超量校验

**User Story**：
作为运营人员，我希望系统阻止发货数量超过合同剩余数量，以避免错发。

**Acceptance Criteria**：
```gherkin
Scenario: 发货数量超过剩余待发货数量
  Given 合同CONTRACT-001包含产品A（合同数量10台，已发货8台，剩余2台）
  When 我创建发货单并尝试发货产品A数量为3台
  Then 系统应拒绝保存并提示："产品A发货数量（3台）超过剩余待发货数量（2台），请检查"
  And 发货单未创建

Scenario: 发货数量为0或负数
  Given 合同CONTRACT-001包含产品A（剩余待发货10台）
  When 我创建发货单并尝试发货产品A数量为0台
  Then 系统应拒绝保存并提示："发货数量必须大于0"

Scenario: 发货数量正常（未超量）
  Given 合同CONTRACT-001包含产品A（合同数量10台，已发货8台，剩余2台）
  When 我创建发货单并发货产品A数量为2台（恰好等于剩余数量）
  Then 系统应允许保存
  And 发货单创建成功
```

**优先级**：P0（高）
**依赖**：SHIP-001
**关联模块**：合同管理

---

#### 需求 SHIP-003：发货单发货确认

**User Story**：
作为运营人员，我想将发货单状态从草稿变为已发货，并填写物流信息，以便通知客户货物已发出。

**Acceptance Criteria**：
```gherkin
Scenario: 正常发货确认
  Given 发货单SHIP-001状态为draft
  And 包含产品A（3台）和产品B（2台），发货金额32000元
  And 关联合同CONTRACT-001
  When 我确认发货并填写：
    | 字段               | 值               |
    | 物流公司           | 德邦物流         |
    | 运单号             | DBL20251223001   |
    | 实际发货日期       | 2025-12-23       |
    | 预计到货日期       | 2025-12-26       |
  And 我将发货单状态改为shipped
  Then 发货单状态变为shipped（已发货）
  And 系统自动更新关联合同CONTRACT-001：
    | 字段               | 更新前 | 更新后 |
    | 产品A已发货数量    | 2台    | 5台    |
    | 产品B已发货数量    | 0台    | 2台    |
    | 合同已发货金额     | 0元    | 32000元|
  And 合同状态自动从signed变为executing（首次发货触发）

Scenario: 发货确认时物流信息必填
  Given 发货单SHIP-001状态为draft
  When 我尝试将状态改为shipped
  But 未填写物流公司或运单号
  Then 系统应拒绝并提示："发货确认时，物流公司和运单号为必填项"

Scenario: 预计到货日期默认规则
  Given 发货单SHIP-001状态为draft
  When 我确认发货，填写实际发货日期为2025-12-23
  And 未填写预计到货日期
  Then 系统应自动设置预计到货日期为2025-12-26（实际发货日期 + 3天）
```

**优先级**：P0（高）
**依赖**：SHIP-001
**关联模块**：合同管理

---

#### 需求 SHIP-004：全部发货完成自动更新合同交付日期

**User Story**：
作为系统，当合同的所有产品全部发货完成时，我希望自动更新合同的实际交付日期，以便触发质保期开始。

**Acceptance Criteria**：
```gherkin
Scenario: 最后一批发货完成，自动更新合同交付日期
  Given 合同CONTRACT-001包含产品A（合同数量10台）和产品B（合同数量5台）
  And 产品A已发货10台（全部完成），产品B已发货3台（剩余2台）
  And 合同actual_delivery_date为空
  When 我创建发货单SHIP-002，发货产品B剩余2台
  And 确认发货（状态变为shipped），实际发货日期为2025-12-25
  Then 系统检测到所有产品全部发货完成（产品A：10/10，产品B：5/5）
  And 系统自动更新合同CONTRACT-001.actual_delivery_date = 2025-12-25
  And 系统自动计算质保期：
    | 字段                | 值                                |
    | warranty_start_date | 2025-12-25                        |
    | warranty_end_date   | 2026-12-25（假设质保期12个月）    |

Scenario: 部分发货未完成，不更新合同交付日期
  Given 合同CONTRACT-001包含产品A（合同数量10台）和产品B（合同数量5台）
  And 产品A已发货8台（剩余2台），产品B已发货0台（剩余5台）
  When 我创建发货单SHIP-001，发货产品A 2台
  And 确认发货（状态变为shipped）
  Then 系统检测到产品A全部发货完成，但产品B未发货
  And 合同CONTRACT-001.actual_delivery_date保持为空（不更新）
```

**优先级**：P0（高）
**依赖**：SHIP-003
**关联模块**：合同管理

---

#### 需求 SHIP-005：发货单取消与回退

**User Story**：
作为运营人员，我想取消错误创建的发货单，并回退合同的发货数量统计，以确保数据准确。

**Acceptance Criteria**：
```gherkin
Scenario: 取消已发货的发货单，回退合同统计
  Given 发货单SHIP-001状态为shipped
  And 包含产品A（3台），发货金额24000元
  And 合同CONTRACT-001的产品A已发货数量为5台，合同已发货金额为32000元
  When 我将发货单SHIP-001状态改为cancelled
  And 填写取消原因："客户临时要求推迟发货"
  Then 发货单状态变为cancelled
  And 系统自动回退合同CONTRACT-001的发货统计：
    | 字段               | 回退前  | 回退后  |
    | 产品A已发货数量    | 5台     | 2台     |
    | 合同已发货金额     | 32000元 | 8000元  |
  And 发货单不允许再次修改状态（终态）

Scenario: 取消草稿状态的发货单，无需回退
  Given 发货单SHIP-002状态为draft
  When 我将发货单SHIP-002状态改为cancelled
  And 填写取消原因："创建错误"
  Then 发货单状态变为cancelled
  And 合同的发货统计不受影响（因为草稿未更新合同数据）

Scenario: 取消发货单时必填取消原因
  Given 发货单SHIP-001状态为shipped
  When 我尝试将状态改为cancelled
  But 未填写取消原因
  Then 系统应拒绝并提示："取消发货单时，取消原因为必填项"
```

**优先级**：P0（高）
**依赖**：SHIP-003
**关联模块**：合同管理

---

#### 需求 SHIP-006：发货单物流信息更新

**User Story**：
作为运营人员，我想修改已发货发货单的物流信息，以应对物流公司更换或运单号错误的情况。

**Acceptance Criteria**：
```gherkin
Scenario: 修改已发货发货单的物流信息
  Given 发货单SHIP-001状态为shipped
  And 物流公司为"德邦物流"，运单号为"DBL20251223001"
  When 我修改发货单SHIP-001的物流信息：
    | 字段         | 新值             |
    | 物流公司     | 顺丰速运         |
    | 运单号       | SF20251223999    |
  Then 系统允许修改并保存
  And 发货单SHIP-001的物流信息更新为新值
  And 操作日志记录："用户XXX修改了发货单SHIP-001的物流信息"

Scenario: 不允许修改发货数量（已发货后）
  Given 发货单SHIP-001状态为shipped
  And 包含产品A（本次发货3台）
  When 我尝试修改产品A的发货数量为5台
  Then 系统应拒绝并提示："发货单状态为已发货后，不允许修改发货数量，如需调整请取消发货单重新创建"
```

**优先级**：P1（中）
**依赖**：SHIP-003
**关联模块**：操作审计

---

#### 需求 SHIP-007：发货单状态跟踪（签收确认）

**User Story**：
作为运营人员，我想将发货单状态更新为已签收，并记录实际签收日期，以便完成交付流程。

**Acceptance Criteria**：
```gherkin
Scenario: 签收确认
  Given 发货单SHIP-001状态为shipped
  And 实际发货日期为2025-12-23，预计到货日期为2025-12-26
  When 我确认客户已签收
  And 填写实际签收日期为2025-12-25
  And 将状态改为delivered
  Then 发货单状态变为delivered（已签收）
  And 发货单的actual_delivery_date记录为2025-12-25
  And 系统生成操作日志："用户XXX确认发货单SHIP-001已签收"

Scenario: 签收日期必须晚于或等于发货日期
  Given 发货单SHIP-001状态为shipped
  And 实际发货日期为2025-12-23
  When 我尝试填写实际签收日期为2025-12-20（早于发货日期）
  Then 系统应拒绝并提示："签收日期不能早于发货日期"
```

**优先级**：P1（中）
**依赖**：SHIP-003
**关联模块**：操作审计

---

#### 需求 SHIP-008：发货逾期待办任务自动生成

**User Story**：
作为系统，我希望在发货单计划发货日期逾期时自动生成待办任务，提醒运营人员尽快发货。

**Acceptance Criteria**：
```gherkin
Scenario: 发货逾期自动生成待办任务
  Given 发货单SHIP-001状态为pending（待发货）
  And 计划发货日期为2025-12-20
  And 负责人为运营人员张三（user_id=123）
  And 当前日期为2025-12-23
  When 定时任务执行发货逾期检查
  Then 系统自动生成待办任务：
    | 字段           | 值                                                                         |
    | 任务类型       | shipment_overdue                                                           |
    | 任务标题       | 发货单SHIP-001发货已逾期                                                    |
    | 任务描述       | 发货单SHIP-001计划发货日期为2025-12-20，当前已逾期3天，请尽快安排发货       |
    | 优先级         | high                                                                       |
    | 负责人         | 张三（user_id=123）                                                        |
    | 截止日期       | 2025-12-20                                                                 |
    | 状态           | overdue                                                                    |
  And 任务的unique_key为："shipment_SHIP-001_overdue_20251220"（防重）

Scenario: 草稿状态也触发逾期提醒
  Given 发货单SHIP-002状态为draft（草稿）
  And 计划发货日期为2025-12-20
  And 当前日期为2025-12-23
  When 定时任务执行发货逾期检查
  Then 系统自动生成待办任务（与pending状态逾期任务相同）

Scenario: 已发货或已取消的发货单不生成逾期任务
  Given 发货单SHIP-003状态为shipped（已发货）
  And 计划发货日期为2025-12-20
  And 当前日期为2025-12-23
  When 定时任务执行发货逾期检查
  Then 系统不生成逾期任务（已发货无需提醒）

Scenario: 防重机制生效
  Given 发货单SHIP-001已生成逾期任务（unique_key="shipment_SHIP-001_overdue_20251220"）
  When 定时任务再次执行发货逾期检查
  Then 系统检测到unique_key已存在，跳过生成（防止重复提醒）
```

**优先级**：P1（中）
**依赖**：TASK-001（任务自动生成）
**关联模块**：待办任务系统

---

### 8.9 收款管理需求

#### 需求 PAY-001：创建收款记录

**User Story**：
作为财务人员或销售人员，我想基于已签订的合同创建收款记录，以便记录客户付款信息和更新收款进度。

**Acceptance Criteria**：
```gherkin
Scenario: 正常创建收款记录
  Given 合同CONTRACT-001状态为signed，合同总金额100000元
  And 合同付款条款为：
    | 阶段     | 比例 | 金额  | 应付日期   |
    | 签订后   | 30%  | 30000 | 2025-12-25 |
    | 发货前   | 70%  | 70000 | 2026-01-15 |
  And 当前日期为2025-12-23
  When 我创建收款记录：
    | 字段             | 值             |
    | 收款阶段         | 签订后         |
    | 收款金额         | 30000          |
    | 收款日期         | 2025-12-23     |
    | 收款方式         | bank_transfer  |
    | 收款银行账户     | 工商银行-账户A |
    | 银行流水号       | TXN20251223001 |
  Then 系统应自动生成收款编号（格式：PAY-YYYYMMDD-流水号，如：PAY-20251223-001）
  And 收款记录状态为draft（草稿）
  And 应收金额（expected_amount）自动填充为30000元（从付款条款读取）
  And 该期已收款总额（stage_paid_amount）为0元（尚未确认）
  And 该期剩余应收金额（stage_balance_amount）为30000元
  And 负责人（owner_id）自动继承合同负责人

Scenario: 仅允许已签订或执行中的合同创建收款记录
  Given 合同CONTRACT-002状态为draft（草稿）
  When 我尝试为该合同创建收款记录
  Then 系统应拒绝并提示："仅状态为已签订、执行中或已完成的合同可创建收款记录"

Scenario: 收款阶段必须与付款条款一致
  Given 合同CONTRACT-001付款条款包含阶段："签订后"、"发货前"
  When 我尝试创建收款记录，收款阶段为"验收后"（不在付款条款中）
  Then 系统应拒绝并提示："收款阶段【验收后】不在合同付款条款中，请检查"

Scenario: 收款日期不能早于合同签订日期
  Given 合同CONTRACT-001签订日期为2025-12-20
  When 我尝试创建收款记录，收款日期为2025-12-19
  Then 系统应拒绝并提示："收款日期不能早于合同签订日期（2025-12-20）"

Scenario: 银行转账方式必须填写银行信息
  Given 我创建收款记录，收款方式为bank_transfer
  When 我未填写收款银行账户或银行流水号
  Then 系统应提示："收款方式为银行转账时，建议填写收款银行账户和银行流水号"
  And 允许保存（警告但不阻止）
```

**优先级**：P0（高）
**依赖**：CONTRACT-001（合同创建）
**关联模块**：合同管理

---

#### 需求 PAY-002：收款确认与自动更新合同进度

**User Story**：
作为财务人员，我想将收款记录从草稿状态确认为已确认，系统自动更新合同的已收款金额，以便实时跟踪收款进度。

**Acceptance Criteria**：
```gherkin
Scenario: 正常确认收款
  Given 收款记录PAY-001状态为draft
  And 收款金额为30000元，关联合同CONTRACT-001
  And 合同CONTRACT-001当前已收款金额为0元，合同总金额100000元
  And 收款阶段为"签订后"，该期应收30000元
  When 我确认收款，将状态改为confirmed
  Then 收款记录状态变为confirmed（已确认）
  And 系统自动记录确认时间（confirm_date）和确认人（confirmed_by）
  And 系统自动更新合同CONTRACT-001：
    | 字段                 | 更新前 | 更新后 |
    | 已收款金额           | 0元    | 30000元|
    | 合同状态             | signed | executing（首次收款触发） |
  And 系统自动更新收款记录PAY-001：
    | 字段                 | 更新后 |
    | 该期已收款总额       | 30000元|
    | 该期剩余应收金额     | 0元    |
    | 该期是否已核销完成   | 1（是）|

Scenario: 部分收款场景（同一阶段分多次收款）
  Given 合同CONTRACT-001付款条款"签订后"应收30000元
  And 已确认收款记录PAY-001，收款金额10000元，该期已收款总额10000元
  When 我创建第二笔收款记录PAY-002：
    | 收款阶段 | 收款金额 |
    | 签订后   | 15000    |
  And 确认收款PAY-002
  Then 系统自动更新合同CONTRACT-001已收款金额 = 25000元（10000 + 15000）
  And 收款记录PAY-001和PAY-002的该期已收款总额都更新为25000元
  And 收款记录PAY-001和PAY-002的该期剩余应收金额都更新为5000元（30000 - 25000）
  And 收款记录PAY-001和PAY-002的该期是否已核销完成都为0（未收齐）

Scenario: 收款超额预警
  Given 合同CONTRACT-001总金额100000元，已收款90000元
  When 我创建收款记录PAY-003，收款金额为15000元
  And 尝试确认收款
  Then 系统应提示："警告：收款总额（105000元）将超过合同金额（100000元），是否确认？（可能存在补偿款或额外付款）"
  And 我确认后，允许保存并更新合同已收款金额为105000元

Scenario: 收款完成提示
  Given 合同CONTRACT-001总金额100000元，已收款99000元
  When 我确认收款记录PAY-004，收款金额1000元
  Then 系统自动更新合同已收款金额为100000元
  And 系统提示："合同【CONTRACT-001】收款已全部完成，已收款金额 = 合同金额（100000元）"
```

**优先级**：P0（高）
**依赖**：PAY-001
**关联模块**：合同管理

---

#### 需求 PAY-003：收款取消与回退

**User Story**：
作为财务人员，我想取消已确认的收款记录（如：误录入、客户退款），系统自动回退合同的已收款金额，以确保数据准确性。

**Acceptance Criteria**：
```gherkin
Scenario: 正常取消收款
  Given 收款记录PAY-001状态为confirmed
  And 收款金额为30000元，关联合同CONTRACT-001
  And 合同CONTRACT-001当前已收款金额为30000元
  And 收款阶段为"签订后"，该期已收款总额为30000元
  When 我取消收款，将状态改为cancelled
  Then 收款记录状态变为cancelled（已取消，终态）
  And 系统自动回退合同CONTRACT-001已收款金额 = 0元（30000 - 30000）
  And 系统自动更新该阶段的其他收款记录：
    | 该期已收款总额       | 0元    |
    | 该期剩余应收金额     | 30000元|
    | 该期是否已核销完成   | 0（否）|

Scenario: 部分收款场景的取消回退
  Given 合同CONTRACT-001付款条款"签订后"应收30000元
  And 已确认收款记录PAY-001（10000元）和PAY-002（15000元），该期已收款总额25000元
  When 我取消收款记录PAY-001
  Then 系统自动回退合同已收款金额 = 15000元（25000 - 10000）
  And 收款记录PAY-002的该期已收款总额更新为15000元
  And 收款记录PAY-002的该期剩余应收金额更新为15000元（30000 - 15000）

Scenario: 取消状态为终态
  Given 收款记录PAY-001状态为cancelled
  When 我尝试再次修改状态
  Then 系统应拒绝并提示："收款记录已取消，无法再修改状态"
```

**优先级**：P1（中）
**依赖**：PAY-002
**关联模块**：合同管理

---

#### 需求 PAY-004：收款方式与银行信息管理

**User Story**：
作为财务人员，我想记录多种收款方式（银行转账、支票、现金、第三方支付等）和银行信息，以便财务对账和审计追溯。

**Acceptance Criteria**：
```gherkin
Scenario: 银行转账方式
  Given 我创建收款记录，收款方式选择bank_transfer
  When 我填写：
    | 收款银行账户 | 工商银行-对公账户-尾号1234 |
    | 银行流水号   | ICBC20251223001            |
    | 付款方名称   | 北京XX酒店管理有限公司     |
  Then 系统应保存所有信息
  And 财务人员可根据银行流水号查询和核对收款记录

Scenario: 支票收款方式
  Given 我创建收款记录，收款方式选择check
  When 我填写：
    | 收款备注 | 支票号：CHK20251223，开户行：建设银行 |
  Then 系统应保存收款备注
  And 银行流水号字段可留空（支票无流水号）

Scenario: 现金收款方式
  Given 我创建收款记录，收款方式选择cash
  When 我确认收款
  Then 系统应提示："现金收款需妥善保管收据，并及时存入公司账户"
  And 允许保存

Scenario: 第三方支付方式
  Given 我创建收款记录，收款方式选择third_party
  When 我填写：
    | 银行流水号 | ALIPAY20251223001 |
    | 收款备注   | 支付宝企业账户收款 |
  Then 系统应保存所有信息

Scenario: 付款方名称不一致场景
  Given 合同客户名称为"北京XX酒店管理有限公司"
  When 我创建收款记录，付款方名称填写为"李XX（个人）"
  Then 系统应提示："付款方名称与合同客户名称不一致，请确认是否正确"
  And 允许保存（警告但不阻止）
```

**优先级**：P1（中）
**依赖**：PAY-001
**关联模块**：无

---

#### 需求 PAY-005：分期收款跟踪与进度查询

**User Story**：
作为财务人员或销售人员，我想查看合同各付款阶段的收款进度，了解已收款、未收款和逾期情况，以便跟进催款。

**Acceptance Criteria**：
```gherkin
Scenario: 查询合同收款进度
  Given 合同CONTRACT-001总金额100000元，付款条款为：
    | 阶段     | 应收金额 | 应付日期   |
    | 签订后   | 30000    | 2025-12-25 |
    | 发货前   | 70000    | 2026-01-15 |
  And 已确认收款记录：
    | 收款阶段 | 收款金额 |
    | 签订后   | 30000    |
    | 发货前   | 40000    |
  And 当前日期为2025-12-30
  When 我查询合同CONTRACT-001的收款进度
  Then 系统应显示：
    | 阶段   | 应收金额 | 已收款 | 剩余应收 | 是否收齐 | 应付日期   | 是否逾期 |
    | 签订后 | 30000    | 30000  | 0        | 是       | 2025-12-25 | 否       |
    | 发货前 | 70000    | 40000  | 30000    | 否       | 2026-01-15 | 否       |
  And 合同总体收款进度：已收款70000元 / 合同金额100000元 = 70%

Scenario: 应收账款逾期统计
  Given 合同CONTRACT-001付款条款"签订后"应付日期为2025-12-20，应收30000元
  And 该期已收款20000元，剩余应收10000元
  And 当前日期为2025-12-25
  When 我查询应收账款逾期报表
  Then 系统应显示：
    | 合同编号      | 客户名称 | 收款阶段 | 应收金额 | 已收款 | 剩余应收 | 应付日期   | 逾期天数 |
    | CONTRACT-001  | XX酒店   | 签订后   | 30000    | 20000  | 10000    | 2025-12-20 | 5天      |

Scenario: 收款进度为0的阶段
  Given 合同CONTRACT-001付款条款"发货前"应收70000元
  And 该期尚未收到任何款项
  When 我查询收款进度
  Then 系统应显示：
    | 阶段   | 应收金额 | 已收款 | 剩余应收 | 是否收齐 |
    | 发货前 | 70000    | 0      | 70000    | 否       |
```

**优先级**：P0（高）
**依赖**：PAY-002
**关联模块**：合同管理

---

#### 需求 PAY-006：应收账款统计与分析

**User Story**：
作为财务管理员或销售管理员，我想查看全局应收账款统计（未收款金额、逾期应收款、收款率等），以便掌握公司整体财务状况。

**Acceptance Criteria**：
```gherkin
Scenario: 应收账款总览统计
  Given 系统中有以下合同和收款记录：
    | 合同编号      | 合同金额 | 已收款 | 未收款 |
    | CONTRACT-001  | 100000   | 70000  | 30000  |
    | CONTRACT-002  | 50000    | 50000  | 0      |
    | CONTRACT-003  | 80000    | 20000  | 60000  |
  When 我查询应收账款总览
  Then 系统应显示：
    | 统计指标         | 金额     |
    | 合同总金额       | 230000元 |
    | 已收款总额       | 140000元 |
    | 未收款总额       | 90000元  |
    | 收款率           | 60.87%   |

Scenario: 逾期应收款统计
  Given 系统中有以下逾期应收款：
    | 合同编号      | 收款阶段 | 剩余应收 | 逾期天数 |
    | CONTRACT-001  | 签订后   | 10000    | 5天      |
    | CONTRACT-003  | 发货前   | 60000    | 15天     |
  When 我查询逾期应收款统计
  Then 系统应显示：
    | 统计指标         | 金额/数量 |
    | 逾期应收款总额   | 70000元   |
    | 逾期合同数量     | 2个       |
    | 平均逾期天数     | 10天      |
  And 按逾期天数降序、剩余应收金额降序排列详细列表

Scenario: 按客户统计应收账款
  Given 客户"XX酒店"有2个合同，总应收款90000元，已收款40000元
  And 客户"YY酒店"有1个合同，总应收款50000元，已收款50000元
  When 我查询按客户分组的应收账款
  Then 系统应显示：
    | 客户名称 | 合同数量 | 合同总金额 | 已收款 | 未收款 | 收款率 |
    | XX酒店   | 2        | 90000      | 40000  | 50000  | 44.44% |
    | YY酒店   | 1        | 50000      | 50000  | 0      | 100%   |
```

**优先级**：P1（中）
**依赖**：PAY-002
**关联模块**：合同管理

---

#### 需求 PAY-007：收款逾期待办任务自动生成

**User Story**：
作为系统，我希望在收款逾期时自动生成待办任务，提醒财务人员或销售人员尽快催款。

**Acceptance Criteria**：
```gherkin
Scenario: 收款到期前3天自动提醒
  Given 合同CONTRACT-001付款条款"签订后"应付日期为2025-12-25，应收30000元
  And 该期已收款0元
  And 负责人为销售人员张三（user_id=123）
  And 当前日期为2025-12-22（到期前3天）
  When 定时任务执行收款到期检查
  Then 系统自动生成待办任务：
    | 字段           | 值                                                                         |
    | 任务类型       | contract_payment_due                                                       |
    | 任务标题       | 合同CONTRACT-001付款阶段"签订后"即将到期                                    |
    | 任务描述       | 合同CONTRACT-001付款阶段"签订后"即将到期（应付日期：2025-12-25），应收30000元，已收0元，剩余30000元，请跟进收款 |
    | 优先级         | medium                                                                     |
    | 负责人         | 张三（user_id=123）                                                        |
    | 截止日期       | 2025-12-25                                                                 |
    | 状态           | pending                                                                    |
  And 任务的unique_key为："contract_CONTRACT-001_payment_due_签订后_20251225"（防重）

Scenario: 收款逾期自动预警
  Given 合同CONTRACT-001付款条款"签订后"应付日期为2025-12-20，应收30000元
  And 该期已收款20000元，剩余应收10000元
  And 负责人为销售人员张三（user_id=123）
  And 当前日期为2025-12-23
  When 定时任务执行收款逾期检查
  Then 系统自动生成待办任务：
    | 字段           | 值                                                                         |
    | 任务类型       | contract_payment_overdue                                                   |
    | 任务标题       | 合同CONTRACT-001付款阶段"签订后"已逾期                                      |
    | 任务描述       | 合同CONTRACT-001付款阶段"签订后"已逾期3天（应付日期：2025-12-20），应收30000元，已收20000元，剩余10000元，请尽快催款 |
    | 优先级         | high                                                                       |
    | 负责人         | 张三（user_id=123）                                                        |
    | 截止日期       | 2025-12-20                                                                 |
    | 状态           | overdue                                                                    |
  And 任务的unique_key为："contract_CONTRACT-001_payment_overdue_签订后_20251220"（防重）

Scenario: 该期已收齐不生成逾期任务
  Given 合同CONTRACT-001付款条款"签订后"应付日期为2025-12-20，应收30000元
  And 该期已收款30000元，剩余应收0元
  And 当前日期为2025-12-23
  When 定时任务执行收款逾期检查
  Then 系统不生成逾期任务（该期已收齐）

Scenario: 防重机制生效
  Given 合同CONTRACT-001付款阶段"签订后"已生成逾期任务（unique_key="contract_CONTRACT-001_payment_overdue_签订后_20251220"）
  When 定时任务再次执行收款逾期检查
  Then 系统检测到unique_key已存在，跳过生成（防止重复提醒）
```

**优先级**：P1（中）
**依赖**：TASK-001（任务自动生成）
**关联模块**：待办任务系统、合同管理

---

#### 需求 PAY-008：收款记录查询与导出

**User Story**：
作为财务人员，我想按合同、客户、时间、收款方式等条件筛选收款记录，并导出对账单，以便财务对账和报表分析。

**Acceptance Criteria**：
```gherkin
Scenario: 按合同查询收款记录
  Given 合同CONTRACT-001有3条收款记录（PAY-001、PAY-002、PAY-003）
  When 我查询合同CONTRACT-001的所有收款记录
  Then 系统应显示3条记录，按收款日期降序排列
  And 每条记录显示：收款编号、收款阶段、收款金额、收款日期、收款方式、状态

Scenario: 按客户查询收款记录
  Given 客户"XX酒店"有2个合同（CONTRACT-001、CONTRACT-002）
  And 两个合同共有5条收款记录
  When 我查询客户"XX酒店"的所有收款记录
  Then 系统应显示5条记录，按收款日期降序排列
  And 每条记录显示：合同编号、收款编号、收款金额、收款日期、收款方式

Scenario: 按时间范围查询收款记录
  Given 系统中有以下收款记录：
    | 收款编号 | 收款日期   | 收款金额 |
    | PAY-001  | 2025-12-20 | 30000    |
    | PAY-002  | 2025-12-23 | 40000    |
    | PAY-003  | 2025-12-26 | 20000    |
  When 我查询收款日期在2025-12-22至2025-12-25之间的记录
  Then 系统应显示1条记录（PAY-002）

Scenario: 按收款方式筛选
  Given 系统中有多种收款方式的记录
  When 我筛选收款方式为bank_transfer的记录
  Then 系统应仅显示银行转账方式的收款记录

Scenario: 导出收款对账单
  Given 我查询到合同CONTRACT-001的所有收款记录（3条）
  When 我点击"导出"按钮
  Then 系统应生成Excel文件，包含以下列：
    | 列名           | 说明                     |
    | 收款编号       | PAY-001                  |
    | 合同编号       | CONTRACT-001             |
    | 客户名称       | XX酒店                   |
    | 收款阶段       | 签订后                   |
    | 应收金额       | 30000                    |
    | 收款金额       | 30000                    |
    | 收款日期       | 2025-12-20               |
    | 收款方式       | 银行转账                 |
    | 收款银行账户   | 工商银行-账户A           |
    | 银行流水号     | TXN20251223001           |
    | 状态           | 已确认                   |
    | 确认人         | 张三                     |
    | 确认时间       | 2025-12-20 14:30:00      |
  And 文件名格式为："收款记录_CONTRACT-001_YYYYMMDD.xlsx"

Scenario: 仅显示已确认的收款记录（默认）
  Given 合同CONTRACT-001有3条收款记录：PAY-001（confirmed）、PAY-002（draft）、PAY-003（cancelled）
  When 我查询收款记录（默认仅显示已确认）
  Then 系统应仅显示1条记录（PAY-001）

Scenario: 显示所有状态的收款记录（包含草稿和已取消）
  Given 合同CONTRACT-001有3条收款记录：PAY-001（confirmed）、PAY-002（draft）、PAY-003（cancelled）
  When 我勾选"显示所有状态"
  Then 系统应显示3条记录，并标注状态
```

**优先级**：P1（中）
**依赖**：PAY-001、PAY-002
**关联模块**：合同管理、客户管理

---

### 8.10 发票管理需求

#### 需求 INV-001：创建发票记录

**User Story**：
作为财务人员，我想基于已签订的合同创建发票记录，以便记录开票信息和更新开票进度。

**Acceptance Criteria**：
```gherkin
Scenario: 正常创建发票记录（关联收款）
  Given 合同CONTRACT-001状态为signed，合同总金额100000元
  And 已有收款记录PAY-001，收款金额30000元，收款阶段为"签订后"，状态为confirmed
  And 客户开票信息为：
    | 字段         | 值                     |
    | 公司名称     | XX酒店管理有限公司     |
    | 税号         | 91110000123456789X     |
    | 地址         | 北京市朝阳区XX路XX号   |
    | 电话         | 010-12345678           |
    | 开户银行     | 中国工商银行北京分行   |
    | 银行账号     | 1234567890             |
  When 我创建发票记录：
    | 字段         | 值                         |
    | 关联收款     | PAY-001                    |
    | 发票号码     | 02345678                   |
    | 发票类型     | vat_special（增值税专用发票）|
    | 开票金额     | 30000                      |
    | 开票日期     | 2025-12-23                 |
  Then 发票记录应创建成功
  And 发票状态为draft（待开票）
  And 发票抬头信息自动填充为客户开票信息（允许修改）：
    | 字段         | 值                         |
    | 发票抬头     | XX酒店管理有限公司         |
    | 税号         | 91110000123456789X         |
    | 公司地址     | 北京市朝阳区XX路XX号       |
    | 公司电话     | 010-12345678               |
    | 开户银行     | 中国工商银行北京分行       |
    | 银行账号     | 1234567890                 |
  And 负责人（owner_id）自动继承合同负责人

Scenario: 创建发票记录（不关联收款，独立开票）
  Given 合同CONTRACT-001状态为signed，合同总金额100000元
  When 我创建发票记录，不关联收款记录（payment_id为NULL）：
    | 字段         | 值                         |
    | 发票号码     | 02345679                   |
    | 发票类型     | vat_normal（增值税普通发票）|
    | 开票金额     | 50000                      |
    | 开票日期     | 2025-12-23                 |
    | 发票抬头     | XX酒店                     |
  Then 发票记录应创建成功
  And 发票状态为draft
  And payment_id为NULL（独立开票）

Scenario: 仅允许已签订或执行中的合同创建发票记录
  Given 合同CONTRACT-002状态为draft（草稿）
  When 我尝试为该合同创建发票记录
  Then 系统应拒绝并提示："仅状态为已签订、执行中或已完成的合同可创建发票记录"

Scenario: 开票日期不能早于合同签订日期
  Given 合同CONTRACT-001签订日期为2025-12-20
  When 我尝试创建发票记录，开票日期为2025-12-19
  Then 系统应拒绝并提示："开票日期不能早于合同签订日期（2025-12-20）"

Scenario: 发票号码必须全局唯一
  Given 已存在发票记录，发票号码为02345678
  When 我尝试创建新发票记录，发票号码也为02345678
  Then 系统应拒绝并提示："发票号码【02345678】已存在，请检查"

Scenario: 增值税专用发票必填字段校验
  Given 我创建发票记录，发票类型为vat_special
  When 我未填写税号或其他必填字段（公司地址、电话、开户银行、银行账号）
  Then 系统应拒绝并提示："增值税专用发票必须填写：发票抬头、税号、公司地址、公司电话、开户银行、银行账号"

Scenario: 增值税普通发票仅要求填写发票抬头
  Given 我创建发票记录，发票类型为vat_normal
  When 我填写发票抬头，其他开票信息为空
  Then 发票记录应创建成功（增值税普通发票仅发票抬头必填）
```

**优先级**：P0（高）
**依赖**：合同管理、客户管理
**关联模块**：收款管理

---

#### 需求 INV-002：发票开具确认与自动更新合同进度

**User Story**：
作为财务人员，我想确认发票已开具，系统应自动累加更新合同的已开票金额（invoiced_amount），以便实时跟踪合同开票进度。

**Acceptance Criteria**：
```gherkin
Scenario: 确认发票开具，自动更新合同已开票金额
  Given 合同CONTRACT-001合同总金额100000元，已开票金额为0元，状态为signed
  And 发票INV-001关联该合同，发票金额30000元，状态为draft
  When 我确认发票INV-001开具（状态变为confirmed）
  Then 发票状态应变为confirmed
  And 系统应记录开具时间（confirm_date）为当前时间
  And 系统应记录开具人（confirmed_by）为当前操作用户
  And 合同CONTRACT-001的已开票金额（invoiced_amount）应自动更新为30000元
  And 合同状态应自动变为executing（首次开票触发）

Scenario: 多次开票，累加更新已开票金额
  Given 合同CONTRACT-001合同总金额100000元，已开票金额为30000元
  And 发票INV-002关联该合同，发票金额40000元，状态为draft
  When 我确认发票INV-002开具
  Then 合同CONTRACT-001的已开票金额（invoiced_amount）应更新为70000元（30000 + 40000）

Scenario: 开票超额预警（不阻止保存）
  Given 合同CONTRACT-001合同总金额100000元，已开票金额为90000元
  And 发票INV-003关联该合同，发票金额20000元，状态为draft
  When 我确认发票INV-003开具
  Then 系统应弹窗提示："警告：开票总额（110000元）将超过合同金额（100000元），是否确认？（可能存在补偿开票或额外开票）"
  And 我确认后，发票状态应变为confirmed
  And 合同已开票金额应更新为110000元（允许超额）

Scenario: 开票完成提示
  Given 合同CONTRACT-001合同总金额100000元，已开票金额为70000元
  And 发票INV-004关联该合同，发票金额30000元，状态为draft
  When 我确认发票INV-004开具
  Then 合同已开票金额应更新为100000元
  And 系统应提示："合同【CONTRACT-001】开票已全部完成，已开票金额 = 合同金额"

Scenario: 仅已确认的发票才更新合同已开票金额
  Given 合同CONTRACT-001已开票金额为30000元
  And 发票INV-005（draft状态，发票金额20000元）
  And 发票INV-006（confirmed状态，发票金额10000元）
  When 我查询合同已开票金额
  Then 合同已开票金额应为40000元（30000 + 10000，不包含draft状态的INV-005）
```

**优先级**：P0（高）
**依赖**：INV-001、合同管理
**关联模块**：合同管理

---

#### 需求 INV-003：发票作废与进度回退

**User Story**：
作为财务人员，我想作废已开具的发票（如开票错误或客户退票），系统应自动回退合同的已开票金额，以便保证数据准确性。

**Acceptance Criteria**：
```gherkin
Scenario: 作废已开具的发票，自动回退合同已开票金额
  Given 合同CONTRACT-001合同总金额100000元，已开票金额为70000元
  And 发票INV-001关联该合同，发票金额30000元，状态为confirmed
  When 我作废发票INV-001（状态变为voided），填写作废原因为"开票信息错误"
  Then 发票状态应变为voided
  And 系统应记录作废时间（void_date）为当前时间
  And 系统应记录作废人（voided_by）为当前操作用户
  And 系统应记录作废原因（void_reason）为"开票信息错误"
  And 合同CONTRACT-001的已开票金额（invoiced_amount）应自动回退为40000元（70000 - 30000）

Scenario: 作废发票时必须填写作废原因
  Given 发票INV-001状态为confirmed
  When 我尝试作废发票，未填写作废原因
  Then 系统应拒绝并提示："作废发票时必须填写作废原因"

Scenario: 已作废的发票不允许再次修改或恢复
  Given 发票INV-001状态为voided
  When 我尝试修改该发票的任何字段或恢复状态
  Then 系统应拒绝并提示："已作废的发票不允许修改或恢复，如需重新开票请创建新记录"

Scenario: 待开票状态的发票可直接删除
  Given 发票INV-002状态为draft
  When 我删除该发票
  Then 发票应删除成功（软删除，deleted_at有值）
  And 合同已开票金额不受影响（draft状态不更新合同统计）

Scenario: 已开具的发票不允许直接删除，必须先作废
  Given 发票INV-001状态为confirmed
  When 我尝试删除该发票
  Then 系统应拒绝并提示："已开具的发票不允许直接删除，请先作废后再删除"
```

**优先级**：P0（高）
**依赖**：INV-002
**关联模块**：合同管理

---

#### 需求 INV-004：发票与收款关联管理

**User Story**：
作为财务人员，我想在创建发票时可选关联收款记录，以便追溯发票对应的收款依据，同时支持独立开票（预开票或补开票）场景。

**Acceptance Criteria**：
```gherkin
Scenario: 创建发票时关联收款记录
  Given 合同CONTRACT-001有收款记录PAY-001，收款金额30000元，状态为confirmed
  When 我创建发票记录，选择关联收款记录PAY-001
  Then 发票记录应自动填充：
    | 字段         | 值           |
    | 合同ID       | CONTRACT-001 |
    | 收款记录ID   | PAY-001      |
  And 发票金额建议填充为收款金额（30000元，允许修改）

Scenario: 发票金额不超过关联收款金额（柔性校验）
  Given 收款记录PAY-001收款金额为30000元
  When 我创建发票，关联PAY-001，发票金额填写40000元
  Then 系统应提示："警告：发票金额（40000元）超过关联收款金额（30000元），请确认是否正确"
  And 允许保存（柔性校验，不强制阻止）

Scenario: 独立开票（不关联收款记录）
  Given 合同CONTRACT-001状态为signed
  When 我创建发票记录，不关联收款记录（payment_id为NULL）
  Then 发票记录应创建成功
  And payment_id为NULL
  And 备注字段可填写："预开票"或"补开票"

Scenario: 一笔收款可关联多张发票（分批开票）
  Given 收款记录PAY-001收款金额为100000元
  When 我创建发票INV-001，关联PAY-001，发票金额60000元
  And 我创建发票INV-002，关联PAY-001，发票金额40000元
  Then 两张发票应均创建成功
  And 两张发票的payment_id均为PAY-001

Scenario: 查询发票时显示关联的收款信息
  Given 发票INV-001关联收款记录PAY-001
  When 我查看发票INV-001详情
  Then 系统应显示关联的收款信息：
    | 字段         | 值           |
    | 收款编号     | PAY-001      |
    | 收款金额     | 30000        |
    | 收款日期     | 2025-12-20   |
    | 收款方式     | 银行转账     |
```

**优先级**：P1（中）
**依赖**：INV-001、收款管理
**关联模块**：收款管理

---

#### 需求 INV-005：发票状态管理

**User Story**：
作为财务人员，我想清晰管理发票状态（待开票、已开具、已作废），以便追踪发票全生命周期。

**Acceptance Criteria**：
```gherkin
Scenario: 发票状态流转：draft → confirmed
  Given 发票INV-001状态为draft
  When 我确认发票开具
  Then 发票状态应变为confirmed
  And 不允许回退为draft

Scenario: 发票状态流转：confirmed → voided
  Given 发票INV-001状态为confirmed
  When 我作废发票，填写作废原因
  Then 发票状态应变为voided
  And 状态为终态，不允许再次变更

Scenario: 已开具的发票不允许修改关键字段
  Given 发票INV-001状态为confirmed
  When 我尝试修改以下字段：
    | 字段         |
    | 合同ID       |
    | 收款记录ID   |
    | 发票号码     |
    | 发票类型     |
    | 发票金额     |
    | 开票日期     |
  Then 系统应拒绝并提示："已开具的发票不允许修改关键字段，如需调整请先作废后重新创建"

Scenario: 已开具的发票允许修改补充信息
  Given 发票INV-001状态为confirmed
  When 我修改以下字段：
    | 字段         | 新值                 |
    | 发票备注     | 客户要求加盖公章     |
    | 发票抬头     | XX酒店管理有限公司   |
    | 公司地址     | 更新后的地址         |
  Then 修改应成功（允许修改补充信息）

Scenario: 查询发票列表时按状态筛选
  Given 系统中有以下发票：
    | 发票编号 | 状态      |
    | INV-001  | draft     |
    | INV-002  | confirmed |
    | INV-003  | voided    |
  When 我筛选状态为confirmed的发票
  Then 系统应仅显示INV-002
```

**优先级**：P1（中）
**依赖**：INV-001、INV-002、INV-003
**关联模块**：无

---

#### 需求 INV-006：发票记录查询与导出

**User Story**：
作为财务人员，我想按合同、客户、时间、发票类型等条件筛选发票记录，并导出开票清单，以便财务对账和报表分析。

**Acceptance Criteria**：
```gherkin
Scenario: 按合同查询发票记录
  Given 合同CONTRACT-001有3张发票（INV-001、INV-002、INV-003）
  When 我查询合同CONTRACT-001的所有发票记录
  Then 系统应显示3张发票，按开票日期降序排列
  And 每张发票显示：发票号码、发票类型、发票金额、开票日期、状态

Scenario: 按客户查询发票记录
  Given 客户"XX酒店"有2个合同（CONTRACT-001、CONTRACT-002）
  And 两个合同共有5张发票
  When 我查询客户"XX酒店"的所有发票记录
  Then 系统应显示5张发票，按开票日期降序排列
  And 每张发票显示：合同编号、发票号码、发票金额、开票日期

Scenario: 按时间范围查询发票记录
  Given 系统中有以下发票记录：
    | 发票号码 | 开票日期   | 发票金额 |
    | INV-001  | 2025-12-20 | 30000    |
    | INV-002  | 2025-12-23 | 40000    |
    | INV-003  | 2025-12-26 | 20000    |
  When 我查询开票日期在2025-12-22至2025-12-25之间的发票
  Then 系统应显示1张发票（INV-002）

Scenario: 按发票类型筛选
  Given 系统中有增值税专用发票和普通发票
  When 我筛选发票类型为vat_special的发票
  Then 系统应仅显示增值税专用发票

Scenario: 导出发票清单
  Given 我查询到合同CONTRACT-001的所有发票记录（3张）
  When 我点击"导出"按钮
  Then 系统应生成Excel文件，包含以下列：
    | 列名         | 说明                     |
    | 发票号码     | 02345678                 |
    | 合同编号     | CONTRACT-001             |
    | 客户名称     | XX酒店                   |
    | 发票类型     | 增值税专用发票           |
    | 发票金额     | 30000                    |
    | 开票日期     | 2025-12-20               |
    | 发票抬头     | XX酒店管理有限公司       |
    | 税号         | 91110000123456789X       |
    | 状态         | 已开具                   |
    | 开具人       | 张三                     |
    | 开具时间     | 2025-12-20 14:30:00      |
  And 文件名格式为："发票记录_CONTRACT-001_YYYYMMDD.xlsx"

Scenario: 仅显示已开具的发票（默认）
  Given 合同CONTRACT-001有3张发票：INV-001（confirmed）、INV-002（draft）、INV-003（voided）
  When 我查询发票记录（默认仅显示已开具）
  Then 系统应仅显示1张发票（INV-001）

Scenario: 显示所有状态的发票（包含待开票和已作废）
  Given 合同CONTRACT-001有3张发票：INV-001（confirmed）、INV-002（draft）、INV-003（voided）
  When 我勾选"显示所有状态"
  Then 系统应显示3张发票，并标注状态
```

**优先级**：P1（中）
**依赖**：INV-001、INV-002
**关联模块**：合同管理、客户管理

---

#### 需求 INV-007：发票统计与分析

**User Story**：
作为财务人员或管理层，我想查看开票统计报表（已开票金额、未开票金额、开票进度），以便掌握公司整体开票情况。

**Acceptance Criteria**：
```gherkin
Scenario: 查询合同开票进度
  Given 合同CONTRACT-001合同总金额100000元，已开票金额70000元
  When 我查看合同开票进度
  Then 系统应显示：
    | 字段             | 值       |
    | 合同总金额       | 100000   |
    | 已开票金额       | 70000    |
    | 未开票金额       | 30000    |
    | 开票进度百分比   | 70%      |
    | 开票状态         | 进行中   |

Scenario: 开票状态判断规则
  Given 系统中有以下合同：
    | 合同编号     | 合同总金额 | 已开票金额 | 开票状态 |
    | CONTRACT-001 | 100000     | 100000     | 已完成   |
    | CONTRACT-002 | 80000      | 50000      | 进行中   |
    | CONTRACT-003 | 60000      | 0          | 未开始   |
  When 我查询开票状态
  Then 系统应按以下规则判断：
    | 条件                             | 开票状态 |
    | 已开票金额 >= 合同总金额         | 已完成   |
    | 已开票金额 > 0 且 < 合同总金额   | 进行中   |
    | 已开票金额 = 0                   | 未开始   |

Scenario: 全局开票统计（所有合同汇总）
  Given 系统中有以下合同：
    | 合同编号     | 合同总金额 | 已开票金额 |
    | CONTRACT-001 | 100000     | 70000      |
    | CONTRACT-002 | 80000      | 50000      |
    | CONTRACT-003 | 60000      | 0          |
  When 我查看全局开票统计
  Then 系统应显示：
    | 字段                 | 值       |
    | 合同总金额合计       | 240000   |
    | 已开票金额合计       | 120000   |
    | 未开票金额合计       | 120000   |
    | 开票完成率           | 50%      |

Scenario: 按时间范围统计开票金额
  Given 系统中有以下发票（状态均为confirmed）：
    | 发票号码 | 开票日期   | 发票金额 |
    | INV-001  | 2025-12-20 | 30000    |
    | INV-002  | 2025-12-23 | 40000    |
    | INV-003  | 2025-12-26 | 20000    |
  When 我查询2025年12月的开票金额
  Then 系统应显示开票总金额为90000元（30000 + 40000 + 20000）

Scenario: 按发票类型统计
  Given 系统中有以下发票（状态均为confirmed）：
    | 发票号码 | 发票类型    | 发票金额 |
    | INV-001  | vat_special | 60000    |
    | INV-002  | vat_special | 30000    |
    | INV-003  | vat_normal  | 10000    |
  When 我查询各发票类型的开票金额
  Then 系统应显示：
    | 发票类型             | 发票张数 | 开票金额 |
    | 增值税专用发票       | 2        | 90000    |
    | 增值税普通发票       | 1        | 10000    |
```

**优先级**：P2（低）
**依赖**：INV-002
**关联模块**：合同管理

---

#### 需求 INV-008：发票抬头信息管理

**User Story**：
作为财务人员，我想在创建发票时自动填充客户的开票信息（发票抬头、税号等），并允许手动修改，以便快速准确地完成开票。

**Acceptance Criteria**：
```gherkin
Scenario: 创建发票时自动填充客户开票信息
  Given 客户"XX酒店管理有限公司"的开票信息为：
    | 字段         | 值                     |
    | 公司名称     | XX酒店管理有限公司     |
    | 税号         | 91110000123456789X     |
    | 地址         | 北京市朝阳区XX路XX号   |
    | 电话         | 010-12345678           |
    | 开户银行     | 中国工商银行北京分行   |
    | 银行账号     | 1234567890             |
  And 合同CONTRACT-001的客户为"XX酒店管理有限公司"
  When 我为该合同创建发票
  Then 系统应自动填充发票抬头信息为：
    | 字段         | 值                     |
    | 发票抬头     | XX酒店管理有限公司     |
    | 税号         | 91110000123456789X     |
    | 公司地址     | 北京市朝阳区XX路XX号   |
    | 公司电话     | 010-12345678           |
    | 开户银行     | 中国工商银行北京分行   |
    | 银行账号     | 1234567890             |

Scenario: 允许手动修改发票抬头信息
  Given 系统自动填充发票抬头为"XX酒店管理有限公司"
  When 我手动修改发票抬头为"XX酒店集团有限公司"
  And 我修改税号为"91110000987654321Y"
  Then 修改应成功（允许手动修改发票抬头信息）
  And 保存后的发票抬头为"XX酒店集团有限公司"
  And 保存后的税号为"91110000987654321Y"

Scenario: 客户开票信息为空时手动填写
  Given 客户"XX民宿"未录入开票信息（税号为空）
  When 我为该客户的合同创建发票
  Then 系统应允许手动填写发票抬头信息
  And 发票抬头默认填充为客户名称（允许修改）
  And 其他字段为空，需手动填写

Scenario: 同一客户不同发票的抬头信息可不同
  Given 客户"XX酒店"已有发票INV-001，发票抬头为"XX酒店管理有限公司"
  When 我为该客户创建新发票INV-002
  And 我修改发票抬头为"XX酒店集团有限公司"
  Then 两张发票的抬头信息应独立存储：
    | 发票编号 | 发票抬头               |
    | INV-001  | XX酒店管理有限公司     |
    | INV-002  | XX酒店集团有限公司     |
```

**优先级**：P1（中）
**依赖**：INV-001、客户管理
**关联模块**：客户管理

---

### 8.11 售后服务需求

#### 需求 SVC-001：服务工单创建与基本信息管理

**User Story**：
作为客服人员或售后工程师，我希望能够创建服务工单记录客户报修请求，选择工单类型和优先级，关联合同和产品信息，以便系统化管理售后服务流程。

**Acceptance Criteria**：
```gherkin
Scenario: 客户报修时创建服务工单
  Given 我是客服人员
  When 我接到客户"XX酒店"的报修电话
  And 我点击"新建工单"
  Then 我应该能填写以下信息：
    | 字段             | 说明                                         |
    | 客户             | 从客户列表选择（必填）                       |
    | 联系人           | 从该客户的联系人列表选择（可选）             |
    | 关联合同         | 从该客户的合同列表选择（可选，用于判断质保期）|
    | 故障产品         | 从产品列表选择（可选）                       |
    | 工单类型         | repair/replacement/technical_support/inspection（必填）|
    | 优先级           | urgent/high/medium/low（必填）               |
    | 问题描述         | 文本输入（必填）                             |
    | 期望解决日期     | 日期选择（可选）                             |
    | 分配给           | 从售后工程师列表选择（可选）                 |
    | 附件             | 上传故障照片（可选）                         |
  And 我填写完成点击保存后
  Then 系统应自动生成工单编号（如：TICKET-20251223-001）
  And 工单状态默认为pending
  And 如果关联了合同，系统应自动判断是否在质保期内（is_under_warranty字段）

Scenario: 关联合同时自动判断质保期
  Given 合同CONTRACT-001的质保条款为：
    | warranty_start_date | 2024-01-01 |
    | warranty_end_date   | 2025-01-01 |
  When 我创建工单并关联合同CONTRACT-001（当前日期=2024-06-15）
  Then 系统应自动设置：
    | is_under_warranty | 1（在保）      |
    | warranty_end_date | 2025-01-01     |

Scenario: 合同已过质保期时提示
  Given 合同CONTRACT-001的质保期结束日期为2024-12-31
  When 我创建工单并关联合同CONTRACT-001（当前日期=2025-01-15）
  Then 系统应自动设置：
    | is_under_warranty | 0（不在保）    |
  And 系统应提示"该合同已超出质保期，服务可能产生费用"

Scenario: 工单创建后自动生成待办任务
  Given 我创建了一个紧急工单TICKET-001
  And 分配给售后工程师"张工"
  When 工单保存成功
  Then 系统应自动生成待办任务：
    | task_type        | service_ticket_pending     |
    | task_title       | 新工单【TICKET-001】待处理 |
    | assigned_to      | 张工                       |
    | priority         | high                       |
```

**优先级**：P0（高）
**依赖**：客户管理、合同管理、产品管理、待办任务系统
**关联模块**：客户管理、合同管理、产品管理

---

#### 需求 SVC-002：工单状态流转与处理

**User Story**：
作为售后工程师，我希望能够更新工单状态（从待处理→处理中→待验收→已解决→已关闭），记录处理过程和结果，以便清晰跟踪服务进展。

**Acceptance Criteria**：
```gherkin
Scenario: 售后工程师接单并开始处理
  Given 存在待处理工单TICKET-001：
    | status      | pending |
    | assigned_to | 张工    |
  When 售后工程师"张工"登录系统
  And 点击"开始处理"按钮
  Then 工单状态应变更为in_progress
  And 系统应记录first_response_at = 当前时间
  And 系统应自动创建操作日志：
    | log_type    | status_change                       |
    | old_status  | pending                             |
    | new_status  | in_progress                         |
    | log_content | 张工将工单状态从pending变更为in_progress |

Scenario: 售后工程师处理完成提交验收
  Given 工单TICKET-001状态为in_progress
  When 售后工程师"张工"填写问题分析和解决方案：
    | problem_analysis | 主板故障，需更换         |
    | solution         | 已更换新主板，设备恢复正常 |
  And 点击"提交验收"
  Then 工单状态应变更为pending_acceptance
  And 系统应自动创建操作日志记录状态变更

Scenario: 客户验收通过，工单解决
  Given 工单TICKET-001状态为pending_acceptance
  When 客服人员联系客户确认验收通过
  And 点击"验收通过"
  Then 工单状态应变更为resolved
  And 系统应记录resolved_at = 当前时间
  And 系统应允许客户评价

Scenario: 客户验收不通过，返工处理
  Given 工单TICKET-001状态为pending_acceptance
  When 客户反馈"设备仍有问题"
  And 客服人员点击"返工"
  Then 工单状态应变更回in_progress
  And 系统应记录操作日志"客户验收不通过，返工处理"

Scenario: 工单关闭规则
  Given 工单TICKET-001状态为resolved，resolved_at=2025-12-16
  When 客户完成评价
  And 客服人员点击"关闭工单"
  Then 工单状态应变更为closed
  And 系统应记录closed_at = 当前时间
  And 工单不允许再次修改（终态）

Scenario: 已解决工单7天内未评价自动关闭
  Given 工单TICKET-001状态为resolved，resolved_at=2025-12-16
  When 系统定时任务扫描（当前日期=2025-12-24，超过7天）
  And 客户未评价（customer_rating为NULL）
  Then 系统应自动将工单状态变更为closed
  And 系统应记录操作日志"工单超过7天未评价，系统自动关闭"
```

**优先级**：P0（高）
**依赖**：SVC-001
**关联模块**：待办任务系统

---

#### 需求 SVC-003：工单操作日志记录

**User Story**：
作为售后主管，我希望能够查看工单的完整操作日志（状态变更、分配转派、备注更新），以便追溯服务过程和问题定位。

**Acceptance Criteria**：
```gherkin
Scenario: 工单状态变更时自动记录日志
  Given 工单TICKET-001状态为pending
  When 售后工程师"张工"将状态变更为in_progress
  Then 系统应自动创建操作日志：
    | log_type    | status_change                       |
    | old_status  | pending                             |
    | new_status  | in_progress                         |
    | log_content | 张工将工单状态从pending变更为in_progress |
    | created_by  | 张工的user_id                       |
    | created_at  | 当前时间                            |

Scenario: 工单分配转派时自动记录日志
  Given 工单TICKET-001当前分配给"张工"
  When 售后主管"李经理"将工单转派给"王工"
  Then 系统应自动创建操作日志：
    | log_type          | assign                            |
    | old_assigned_to   | 张工的user_id                     |
    | new_assigned_to   | 王工的user_id                     |
    | log_content       | 李经理将工单从张工转派给王工       |

Scenario: 售后工程师添加处理备注
  Given 工单TICKET-001状态为in_progress
  When 售后工程师"张工"添加备注"已到达现场，正在检测故障"
  And 上传现场照片2张
  Then 系统应创建操作日志：
    | log_type        | comment                          |
    | log_content     | 已到达现场，正在检测故障         |
    | attachment_urls | ["photo1.jpg", "photo2.jpg"]     |

Scenario: 查看工单完整操作日志时间线
  Given 工单TICKET-001已处理完成
  When 我查看工单详情页
  Then 我应该能看到按时间倒序排列的操作日志列表：
    | 时间               | 操作人 | 操作类型 | 操作内容                         |
    | 2025-12-23 16:00  | 张工   | 状态变更 | 将工单状态从pending变更为in_progress |
    | 2025-12-23 16:30  | 张工   | 备注     | 已到达现场，正在检测故障          |
    | 2025-12-23 18:00  | 张工   | 状态变更 | 将工单状态从in_progress变更为pending_acceptance |
    | 2025-12-24 10:00  | 客服   | 状态变更 | 验收通过，将状态变更为resolved    |
    | 2025-12-24 11:00  | 客户   | 客户评价 | 客户评分：5分，反馈：服务很满意   |
```

**优先级**：P0（高）
**依赖**：SVC-001、SVC-002
**关联模块**：无

---

#### 需求 SVC-004：配件更换与费用管理

**User Story**：
作为售后工程师，我希望能够记录更换的配件清单和费用明细（服务费、配件费），以便财务核算和客户对账。

**Acceptance Criteria**：
```gherkin
Scenario: 记录配件更换清单
  Given 工单TICKET-001需要更换主板
  When 售后工程师"张工"在工单中添加更换配件：
    | part_name | part_code | quantity | cost |
    | 主板      | MB-001    | 1        | 500  |
    | 电源模块  | PS-002    | 1        | 200  |
  Then 系统应保存配件清单为JSON格式：
    ```
    [
      {"part_name":"主板","part_code":"MB-001","quantity":1,"cost":500},
      {"part_name":"电源模块","part_code":"PS-002","quantity":1,"cost":200}
    ]
    ```
  And parts_cost应自动计算为700（500+200）

Scenario: 质保期内免费服务
  Given 工单TICKET-001关联合同CONTRACT-001
  And is_under_warranty = 1（在保）
  When 售后工程师填写费用信息：
    | service_fee | 0    |
    | parts_cost  | 0    |
  Then total_cost应自动计算为0
  And payment_status应设置为waived（免费）

Scenario: 质保期外收费服务
  Given 工单TICKET-001关联合同CONTRACT-001
  And is_under_warranty = 0（不在保）
  When 售后工程师填写费用信息：
    | service_fee | 300  |
    | parts_cost  | 700  |
  Then total_cost应自动计算为1000（300+700）
  And payment_status应默认为unpaid（未支付）

Scenario: 费用支付状态更新
  Given 工单TICKET-001的total_cost为1000元，payment_status为unpaid
  When 客户支付费用后，财务人员更新payment_status为paid
  Then payment_status应变更为paid
  And 系统应记录操作日志"费用已支付：1000元"
```

**优先级**：P1（中）
**依赖**：SVC-001
**关联模块**：无

---

#### 需求 SVC-005：客户满意度评价

**User Story**：
作为客服人员，我希望能够在工单解决后收集客户满意度评分和反馈，以便评估服务质量和改进服务流程。

**Acceptance Criteria**：
```gherkin
Scenario: 工单解决后客户评价
  Given 工单TICKET-001状态为resolved
  When 客服人员联系客户收集评价
  And 客户评分为5分，反馈为"服务很满意，响应及时"
  And 客服人员在系统中记录：
    | customer_rating   | 5                         |
    | customer_feedback | 服务很满意，响应及时       |
  Then 系统应保存评价信息
  And 系统应记录rated_at = 当前时间
  And 系统应自动创建操作日志：
    | log_type    | rating                                  |
    | log_content | 客户评分：5分，反馈：服务很满意，响应及时 |

Scenario: 仅已解决或已关闭工单才允许评价
  Given 工单TICKET-001状态为in_progress
  When 我尝试提交客户评价
  Then 系统应提示"工单尚未解决，不允许评价"并阻止保存

Scenario: 评分范围校验
  Given 工单TICKET-001状态为resolved
  When 我尝试录入客户评分为0分
  Then 系统应提示"评分范围为1-5分"并阻止保存

Scenario: 查看客户满意度统计
  Given 系统中存在多个已评价工单：
    | ticket_no  | customer_rating |
    | TICKET-001 | 5               |
    | TICKET-002 | 4               |
    | TICKET-003 | 5               |
    | TICKET-004 | 3               |
  When 我查看客户满意度统计报表
  Then 我应该能看到：
    | 指标                | 值   |
    | 平均满意度评分      | 4.25 |
    | 评价工单总数        | 4    |
    | 5分工单数           | 2    |
    | 4分及以上工单占比   | 75%  |
```

**优先级**：P1（中）
**依赖**：SVC-002
**关联模块**：无

---

#### 需求 SVC-006：工单分配与转派

**User Story**：
作为售后主管，我希望能够为新工单分配处理人、将工单转派给其他售后工程师，以便合理调配售后资源。

**Acceptance Criteria**：
```gherkin
Scenario: 创建工单时分配处理人
  Given 我是客服人员
  When 我创建新工单TICKET-001
  And 选择分配给售后工程师"张工"
  Then 工单的assigned_to应设置为张工的user_id
  And 系统应自动生成待办任务分配给张工

Scenario: 创建工单时未分配处理人
  Given 我是客服人员
  When 我创建新工单TICKET-001
  And 未选择处理人（assigned_to为空）
  Then 工单的assigned_to为NULL
  And 系统应自动生成待办任务分配给售后主管

Scenario: 售后主管转派工单
  Given 工单TICKET-001当前分配给"张工"，状态为pending
  When 售后主管"李经理"将工单转派给"王工"
  Then 工单的assigned_to应变更为王工的user_id
  And 系统应自动创建操作日志：
    | log_type        | assign                      |
    | old_assigned_to | 张工的user_id               |
    | new_assigned_to | 王工的user_id               |
    | log_content     | 李经理将工单从张工转派给王工 |
  And 系统应自动生成新的待办任务分配给王工
  And 原待办任务（分配给张工的）应自动取消

Scenario: 处理中工单不允许未分配处理人
  Given 工单TICKET-001状态为pending，assigned_to为张工
  When 我尝试将状态变更为in_progress
  And assigned_to有值（张工）
  Then 状态变更应成功

Scenario: 处理中工单必须有处理人
  Given 工单TICKET-001状态为pending，assigned_to为空
  When 我尝试将状态变更为in_progress
  Then 系统应提示"必须先分配处理人才能开始处理"并阻止状态变更
```

**优先级**：P0（高）
**依赖**：SVC-001、SVC-002
**关联模块**：待办任务系统

---

#### 需求 SVC-007：工单响应与处理超时提醒

**User Story**：
作为售后主管，我希望系统能够根据工单优先级自动生成响应超时和处理超时提醒，以便及时发现逾期工单并督促处理。

**Acceptance Criteria**：
```gherkin
Scenario: 紧急工单2小时未响应提醒
  Given 系统定时任务在每小时执行
  And 存在紧急工单TICKET-001：
    | priority    | urgent              |
    | status      | pending             |
    | reported_at | 2025-12-23 10:00:00 |
    | assigned_to | 张工                |
  When 定时任务扫描（当前时间=2025-12-23 12:05:00，超过2小时）
  Then 系统应自动生成待办任务：
    | task_type        | service_ticket_response_overdue          |
    | task_title       | 紧急工单【TICKET-001】响应超时           |
    | task_description | 工单已创建2小时，仍未开始处理，请尽快响应 |
    | priority         | high                                     |
    | assigned_to      | 张工                                     |

Scenario: 高优先级工单4小时未响应提醒
  Given 存在高优先级工单TICKET-002：
    | priority    | high                |
    | status      | pending             |
    | reported_at | 2025-12-23 10:00:00 |
  When 定时任务扫描（当前时间=2025-12-23 14:05:00，超过4小时）
  Then 系统应自动生成响应超时待办任务

Scenario: 紧急工单8小时未解决逾期提醒
  Given 存在紧急工单TICKET-001：
    | priority          | urgent              |
    | status            | in_progress         |
    | first_response_at | 2025-12-23 11:00:00 |
  When 定时任务扫描（当前时间=2025-12-23 19:05:00，超过8小时）
  And 工单状态仍为in_progress（未解决）
  Then 系统应自动生成待办任务：
    | task_type        | service_ticket_resolve_overdue           |
    | task_title       | 紧急工单【TICKET-001】处理逾期           |
    | task_description | 工单已处理8小时，仍未解决，请加急处理     |
    | priority         | high                                     |

Scenario: 工单状态变为in_progress后取消响应超时提醒
  Given 存在待办任务：
    | task_type | service_ticket_response_overdue |
    | source_id | TICKET-001的ticket_id           |
    | status    | pending                         |
  When 工单TICKET-001状态变更为in_progress
  Then 系统应自动取消该待办任务（status变为cancelled）
  And cancel_reason为"工单已开始处理"

Scenario: 工单状态变为resolved后取消处理超时提醒
  Given 存在待办任务：
    | task_type | service_ticket_resolve_overdue |
    | source_id | TICKET-001的ticket_id          |
    | status    | pending                        |
  When 工单TICKET-001状态变更为resolved
  Then 系统应自动取消该待办任务
  And cancel_reason为"工单已解决"
```

**优先级**：P0（高）
**依赖**：SVC-001、SVC-002、待办任务系统
**关联模块**：待办任务系统

**响应超时规则**：
- 紧急工单（urgent）：2小时内未响应生成提醒
- 高优先级工单（high）：4小时内未响应生成提醒
- 中优先级工单（medium）：1个工作日内未响应生成提醒
- 低优先级工单（low）：2个工作日内未响应生成提醒

**处理超时规则**：
- 紧急工单（urgent）：8小时内未解决生成逾期提醒
- 高优先级工单（high）：24小时内未解决生成逾期提醒
- 中优先级工单（medium）：3个工作日内未解决生成逾期提醒
- 低优先级工单（low）：7个工作日内未解决生成逾期提醒

---

#### 需求 SVC-008：工单查询与统计分析

**User Story**：
作为售后主管，我希望能够按客户、产品、工单类型、优先级、状态、时间范围筛选工单，查看工单统计报表（工单量、响应时效、处理时效、客户满意度），以便评估售后团队绩效。

**Acceptance Criteria**：
```gherkin
Scenario: 按客户筛选工单
  Given 系统中存在多个工单
  When 我选择客户"XX酒店"进行筛选
  Then 我应该能看到该客户的所有工单列表

Scenario: 按工单类型和优先级筛选
  Given 系统中存在多个工单
  When 我选择工单类型为"repair"，优先级为"urgent"
  Then 我应该能看到所有紧急维修工单列表

Scenario: 按状态和时间范围筛选
  Given 系统中存在多个工单
  When 我选择状态为"in_progress"，创建时间为2025-12-01至2025-12-31
  Then 我应该能看到该时间范围内所有处理中的工单

Scenario: 查看工单统计报表
  Given 系统中存在2025年12月的工单数据：
    | ticket_no  | ticket_type | priority | status   | reported_at        | first_response_at  | resolved_at        | customer_rating |
    | TICKET-001 | repair      | urgent   | closed   | 2025-12-01 10:00  | 2025-12-01 11:00  | 2025-12-01 15:00  | 5               |
    | TICKET-002 | replacement | high     | closed   | 2025-12-05 09:00  | 2025-12-05 12:00  | 2025-12-06 10:00  | 4               |
    | TICKET-003 | repair      | medium   | resolved | 2025-12-10 14:00  | 2025-12-11 09:00  | 2025-12-13 16:00  | 5               |
  When 我查看2025年12月工单统计报表
  Then 我应该能看到：
    | 统计指标             | 值    |
    | 工单总数             | 3     |
    | 已关闭工单数         | 2     |
    | 平均响应时间（小时） | 3     |
    | 平均处理时间（小时） | 19    |
    | 平均客户满意度评分   | 4.67  |

Scenario: 导出工单列表
  Given 我筛选了2025年12月的工单
  When 我点击"导出"按钮
  Then 系统应导出Excel文件，包含以下字段：
    | 字段         | 说明                     |
    | 工单编号     | ticket_no                |
    | 客户名称     | customer_name            |
    | 工单类型     | ticket_type              |
    | 优先级       | priority                 |
    | 状态         | status                   |
    | 处理人       | assigned_to_name         |
    | 报修时间     | reported_at              |
    | 解决时间     | resolved_at              |
    | 是否在保     | is_under_warranty        |
    | 总费用       | total_cost               |
    | 客户评分     | customer_rating          |

Scenario: 按工单类型分组统计
  Given 系统中存在多种类型工单
  When 我查看工单类型统计
  Then 我应该能看到：
    | 工单类型           | 工单数 | 平均响应时间（小时） | 平均满意度评分 |
    | repair             | 10     | 2.5                  | 4.5            |
    | replacement        | 5      | 3.0                  | 4.8            |
    | technical_support  | 3      | 1.5                  | 4.2            |
    | inspection         | 2      | 4.0                  | 5.0            |
```

**优先级**：P1（中）
**依赖**：SVC-001至SVC-005
**关联模块**：无

---

#### 需求 SVC-009：售后回访记录集成

**User Story**：
作为客服人员，我希望工单解决后能够自动生成售后回访计划，并在客户跟进记录表中记录回访内容，以便持续跟踪客户满意度和发现潜在问题。

**Acceptance Criteria**：
```gherkin
Scenario: 工单解决后自动生成售后回访计划
  Given 工单TICKET-001状态变更为resolved，resolved_at=2025-12-23
  When 系统自动触发售后回访计划生成
  Then 系统应在customer_follow_up表创建一条记录：
    | 字段                  | 值                                      |
    | customer_id           | 工单关联的customer_id                   |
    | follow_up_type        | after_sales                             |
    | next_follow_up_time   | 2025-12-30（resolved_at + 7天）         |
    | next_follow_up_content| 工单【TICKET-001】售后回访，确认客户满意度 |

Scenario: 客服人员执行售后回访并记录
  Given 存在售后回访计划：
    | customer_id         | 1001                |
    | next_follow_up_time | 2025-12-30          |
    | next_follow_up_content | 工单【TICKET-001】售后回访 |
  When 客服人员于2025-12-30联系客户进行回访
  And 客户反馈"设备运行正常，服务满意"
  And 客服人员在系统中记录回访：
    | follow_up_type     | after_sales                      |
    | follow_up_method   | phone                            |
    | follow_up_time     | 2025-12-30 10:00                 |
    | follow_up_content  | 工单【TICKET-001】售后回访       |
    | customer_feedback  | 设备运行正常，服务满意           |
    | follow_up_result   | successful                       |
  Then 系统应保存回访记录到customer_follow_up表
  And follow_up_type应为after_sales

Scenario: 查看客户的售后回访历史
  Given 客户"XX酒店"有多条售后回访记录
  When 我查看该客户的跟进记录
  And 筛选follow_up_type=after_sales
  Then 我应该能看到所有售后回访记录列表：
    | 回访时间      | 回访方式 | 回访内容               | 客户反馈             | 回访结果   |
    | 2025-12-30   | 电话     | 工单TICKET-001售后回访 | 设备运行正常，服务满意 | successful |
    | 2025-11-15   | 微信     | 工单TICKET-002售后回访 | 无异常               | successful |
```

**优先级**：P1（中）
**依赖**：SVC-002、客户管理模块
**关联模块**：客户管理（customer_follow_up表）

**技术实现建议**：
- 复用现有customer_follow_up表，通过follow_up_type='after_sales'区分售后回访记录
- 售后回访记录不关联具体工单（避免增加字段复杂度），在next_follow_up_content中文本描述关联的工单编号
- 如需精确关联，可在v2.0扩展customer_follow_up表增加source_type和source_id字段实现多态关联

---

## 9. 非功能需求

### 9.1 性能需求
> 待确认

### 9.2 安全需求
> 待确认

### 9.3 可用性需求
> 待确认

### 9.4 兼容性需求
> 待确认

---

## 10. 用户界面需求

> 待确认界面原型、交互流程

---

## 11. 外部接口

### 11.1 第三方系统集成
> 待确认

### 11.2 API 规范
> 待确认

---

## 12. 约束条件

### 12.1 技术约束
- 部署平台：阿里云
- 用户规模：10人以内

### 12.2 业务约束
> 待确认

### 12.3 法规与合规
> 待确认

---

## 13. 质量属性

> 待确认可测试性、可维护性、可扩展性要求

---

## 14. 测试策略

> 待确认测试范围、方法、环境

---

## 15. 需求追溯矩阵（RTM）

| 需求ID | 需求描述 | 优先级 | 用例ID | 验收标准 | 测试证据 | 状态 |
|-------|---------|-------|--------|---------|---------|------|
| 待补充 | | | | | | |

---

## 16. 变更日志

详见第 0 节文档信息

---

## 17. 附加说明

### 17.1 外部依赖
> 待确认

### 17.2 演示账户/测试数据
> 待确认

### 17.3 已知限制
> 待确认

### 17.4 未来里程碑
> 待确认

---

## 附录A：开放问题清单（OQL）

见独立文档：`oql.md`

---

## 附录B：术语表补充

> 待完善

---

**文档结束**
